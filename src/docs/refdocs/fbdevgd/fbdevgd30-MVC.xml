<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="fbdevgd30-MVC">
  <title>Creating Web Applications in Entity Framework with MVC</title>
  <para>This chapter will describe how to create web applications with Firebird as the 
  back-end, using Microsoft&#8482; Entity Framework&#8482; and the Visual Studio 2015 
  environment.</para>
  <para>We examine the specifics of creating a web application with this framework.  
  The basic principles for working with Entity Framework and Firebird are described 
  in the previous chapter, <link linkend="fbdevgd30-efw">Creating Applications with 
  Microsoft Entity Framework</link>.</para>
  <section id="fbdevgd30-dot-net">
    <title>The .NET Frameworks</title>
    <para>The .NET platform offers two main frameworks for creating web applications
    developed as <quote>active server pages</quote> (ASP): ASP.NET Web Forms and ASP.NET
    MVC. As I prefer using the MVC pattern, it is this technology that we will be
    examining.</para>
  </section>  

  <section id="fbdevgd30-dot-net-mvc">
    <title>The ASP.NET MVC Platform</title>
    <para>The ASP.NET MVC platform is a framework for creating websites and web applications 
    on the model-view-controller (MVC) pattern. The concept underlying the MVC pattern breaks 
    down an application into three parts:
      <variablelist>
        <varlistentry>
          <term>Controller</term>
          <listitem>
            <para>Controllers work with the model and provide interaction with the user.
            They also provide view options for displaying the user interface. In an MVC
            application, views only display data while the controller handles the input and
            responds to user activities.</para>
            <para>As an example, the controller can process string values in a query and
            send them to the model, which can use these values to send a query to the
            database.</para>
            </listitem>
        </varlistentry>
        <varlistentry>
          <term>View</term>
          <listitem>
            <para>the visual part of application's user interface. The user interface is 
            usually created to reflect the data from the model.</para>
           </listitem>
        </varlistentry>
        <varlistentry>
          <term>Model</term>
          <listitem>
            <para>Model objects are the parts of the application that implement the 
            logic for working with the application data. Model objects typically receive 
            the status of the model and save it in the database.</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </para>
    
    <section id="fbdevgd30-mvc-interactions">
      <title>Model-View-Controller Interaction</title>
      <para>Interaction between these components is illustrated in the following 
      general diagram:
        <figure id="mvc-diagram">
          <title>Interaction between M-V-C parts</title>
          <mediaobject>
            <imageobject>
            <!-- actual image size is 1737px X 791px -->
              <imagedata fileref="images/fbdevgd30_mvc_001_en.png" format="PNG"
              width="504px" depth="224px"
              scalefit="1" align="center" />  <!-- 29% -->
            </imageobject>
          </mediaobject>
        </figure>
      </para> <!-- 10th next -->
      <para>The MVC pattern supports the creation of applications whose logical 
      aspects&#x2014;input, business and interface&#x2014;are separated but interact closely
      with one another. The diagram illustrates the location of each logic type in 
      the application:
        <itemizedlist spacing="compact">
          <listitem><para>the user interface in the view</para></listitem>
          <listitem><para>the input logic in the controller</para></listitem>
          <listitem><para>the business logic in the model</para></listitem>
        </itemizedlist>
      </para>
      <para>This separation allows you to work with complex structures while developing 
      the application because it ensures discrete implementation of each aspect. 
      The developer can focus on creating a view separately from implementing the 
      business logic.</para>
      <para>More comprehensive information about the ASP.NET MVC technology can be 
      found at the website of the <ulink url="http://www.asp.net/mvc/overview">ASP.NET 
      community</ulink>.
      </para>
    </section>  <!-- fbdevgd30-mvc-interactions -->
  </section> <!-- fbdevgd30-dot-net-mvc -->
  
  <section id="fbdevgd30-mvc-stack">
    <title>Software Stack</title>
    <para>Along with the libraries for working with Firebird, Entity Framework and MVC.NET, 
    you will need a number of JavaScript libraries to support a responsive interface, such as
    jquery, jquery-ui, Bootstrap, jqGrid. In this example, we have tried to make a web 
    application whose interface is similar to a desktop UI, by employing grids for views 
    and modal windows for data input.</para>
    
    <section id="fbdevgd30-mvc-vs">
      <title>Preparing Visual Studio 2015 for Firebird Work</title>
      <para>Some essential steps are needed before you can start working in
      Visual Studio with Firebird.  The preparation process is described in detail
      in the previous chapter, under the topic <link linkend="fbdg30-efw-vs-prepare">Setting 
      Up for Firebird in Visual Studio 2015</link>.
      </para>
    </section>
  </section> <!-- fbdevgd30-mvc-stack -->

  <section id="fbdevgd30-mvc-crt-project">
    <title>Creating a Project</title>
    <para>The Following topics will show how to use the Visual Studio wizards to create 
    the framework of an MVC.NET application.</para>
    <para>Open <classname>File</classname>&#x2014;&gt;<classname>New</classname>&#x2014;&gt;<classname>Project</classname>
    in Visual Studio 2015 and create a new project named <classname>FBMVCExample</classname>.
      <figure id="mvc-project-create01">
        <title>Create the FBMVCExample project</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 941px X 653px -->
            <imagedata fileref="images/fbdevgd30_mvc_002_en.png" format="PNG"
            width="499px" depth="346px"
            scalefit="1" align="center" />  <!-- 53% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>

    <para>
      <figure id="mvc-project-create02">
        <title>Change authentication setting</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 786px X 513px -->
            <imagedata fileref="images/fbdevgd30_mvc_003_en.png" format="PNG"
            width="495px" depth="323px"
            scalefit="1" align="center" />  <!-- 63% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>

    <para>For now, we will create a web application with no authentication, so click the
    Change Authentication button to disable authentication. We will get back to this
    issue <link linkend="fbdevgd30-mvc-authentication">a bit later</link>. 
      <figure id="mvc-project-create-03">
        <title>Disable authentication for now</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 721px X 309px -->
            <imagedata fileref="images/fbdevgd30_mvc_004_en.png" format="PNG"
            width="454px" depth="195px"
            scalefit="1" align="center" />  <!-- 63% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>

    <section id="fbdevgd30-mvc-project-structure">
      <title>Structure of the Project</title>
      <para>The project that you create will have virtually no functionality, but
      it already has its basic structure, described briefly in the following table:
        <table id="fbdevgd30-tbl-project-structure">
          <?dbfo keep-together='auto'?>
          <title>Basic Structure of the MVC Project</title>
          <tgroup cols="2">
          <colspec colname="colProp" colwidth="2*"></colspec>
          <colspec colname="colPurp" colwidth="5*"></colspec>
            <thead>
              <row valign="middle">
                <entry align="center">Folder or File</entry>
                <entry align="center">Purpose</entry>
              </row>
            </thead>
            <tbody>
              <row valign="middle">
                <entry align="left">/App_Data folder</entry>
                <entry align="left">Where private web application data,
                such as XML files or database files, are located.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/App_Start folder</entry>
                <entry align="left">Contains some main configuration settings for the
                project, including the definitions of routes and filters.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Content folder</entry>
                <entry align="left">Static content goes in here, such as CSS files and images.
                It is an optional convention. You can store CSS files anywhere you want.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Controllers folder</entry>
                <entry align="left">Controller classes are saved here. It is an optional
                convention. You can store controller classes anywhere.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Models folder</entry>
                <entry align="left">View model and business model classes are saved here
                although it is better for all applications (except for the simplest ones)
                to define a business model in a separate project. It is an optional convention.
                You can store model classes anywhere you like.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Scripts folder</entry>
                <entry align="left">Stores the JavaScript libraries being used in the
                application. By default, Visual Studio adds jQuery libraries and several
                other popular JavaScript libraries. It is an optional convention.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Views folder</entry>
                <entry align="left">Stores the views and partial views.  They are commonly
                grouped together in sub-folders name for the controllers they are connected
                with.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Views/Shared subfolder</entry>
                <entry align="left">Stores layouts and views not specific to one
                controller.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Views/Web.config file</entry>
                <entry align="left">Contains the configuration information that ensures
                that views are processed within ASP.NET and not by the IIS web server.
                Also contains the namespaces imported into views by default.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Global.asax file</entry>
                <entry align="left">The global class of an ASP.NET application. A configuration
                for a route is registered in the file with its code (Global.asax.cs).
                Also contains also any code that is supposed to be executed during the
                launch or termination of an application or when an unhandled exception arises.</entry>
              </row>
              <row valign="middle">
                <entry align="left">/Web.config file</entry>
                <entry align="left">The configuration file for the application.</entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </para>
    </section> <!-- fbdevgd30-mvc-project-structure -->

    <section id="fbdevgd30-mvc-add-packages">
      <title>Adding the Missing Packages</title>
      <para>We will use the NuGet package manager to add the missing packages:
        <itemizedlist>
          <listitem><para>FirebirdSql.Data.FirebirdClient</para></listitem>
          <listitem><para>EntityFramework (automatically added by the wizard)</para></listitem>
          <listitem><para>EntityFramework.Firebird</para></listitem>
          <listitem><para>Bootstrap (automatically added by the wizard)</para></listitem>
          <listitem><para>jQuery (automatically added by the wizard)</para></listitem>
          <listitem><para>jQuery.UI.Combined</para></listitem>
          <listitem><para>Respond (automatically added by the wizard)</para></listitem>
          <listitem><para>Newtonsoft.Json</para></listitem>
          <listitem><para>Moderninzr (automatically added by the wizard)</para></listitem>
          <listitem><para>Trirand.jqGrid</para></listitem>
        </itemizedlist>
      </para>
      <note>
        <para>Not all packages provided by NuGet are the latest version of the 
        libraries. It is especially true for JavaScript libraries. You can 
        install the latest versions of JavaScript libraries using a content 
        delivery network (CDN) or by just downloading them and replacing the 
        libraries provided by NuGet.</para>
      </note>
      <para>Right-click the project name in Solution Explorer and select the 
      Manage NuGet Packages item in the drop-down menu.
      <figure id="mvc-install-pkgs-01">
        <title>Select Manage NuGet Packages</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size CROPPED is 502px X 472px -->
            <imagedata fileref="images/fbdevgd30_mvc_005_en.png" format="PNG"
            width="497px" depth="467px"
            scalefit="1" align="center" />  <!-- 99% -->
          </imageobject>
        </mediaobject>
      </figure>
      </para>
    
      <para>Find and install the necessary packages in the package manager.
      <figure id="mvc-install-pkgs-02">
        <title>Select packages for installing</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 803px X 649px -->
            <imagedata fileref="images/fbdevgd30_mvc_006_en.png" format="PNG"
            width="497px" depth="357px"
            scalefit="1" align="center" />  <!-- 55% -->
          </imageobject>
        </mediaobject>
      </figure>
      </para>
    </section> <!-- fbdevgd30-mvc-add-packages -->
  </section> <!-- fbdevgd30-mvc-crt-project -->

  <section id="fbdevgd30-mvc-crt-edm">
    <title>Creating an EDM</title>
    <para>If you already have a Windows Forms application that uses Entity Framework, 
    you can just model classes to the <filename>Models</filename> folder. Otherwise, 
    you have to create them from scratch. The process of creating an EDM is described 
    in the previous chapter in the topic <link linkend="fbdg30-efw-vs-crt-edm">Creating an Entity
    Data Model (EDM)</link>.</para>
    <para>There is one more small difference:  your response to the EDM wizard's 
    question about how to store the connection string:
      <figure id="mvc-crt-edm-01">
        <title>Configuring connection string storage</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 617px X 559px -->
            <imagedata fileref="images/fbdevgd30_mvc_007_en.png" format="PNG"
            width="494px" depth="447px"
            scalefit="1" align="center" />  <!-- 80% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>
    <para>When we create a web application, all users will work with the database
    using a single account, so select <classname>Yes</classname> for this question.
    Any user with enough privileges can be specified as the username. It is advisable
    not to use the SYSDBA user because it has more privileges than are required for
    a web application to work.</para>
    <para>You can always change the username in the application when it is ready
    for testing and deployment, by just editing the connection string in the
    <filename>AppName.exe.conf</filename> application configuration file.</para>

    <para>The connection string will be stored in the <classname>connectionStrings</classname>
    section and will look approximately as follows:
      <literallayout class="monospaced">
&lt;add name=&quot;DbModel&quot;
     connectionString=&quot;character set=UTF8; data source=localhost;
     initial catalog=examples; port number=3050;
     user id=sysdba; dialect=3; isolationlevel=Snapshot;
     pooling=True; password=masterkey;&quot;
     providerName=&quot;FirebirdSql.Data.FirebirdClient&quot; /&gt;
      </literallayout>
    </para>
  </section> <!-- fbdevgd30-mvc-crt-edm -->
  
  <section id="fbdevgd30-mvc-crt-ui">
    <title>Creating a User Interface</title>
    <para>Our first controller will be used to display customer data and accept 
    input for searches, inserts, edits and deletes.</para>
    
    <section id="fbdevgd30-mvc-crt-controller">
      <title>Creating the Controller for the Customer Interface</title>
      <para>
        <figure id="mvc-crt-controller-01">
          <title>Select Add&#x2014;&gt;Controller</title>
          <mediaobject>
            <imageobject>
            <!-- actual image size is 704px X 330px -->
              <imagedata fileref="images/fbdevgd30_mvc_008_en.png" format="PNG"
              width="500px" depth="234px"
              scalefit="1" align="center" />  <!-- 71% -->
            </imageobject>
          </mediaobject>
        </figure>
      </para>

      <para>
        <figure id="mvc-crt-controller-02">
          <title>Creating a controller (1)</title>
          <mediaobject>
            <imageobject>
            <!-- actual image size CROPPED is 941px X 403px -->
              <imagedata fileref="images/fbdevgd30_mvc_009_en.png" format="PNG"
              width="499px" depth="214px"
              scalefit="1" align="center" />  <!-- 53% -->
            </imageobject>
          </mediaobject>
        </figure>
      </para>
      <para>
        <figure id="mvc-crt-controller-03">
          <title>Creating a controller (2)</title>
          <mediaobject>
            <imageobject>
            <!-- actual image size is 586px X 377px -->
              <imagedata fileref="images/fbdevgd30_mvc_010_en.png" format="PNG"
              width="498px" depth="320px"
              scalefit="1" align="center" />  <!-- 85% -->
            </imageobject>
          </mediaobject>
        </figure>
      </para>

      <para>Once it is done, the controller <classname>CustomerController</classname> will be
      created, along with five views displaying:
        <orderedlist spacing="compact">
          <listitem><para>the customer list</para></listitem>
          <listitem><para>the customer details for one customer</para></listitem>
          <listitem><para>create (add) customer form</para></listitem>
          <listitem><para>edit customer form</para></listitem>
          <listitem><para>delete  customer form</para></listitem>
        </orderedlist>
      </para>

      <para>Since the Ajax technology and the jqGrid library will be used extensively in our
      project, the first view, for displaying the customer list as a table, will be enough
      for our purposes. The rest of the operations will be performed with jqGrid.</para>

      <section id="fbdevgd30-mvc-crt-controller-limiting-overhead">
        <title>Limiting Overhead</title>
        <para>We want to be aware of ways to limit the overhead involved in passing
        data and connections back and forth over the wide-area network. There are
        techniques that can help us with this.</para>
        <section id="fbdevgd30-mvc-crt-controller-limiting-data">
          <title>Limiting Returned Data</title>
          <para>The customer list may turn out to be quite big. The entire list from a big table
          is usually not returned in web applications because it could make the process of loading
          the page seriously slow. Instead, the data are usually split into pages or are dynamically
          loaded when the user scrolls down to the end of the page (or grid). We will use the first
          option in our project.</para>
        </section>

        <section id="fbdevgd30-mvc-crt-controller-limiting-connections">
        <title>Limiting Connections</title>
          <para>Another characteristic of web applications is that they do not keep any permanent
            connections to the database because the life of the page generation script is no longer
            than the time it takes to generate a response to the user request. A connection to the
             database is actually a rather expensive resource so we have to save it. Of course, there
            is a connection pool for reducing the time it takes to establish a connection to the
            database, but it is still advisable to make a connection to the database only when it is
            really necessary.</para>
          </section>
          <section id="fbdevgd30-mvc-crt-controller-browser">
            <title>Let the Browser Help You!</title>
            <para>One of the ways to reduce the amount of interaction with the database
            is to do the correctness checking on the user input in the browser. Fortunately,
            modern HTML5 and JavaScript libraries can do just that. For example, you can
            make the browser check for the presence of a required field or the maximum length
            of a string field in the input form.</para>
        </section>
      </section> <!-- fbdevgd30-mvc-crt-controller-limiting-overhead -->
    </section> <!--  fbdevgd30-mvc-crt-controller -->
  </section> <!-- fbdevgd30-mvc-crt-ui -->

  <section id="fbdevgd30-mvc-controller-to-jqgrid">
    <title>Adapting the Controller to jqGrid</title>
    <para>Now, we are going to change the CustomerController controller so that it works
    with jqGrid. The code is quite lengthy, so track the comments to get a sense of the way
    the controller works.
      <programlisting>
public class CustomerController : Controller
{
  private DbModel db = new DbModel();

  // Display view
  public ActionResult Index()
  {
    return View();
  }

  // Receiving data in JSON for grid
  public ActionResult GetData(int? rows, int? page, string sidx, string sord,
string searchField, string searchString, string searchOper)
  {
    // get the page number, the number of data displayed
    int pageNo = page ?? 1;
    int limit = rows ?? 20;
    // calculate the offset
    int offset = (pageNo - 1) * limit;

    // building a query for suppliers
    var customersQuery =
        from customer in db.CUSTOMERS
        select new
    {
        CUSTOMER_ID = customer.CUSTOMER_ID,
        NAME = customer.NAME,
        ADDRESS = customer.ADDRESS,
        ZIPCODE = customer.ZIPCODE,
        PHONE = customer.PHONE
    };
    // adding a search condition to the query, if it is produced
    if (searchField != null)
    {
      switch (searchOper)
      {
        case &quot;eq&quot;:
          customersQuery = customersQuery.Where(
            c =&gt; c.NAME == searchString);
          break;
        case &quot;bw&quot;:
          customersQuery = customersQuery.Where(
            c =&gt; c.NAME.StartsWith(searchString));
          break;
        case &quot;cn&quot;:
          customersQuery = customersQuery.Where(
            c =&gt; c.NAME.Contains(searchString));
          break;
      }
    }
    // get the total number of suppliers
    int totalRows = customersQuery.Count();
    // add sorting
    switch (sord) {
      case &quot;asc&quot;:
        customersQuery = customersQuery.OrderBy(
          customer =&gt; customer.NAME);
        break;
      case &quot;desc&quot;:
       customersQuery = customersQuery.OrderByDescending(
         customer =&gt; customer.NAME);
      break;
    }

    // get the list of suppliers
    var customers = customersQuery
          .Skip(offset)
          .Take(limit)
          .ToList();

    // calculate the total number of pages
    int totalPages = totalRows / limit + 1;
    // create the result for jqGrid
    var result = new
      {
        page = pageNo,
        total = totalPages,
        records = totalRows,
        rows = customers
      };
    // convert the result to JSON
    return Json(result, JsonRequestBehavior.AllowGet);
  }

  // Adding a new supplier
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Create(
[Bind(Include = &quot;NAME,ADDRESS,ZIPCODE,PHONE&quot;)] CUSTOMER customer)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      // get a new identifier using a generator
      customer.CUSTOMER_ID = db.NextValueFor(&quot;GEN_CUSTOMER_ID&quot;);
      // add the model to the list
      db.CUSTOMERS.Add(customer);
      // save model
      db.SaveChanges();
      // return success in JSON format
      return Json(true);
    }
    else {
      // join model errors in one string
      string messages = string.Join(&quot;; &quot;, ModelState.Values
        .SelectMany(x =&gt; x.Errors)
        .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Editing supplier
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Edit(
[Bind(Include = &quot;CUSTOMER_ID,NAME,ADDRESS,ZIPCODE,PHONE&quot;)] CUSTOMER customer)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      // mark the model as modified
      db.Entry(customer).State = EntityState.Modified;
      // save model
      db.SaveChanges();
      // return success in JSON format
      return Json(true);
    }
    else {
      // join model errors in one string
      string messages = string.Join(&quot;; &quot;, ModelState.Values
        .SelectMany(x =&gt; x.Errors)
        .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Deleting supplier
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Delete(int id)
  {
    // find supplier by id
    CUSTOMER customer = db.CUSTOMERS.Find(id);
    // delete supplier
    db.CUSTOMERS.Remove(customer);
    // save model
    db.SaveChanges();
    // return success in JSON format
    return Json(true);
  }

  protected override void Dispose(bool disposing)
  {
    if (disposing)
    {
      db.Dispose();
    }
    base.Dispose(disposing);
  }
}
      </programlisting>
    </para>
    <para>The <classname>Index</classname> method is used to display the 
    <filename>Views/Customer/Index.cshtml</filename> view. The view itself will be 
    <link linkend="fbdevgd30-mvc-controller-views">presented a bit later</link>.
    This view is actually an html page template with markup and JavaScript for initiating 
    jqGrid. The data itself will be obtained asynchronously in the JSON format,
    using the Ajax technology. The selected type of sorting, the page number and
    the search parameters will determine the format of an HTTP request that will be handled 
    by the <classname>GetData</classname> action. The parameters of the HTTP request are displayed 
    in the input parameters of the <classname>GetData</classname> method. We generate a LINQ query 
    based on these parameters and send the retrieved result in the JSON format.
      <note>
        <para>Various libraries can assist with parsing the parameters of a query generated by jqGrid
        and make it easier to build the model. We have not used them in our examples so the code might
        be somewhat cumbersome. You can always improve it, of course.</para>
      </note>
    </para>
    
    <para>The <classname>Create</classname> method is used to add a new customer record. The method has 
    the <code>[HttpPost]</code> attribute specified for it to indicate that the parameters of the
    <code>HTTP POST request ()</code> are to be displayed on the Customer model. Examine the following 
    line:
      <programlisting>
[Bind(Include = &quot;NAME,ADDRESS,ZIPCODE,PHONE&quot;)] CUSTOMER customer
      </programlisting>
    Here <classname>Bind</classname> specifies which parameters of the HTTP request are to be displayed 
    in the properties of the model.
    </para>

    <section id="fbdevgd30-mvc-controller-anti-forgery">
      <title>The Attribute ValidateAntiforgeryToken</title>
      <para>Note the ValidateAntiforgeryToken attribute. It is used to prevent forging requests 
      between websites by verifying the tokens when the action method is called. The presence 
      of this attribute requires that the HTTP request has an additional parameter named
      <code>__RequestVerificationToken</code>.</para>
      <para>This parameter is automatically added to each form where the <code>@Html.AntiForgeryToken()</code> 
      helper is specified. However, the jqGrid library uses dynamically generated Ajax requests 
      rather than previously created web forms.  To fix that, we need to change the shared view 
      <code>Views/Shared/_Layout.cshtml</code> as follows:
        <literallayout class="monospaced">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;/&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;title&gt;@ViewBag.Title - ASP.NET application&lt;/title&gt;
  @Styles.Render(&quot;~/Content/css&quot;)
  @Scripts.Render(&quot;~/bundles/modernizr&quot;)
  @Scripts.Render(&quot;~/bundles/jquery&quot;)
  @Scripts.Render("~/bundles/jquery-ui")
  &lt;link href=&quot;~/Content/jquery.jqGrid/ui.jqgrid.css&quot;
        rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;
   &lt;link href=&quot;~/Content/jquery.jqGrid/ui.jqgrid-bootstrap.css&quot;
         rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;
   &lt;link href=&quot;~/Content/jquery.jqGrid/ui.jqgrid-bootstrap-ui.css&quot;
         rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;
   &lt;script src=&quot;~/Scripts/jquery.jqGrid.min.js&quot;
           type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;~/Scripts/i18n/grid.locale-en.js&quot;
            type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  @Html.AntiForgeryToken()
  &lt;script&gt;
    
    function GetAntiForgeryToken() {
      var tokenField =
        $(&quot;input[type='hidden'][name$='RequestVerificationToken']&quot;);
      if (tokenField.length == 0) {
        return null;
      } else {
        return {
          name: tokenField[0].name,
          value: tokenField[0].value
        };
      }
    }

    // add prefilter to all ajax requests
    // it will add to any POST ajax request
    // AntiForgery token
    $.ajaxPrefilter(
      function (options, localOptions, jqXHR) {
        if (options.type !== &quot;GET&quot;) {
          var token = GetAntiForgeryToken();
          if (token !== null) {
            if (options.data.indexOf("&quot;X-Requested-With&quot;) === -1) {
              options.data = &quot;X-Requested-With=XMLHttpRequest&quot;
              + ((options.data === &quot;&quot;) ? &quot;&quot; : &quot;&amp;&quot; + options.data);
            }
            options.data = options.data + &quot;&amp;&quot; + token.name + '='
                         + token.value;
          }
        }
      }
    );
    // initialize the general properties of the jqGrid module
    $.jgrid.defaults.width = 780;
    $.jgrid.defaults.responsive = true;
    $.jgrid.defaults.styleUI = 'Bootstrap';
  &lt;/script&gt;

  &lt;!-- <emphasis>Navigation menu</emphasis> --&gt;
  &lt;div class=&quot;navbar navbar-inverse navbar-fixed-top&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
      &lt;div class=&quot;navbar-header&quot;&gt;
        &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot;
                data-target=&quot;.navbar-collapse&quot;&gt;
          &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
          &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;
          &lt;span class=&quot;icon-bar&quot;7gt;&lt;/span&gt;
        &lt;/button&gt;
      &lt;/div>&gt;
      &lt;div class=&quot;navbar-collapse collapse&quot;&gt;
        &lt;ul class=&quot;nav navbar-nav&quot;&gt;
          &lt;li&gt;@Html.ActionLink(&quot;Customers&quot;, &quot;Index&quot;, &quot;Customer&quot;)&lt;/li&gt;
          &lt;li&gt;@Html.ActionLink(&quot;Goods&quot;, &quot;Index&quot;, &quot;Product&quot;)&lt;/li&gt;
          &lt;li&gt;@Html.ActionLink(&quot;Invoices&quot;, &quot;Index&quot;, &quot;Invoice&quot;)&lt;/li&gt;
        &lt;/ul>
      &lt;/div>
    &lt;/div>
  &lt;/div>

  &lt;div class=&quot;container body-content&quot;&gt;
    @RenderBody()
    &lt;hr /&gt;
    &lt;footer&gt;
      &lt;p&gt;&amp;copy; @DateTime.Now.Year - ASP.NET application&lt;/p&gt;
    &lt;/footer&gt;
  &lt;/div&gt;

  @Scripts.Render(&quot;~/bundles/bootstrap&quot;)
  @RenderSection(&quot;scripts&quot;, required: false)
&lt;/body&gt;
&lt;/html&gt;
        </literallayout>
      </para>
    </section> <!-- fbdevgd30-mvc-controller-anti-forgery -->
  </section> <!-- fbdevgd30-mvc-controller-to-jqgrid -->
    
  <section id="fbdevgd30-mvc-controller-bundles">
    <title>Bundles</title>
    <para>Bundles are used to make it easier to link JavaScript scripts and
    CSS files. You can link CSS bundles with the <classname>Styles.Render</classname>
    helper and script bundles with the <classname>Scripts.Render</classname>
    helper.</para>
    <para>Bundles are registered in the <code>BundleConfig.cs</code> file
    located in the <code>App_Start</code> folder:
      <programlisting>
public static void RegisterBundles(BundleCollection bundles)
{
  bundles.Add(new ScriptBundle(&quot;~/bundles/jquery&quot;).Include(
    &quot;~/Scripts/jquery-{version}.js&quot;));
  bundles.Add(new ScriptBundle(&quot;~/bundles/jqueryval&quot;).Include(
    &quot;~/Scripts/jquery.validate*&quot;));
  bundles.Add(new ScriptBundle(&quot;~/bundles/jquery-ui&quot;).Include(
    &quot;~/Scripts/jquery-ui-{version}.js&quot;));
  bundles.Add(new ScriptBundle(&quot;~/bundles/modernizr&quot;).Include(
    &quot;~/Scripts/modernizr-*&quot;));
  bundles.Add(new ScriptBundle(&quot;~/bundles/bootstrap&quot;).Include(
    &quot;~/Scripts/bootstrap.js&quot;,
    &quot;~/Scripts/respond.js&quot;));
  bundles.Add(new StyleBundle(&quot;~/Content/css&quot;).Include(
    &quot;~/Content/jquery-ui.min.css&quot;,
    &quot;~/Content/themes/ui-darkness/jquery-ui.min.css&quot;,
    &quot;~/Content/themes/ui-darkness/theme.css&quot;,
    &quot;~/Content/bootstrap.min.css&quot;,
    &quot;~/Content/Site.css&quot;
  ));
}
      </programlisting>
    </para>
    <para>The <classname>RegisterBundles</classname> method adds all created bundles
    to the bundles collection. A bundle is declared in the following way:
      <literallayout class="monospaced">
  new ScriptBundle(&quot;~/bundles/jquery&quot;).Include(&quot;~/Scripts/jquery-{version}.js&quot;)
      </literallayout>
    </para>
    <para>The virtual path of the bundle is passed to the <classname>ScriptBundle</classname> 
    construct. Specific script files are included in this bundle using the <classname>Include</classname> 
    method.</para>
    <para>The {version} parameter in the <quote><code>~/Scripts/jquery-{version}.js</code></quote>
    expression is a placeholder for any string referring to the script version. It is very 
    handy because it allows the version of the library to be changed later without having to 
    change anything in the code.  The system will accept the new version automatically.</para>
    <para>The <quote><code>~/Scripts/jquery.validate*</code></quote> expression fills out the
    rest of the string  with the asterisk character as a wildcard. For example, the expression 
    will include two files at once in the bundle: <code>jquery.validate.js</code> 
    and <code>jquery.validate.unobtrusive.js</code>,     along with their minimized versions, 
    because their names both start with <quote><code>jquery.validate</code></quote>.</para>

    <para>The same applies when creating CSS bundles, using the 
    <classname>StyleBundle</classname> class.</para>
    <important>
      <para>The full versions of the scripts and cascading style sheets should be used
      in the debug mode and the minimized ones in the release mode. Bundles allow you to solve
      this problem. When you run the application in the debug mode, the <code>web.config</code>
      files have the <code>&lt;compilation debug=&quot;true&quot;></code> parameter. When you
      set this parameter to false (the Release mode), the minimized version of JavaScript modules
      and CSS files will be used instead of the full ones.</para>
    </important>
  </section> <!-- fbdevgd30-mvc-controller-bundles -->

  <section id="fbdevgd30-mvc-controller-views">
    <title>Views</title>
      <para>Since we need only the <filename>View/Customer/Index.cshtml</filename> view out of the
      five created for the Customer controller, you can delete the others from the folder.</para>
      <para>You can see that the entire view consists of the header, the jqg table and
      the jqg-pager block for displaying the navigation bar. The rest is occupied by
      the script for initiating the grid, the navigation bar and the dialog box for
      editing records.
        <programlisting>
@{
  ViewBag.Title = &quot;Index&quot;;
}

&lt;h2&gt;Customers&lt;/h2&gt;
&lt;table id=&quot;jqg&quot;&gt;&lt;/table&gt;
&lt;div id=&quot;jqg-pager&quot;&gt;&lt;/div&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
  $(document).ready(function () {
    var dbGrid = $(&quot;#jqg&quot;).jqGrid({
      url: '@Url.Action(&quot;GetData&quot;)', // URL to retrieve data
      datatype: &quot;json&quot;, // data format
      mtype: &quot;GET&quot;, // http type request
      // model description
      colModel: [
      {
        label: 'Id',
        name: 'CUSTOMER_ID', // field name
        key: true,
        hidden: true
      },
      {
        label: 'Name',
        name: 'NAME',
        width: 250,
        sortable: true,
        editable: true,
        edittype: &quot;text&quot;, // field type in the editor
        search: true,
        searchoptions: {
          sopt: ['eq', 'bw', 'cn'] // allowed search operators
        },
        // size and maximum length for the input field
        editoptions: { size: 30, maxlength: 60 },
        // mandatory field
        editrules: { required: true }
      },
      {
        label: 'Address',
        name: 'ADDRESS',
        width: 300,
        sortable: false, // prohibit sorting
        editable: true,
        search: false, // prohibit searching
        edittype: &quot;textarea&quot;,
        editoptions: { maxlength: 250, cols: 30, rows: 4 }
      },
      {
        label: 'Zip Code',
        name: 'ZIPCODE',
        width: 30,
        sortable: false,
        editable: true,
        search: false,
        edittype: &quot;text&quot;,
        editoptions: { size: 30, maxlength: 10 },
      },
      {
        label: 'Phone',
        name: 'PHONE',
        width: 80,
        sortable: false,
        editable: true,
        search: false,
        edittype: &quot;text&quot;,
        editoptions: { size: 30, maxlength: 14 },
      }
      ],
      rowNum: 500, // number of rows displayed
      loadonce: false, // load only once
      sortname: 'NAME', // sort by default by NAME column
      sortorder: &quot;asc&quot;,
      width: window.innerWidth - 80, // grid width
      height: 500, // grid height
      viewrecords: true, // display the number of records
      caption: &quot;Customers&quot;,
      pager: 'jqg-pager' // navigation item id
    });

    dbGrid.jqGrid('navGrid', '#jqg-pager', {
        search: true,
        add: true,
        edit: true,
        del: true,
        view: true,
        refresh: true,
        // button labels
        searchtext: &quot;Find&quot;,
        addtext: &quot;Add&quot;,
        edittext: &quot;Edit&quot;,
        deltext: &quot;Delete&quot;,
        viewtext: &quot;View&quot;,
        viewtitle: &quot;Selected record&quot;,
        refreshtext: &quot;Refresh&quot;
      },
      update(&quot;edit&quot;),
      update(&quot;add&quot;),
      update(&quot;del&quot;)
    );

    // function that returns the settings of the editor
    function update(act) {
      return {
        closeAfterAdd: true,
        closeAfterEdit: true, 
        width: 400, // editor width
        reloadAfterSubmit: true, 
        drag: true, 
        // handler for sending the form of editing / deleting / adding
        onclickSubmit: function (params, postdata) {
          // get row id
          var selectedRow = dbGrid.getGridParam(&quot;selrow&quot;);
          // set URL depending on the operation
          switch (act) {
            case &quot;add&quot;:
              params.url = '@Url.Action(&quot;Create&quot;)';
              break;
            case &quot;edit&quot;:
              params.url = '@Url.Action(&quot;Edit&quot;)';
              postdata.CUSTOMER_ID = selectedRow;
              break;
            case &quot;del&quot;:
              params.url = '@Url.Action(&quot;Delete&quot;)';
              postdata.CUSTOMER_ID = selectedRow;
              break;
          }
        },
        // processing results of sending forms (operations)
        afterSubmit: function (response, postdata) {
          var responseData = response.responseJSON;
          // check the result for error messages
          if (responseData.hasOwnProperty(&quot;error&quot;)) {
            if (responseData.error.length) {
              return [false, responseData.error];
            }
          }
          else {
            // refresh grid
            $(this).jqGrid(
              'setGridParam',
              {
                datatype: 'json'
              }
            ).trigger('reloadGrid');
          }
          return [true, &quot;&quot;, 0];
        }
      };
    };
  });
&lt;/script&gt;
      </programlisting>
    </para>
    <para>It is important to configure the model properties correctly in order to display 
    the grid properly, position input items on the edit form, configure validation for 
    input forms and configure the sorting and search options. This configuration is not 
    simple and has a lot of parameters. In the comments I have tried to describe the 
    parameters being used. The full description of the model parameters can be found in 
    the documentation for the jqGrid library in the ColModel API section.</para>
    
    <para>Note that jqGrid does not automatically add hidden grid columns to the input
    form, though I think it would make sense at least for key fields.  Consequently, 
    we have to add the customer identifier to the request parameters for editing and 
    deleting:
      <programlisting>
case &quot;edit&quot;:
  params.url = '@Url.Action(&quot;Edit&quot;)';
  postdata.CUSTOMER_ID = selectedRow;
  break;
case &quot;del&quot;:
  params.url = '@Url.Action(&quot;Delete&quot;)';
  postdata.CUSTOMER_ID = selectedRow;
  break;
      </programlisting>
    </para>
    <para>The working page with the list of customers will look like this:
      <figure id="mvc-view-cust-list">
        <title>Customer list view</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 1275px X 861px -->
            <imagedata fileref="images/fbdevgd30_mvc_011_en.png" format="PNG"
            width="497px" depth="336px"
            scalefit="1" align="center" />  <!-- 39% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>
    <para>
      <figure id="mvc-view-cust-selected">
        <title>A customer selected for editing</title>
        <mediaobject>
          <imageobject>
          <!-- actual image size is 1275px X 855px -->
            <imagedata fileref="images/fbdevgd30_mvc_012_en.png" format="PNG"
            width="497px" depth="333px"
            scalefit="1" align="center" />  <!-- 39% -->
          </imageobject>
        </mediaobject>
      </figure>
    </para>
    
    <para>The controller and view for the product UI are implemented in a similar way. 
    We will not describe them here in detail. You can either write them yourself or use 
    the source code linked at the <link linkend="fbdg30-mvc-get-source-code">end of 
    this chapter</link>.</para>
  </section> <!-- fbdevgd30-mvc-controller-views -->
    
  <section id="fbdevgd30-mvc-secondary-ui">
    <title>Creating a UI for Secondary Modules</title>
    <para>Our application will have only one secondary module, called <quote>Invoices</quote>. 
    Unlike our primary modules, the secondary module is likely to contain numerous records and 
    new records are added more frequently.</para>
    <para>An invoice consists of a header where some general attributes are described (number, date, 
    customer &#x2026;) and invoice detail lines with the list of products sold, their quantities, 
    prices, etc. To save space on the page, we will hide the detail grid and display it only in 
    response to a click on the icon with the '+' sign on it. Thus, our detail grid will be
    embedded in the main one.</para>

    <section id="fbdevgd30-mvc-secondary-controllers">
      <title>Controllers for Invoices</title>
      <para>The controller of the invoice module must be able to return data for both invoice 
      headers and the associated invoice lines. The same applies to the methods for adding,
      editing and deleting records.
        <programlisting>
[Authorize(Roles = &quot;manager&quot;)]
public class InvoiceController : Controller
{
  private DbModel db = new DbModel();

  // display view
  public ActionResult Index()
  {
    return View();
  }

  // Receiving data in the JSON format for the main grid
  public ActionResult GetData(int? rows, int? page, string sidx, string sord,
string searchField, string searchString, string searchOper)
  {
    // get the page number, the number of data displayed
    int pageNo = page ?? 1;
    int limit = rows ?? 20;
    // calculate offset
    int offset = (pageNo - 1) * limit;
    // building a request for receipt of invoices
    var invoicesQuery =
        from invoice in db.INVOICES
        where (invoice.INVOICE_DATE &gt;= AppVariables.StartDate) &amp;&amp;
              (invoice.INVOICE_DATE &lt;= AppVariables.FinishDate)
        select new
        {
          INVOICE_ID = invoice.INVOICE_ID,
          CUSTOMER_ID = invoice.CUSTOMER_ID,
          CUSTOMER_NAME = invoice.CUSTOMER.NAME,
          INVOICE_DATE = invoice.INVOICE_DATE,
          TOTAL_SALE = invoice.TOTAL_SALE,
          PAID = invoice.PAID
        };
    // adding a search condition to the query, if it is produced
    // for different fields, different comparison operators 
    // are available when searching
    if (searchField == &quot;CUSTOMER_NAME&quot;)
    {
      switch (searchOper)
      {
        case &quot;eq&quot;: // equal
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.CUSTOMER_NAME == searchString);
          break;
        case &quot;bw&quot;: // starting with
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.CUSTOMER_NAME.StartsWith(searchString));
          break;
        case &quot;cn&quot;: // containing
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.CUSTOMER_NAME.Contains(searchString));
          break;
      }
    }
    if (searchField == &quot;INVOICE_DATE&quot;)
    {
      var dateValue = DateTime.Parse(searchString);
      switch (searchOper)
      {
        case &quot;eq&quot;: // =
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.INVOICE_DATE == dateValue);
          break;
        case &quot;lt&quot;: // &lt;
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.INVOICE_DATE &lt; dateValue);
          break;
        case &quot;le&quot;: // &lt;=
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.INVOICE_DATE &lt;= dateValue);
          break;
        case &quot;gt&quot;: // &gt;
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.INVOICE_DATE &gt; dateValue);
          break;
        case &quot;ge&quot;: // &gt;=
          invoicesQuery = invoicesQuery.Where(
          c =&gt; c.INVOICE_DATE &gt;= dateValue);
          break;
      }
    }
    if (searchField == &quot;PAID&quot;)
    {
      int iVal = (searchString == &quot;on&quot;) ? 1 : 0;
      invoicesQuery = invoicesQuery.Where(c =&gt; c.PAID == iVal);
    }
    // get the total number of invoices
    int totalRows = invoicesQuery.Count();
    // add sorting
    switch (sord)
    {
      case &quot;asc&quot;:
        invoicesQuery = invoicesQuery.OrderBy(
        invoice =&gt; invoice.INVOICE_DATE);
        break;
      case &quot;desc&quot;:
        invoicesQuery = invoicesQuery.OrderByDescending(
        invoice =&gt; invoice.INVOICE_DATE);
        break;
    }
    // get invoice list
    var invoices = invoicesQuery
       .Skip(offset)
       .Take(limit)
       .ToList();
    // calculate the total number of pages
    int totalPages = totalRows / limit + 1;
    // create the result for jqGrid
    var result = new
      {
        page = pageNo,
        total = totalPages,
        records = totalRows,
        rows = invoices
      };
    // convert the result to JSON
    return Json(result, JsonRequestBehavior.AllowGet);
  }

  // Receiving data in the form of JSON for the detail grid
  public ActionResult GetDetailData(int? invoice_id)
  {
    // build a LINQ query for receiving invoice items
    // filtered by invoice id
    var lines =
        from line in db.INVOICE_LINES
        where line.INVOICE_ID == invoice_id
        select new
      {
        INVOICE_LINE_ID = line.INVOICE_LINE_ID,
        INVOICE_ID = line.INVOICE_ID,
        PRODUCT_ID = line.PRODUCT_ID,
        Product = line.PRODUCT.NAME,
        Quantity = line.QUANTITY,
        Price = line.SALE_PRICE,
        Total = line.QUANTITY * line.SALE_PRICE
      };
    // get invoice position list
    var invoices = lines
        .ToList();
    // create the result for jqGrid
    var result = new
    {
      rows = invoices
    };
    // convert the result to JSON
    return Json(result, JsonRequestBehavior.AllowGet);
  }

  // Add new invoice
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Create(
  [Bind(Include = &quot;CUSTOMER_ID,INVOICE_DATE&quot;)] INVOICE invoice)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      try
      {
        var INVOICE_ID = new FbParameter(&quot;INVOICE_ID&quot;, FbDbType.Integer);
        var CUSTOMER_ID = new FbParameter(&quot;CUSTOMER_ID&quot;, FbDbType.Integer);
        var INVOICE_DATE = new FbParameter(&quot;INVOICE_DATE&quot;,
                               FbDbType.TimeStamp);
        // initialize parameters query
        INVOICE_ID.Value = db.NextValueFor(&quot;GEN_INVOICE_ID&quot;);
        CUSTOMER_ID.Value = invoice.CUSTOMER_ID;
        INVOICE_DATE.Value = invoice.INVOICE_DATE;
        // execute stored procedure
        db.Database.ExecuteSqlCommand(
          &quot;EXECUTE PROCEDURE SP_ADD_INVOICE(@INVOICE_ID, @CUSTOMER_ID, @INVOICE_DATE)&quot;,
          INVOICE_ID,
          CUSTOMER_ID,
          INVOICE_DATE);
        // return success in JSON format
        return Json(true);
      }
      catch (Exception ex)
      {
        // return error in JSON format
        return Json(new { error = ex.Message });
      }
    }
    else {
      string messages = string.Join(&quot;; &quot;, ModelState.Values
                       .SelectMany(x =&gt; x.Errors)
                       .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Edit invoice
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Edit(
  [Bind(Include = &quot;INVOICE_ID,CUSTOMER_ID,INVOICE_DATE&quot;)] INVOICE invoice)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      try
      {
        var INVOICE_ID = new FbParameter(&quot;INVOICE_ID&quot;, FbDbType.Integer);
        var CUSTOMER_ID = new FbParameter(&quot;CUSTOMER_ID&quot;, FbDbType.Integer);
        var INVOICE_DATE = new FbParameter(&quot;INVOICE_DATE&quot;,
                                           FbDbType.TimeStamp);
        // initialize parameters query
        INVOICE_ID.Value = invoice.INVOICE_ID;
        CUSTOMER_ID.Value = invoice.CUSTOMER_ID;
        INVOICE_DATE.Value = invoice.INVOICE_DATE;
        // execute stored procedure
        db.Database.ExecuteSqlCommand(
          &quot;EXECUTE PROCEDURE SP_EDIT_INVOICE(@INVOICE_ID, @CUSTOMER_ID, @INVOICE_DATE)&quot;,
          INVOICE_ID,
          CUSTOMER_ID,
          INVOICE_DATE);
        // return success in JSON format
        return Json(true);
      }
      catch (Exception ex)
      {
        // return error in JSON format
        return Json(new { error = ex.Message });
      }
    }
    else {
      string messages = string.Join(&quot;; &quot;, ModelState.Values
                       .SelectMany(x =&gt; x.Errors)
                       .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Delete invoice
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Delete(int id)
  {
    try
    {
      var INVOICE_ID = new FbParameter(&quot;INVOICE_ID&quot;, FbDbType.Integer);
      // initialize parameters query
      INVOICE_ID.Value = id;
      // execute stored procedure
      db.Database.ExecuteSqlCommand(
        &quot;EXECUTE PROCEDURE SP_DELETE_INVOICE(@INVOICE_ID)&quot;,
        INVOICE_ID);
      // return success in JSON format
      return Json(true);
    }
    catch (Exception ex)
    {
      // return error in JSON format
      return Json(new { error = ex.Message });
    }
  }

  // Payment of invoice
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult Pay(int id)
  {
    try
    {
      var INVOICE_ID = new FbParameter(&quot;INVOICE_ID&quot;, FbDbType.Integer);
      // initialize parameters query
      INVOICE_ID.Value = id;
      // execute stored procedure
      db.Database.ExecuteSqlCommand(
        &quot;EXECUTE PROCEDURE SP_PAY_FOR_INOVICE(@INVOICE_ID)&quot;,
        INVOICE_ID);
      // return success in JSON format
      return Json(true);
    }
    catch (Exception ex)
    {
      // return error in JSON format
      return Json(new { error = ex.Message });
    }
  }

  // Add invoice position
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult CreateDetail(
  [Bind(Include = &quot;INVOICE_ID,PRODUCT_ID,QUANTITY&quot;)] INVOICE_LINE invoiceLine)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      try
      {
        var INVOICE_ID = new FbParameter(&quot;INVOICE_ID&quot;, FbDbType.Integer);
        var PRODUCT_ID = new FbParameter(&quot;PRODUCT_ID&quot;, FbDbType.Integer);
        var QUANTITY = new FbParameter(&quot;QUANTITY&quot;, FbDbType.Integer);
        // initialize parameters query
        INVOICE_ID.Value = invoiceLine.INVOICE_ID;
        PRODUCT_ID.Value = invoiceLine.PRODUCT_ID;
        QUANTITY.Value = invoiceLine.QUANTITY;
        // execute stored procedure
        db.Database.ExecuteSqlCommand(
          &quot;&quot;EXECUTE PROCEDURE SP_ADD_INVOICE_LINE(@INVOICE_ID, @PRODUCT_ID, @QUANTITY)&quot;,
          INVOICE_ID,
          PRODUCT_ID,
          QUANTITY);
        // return success in JSON format
        return Json(true);
      }
      catch (Exception ex)
      {
        // return error in JSON format
        return Json(new { error = ex.Message });
      }
    }
    else {
      string messages = string.Join(&quot;; &quot;, ModelState.Values
                       .SelectMany(x =&gt; x.Errors)
                       .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Edit invoice position
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult EditDetail(
  [Bind(Include = &quot;INVOICE_LINE_ID,INVOICE_ID,PRODUCT_ID,QUANTITY&quot;)]
    INVOICE_LINE invoiceLine)
  {
    // check the correctness of the model
    if (ModelState.IsValid)
    {
      try
      {
        // Create parameters
        var INVOICE_LINE_ID = new FbParameter(&quot;INVOICE_LINE_ID&quot;,
                                              FbDbType.Integer);
        var QUANTITY = new FbParameter(&quot;QUANTITY&quot;, FbDbType.Integer);
        // initialize parameters query
        INVOICE_LINE_ID.Value = invoiceLine.INVOICE_LINE_ID;
        QUANTITY.Value = invoiceLine.QUANTITY;
        // execute stored procedure
        db.Database.ExecuteSqlCommand(
          &quot;EXECUTE PROCEDURE SP_EDIT_INVOICE_LINE(@INVOICE_LINE_ID, @QUANTITY)&quot;,
          INVOICE_LINE_ID,
          QUANTITY);
        // return success in JSON format
        return Json(true);
      }
      catch (Exception ex)
      {
        // return error in JSON format
        return Json(new { error = ex.Message });
      }
    }
    else {
      string messages = string.Join(&quot;; &quot;, ModelState.Values
                       .SelectMany(x =&gt; x.Errors)
                       .Select(x =&gt; x.ErrorMessage));
      // return error in JSON format
      return Json(new { error = messages });
    }
  }

  // Delete invoice position
  [HttpPost]
  [ValidateAntiForgeryToken]
  public ActionResult DeleteDetail(int id)
  {
    try
    {
      // create parameters
      var INVOICE_LINE_ID = new FbParameter(&quot;INVOICE_LINE_ID&quot;,
                                            FbDbType.Integer);
      // initialize parameters query
      INVOICE_LINE_ID.Value = id;
      // execute stored procedure
      db.Database.ExecuteSqlCommand(
        &quot;EXECUTE PROCEDURE SP_DELETE_INVOICE_LINE(@INVOICE_LINE_ID)&quot;,
        INVOICE_LINE_ID);
      // return success in JSON format
      return Json(true);
    }
    catch (Exception ex)
    {
      // return error in JSON format
      return Json(new { error = ex.Message });
    }
  }

  protected override void Dispose(bool disposing)
  {
    if (disposing)
    {
      db.Dispose();
    }
    base.Dispose(disposing);
  }
}
        </programlisting>
      </para>
      <para>The GetDetailData method for retrieving the list of lines in an invoice lacks 
      the code for page-by-page navigation. Realistically, a typical invoice does not have 
      enough lines  to justify using page-by-page navigation for them. Omitting it simplifies 
      and speeds up the code.</para>
      <para>In our project, all data modification operations are performed in stored procedures,
      but you could do the same work using Entity Framework. 
      <link linkend="fbdevg30-db-stored-procs">DDL code for the stored procedures</link> can
      be found in the database creation script in an earlier chapter and also in the .zip archives
      of all the DDL scripts: <literallayout><ulink url="https://github.com/sim1984/example-db_2_5/archive/1.0.zip">https://github.com/sim1984/example-db_2_5/archive/1.0.zip</ulink>
    or <ulink url="https://github.com/sim1984/example-db_3_0/archive/1.0.zip">https://github.com/sim1984/example-db_3_0/archive/1.0.zip</ulink></literallayout>
      </para>
    </section> <!-- fbdevgd30-mvc-secondary-controllers -->

    <section id="fbdevgd30-mvc-secondary-views">
      <title>Views for Invoices</title>
      <para>As with the Customer controller, only one view, <filename>View/Invoice/Index.cshtml</filename> 
      is needed. The others can be deleted from this folder. The layout of the view is very simple, but 
      the JavaScript code is quite extensive. We will examine the js code piece-by-piece.
        <programlisting>
@{
    ViewBag.Title = &quot;Index&quot;;
}

&lt;h2&gt;Invoices&lt;/h2&gt;
&lt;table id=&quot;jqg&quot;&gt;&lt;/table&gt;
&lt;div id=&quot;jpager&quot;&gt;&lt;/div&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
  /**
    * The code to work with jqGrid
    */
&lt;/script&gt;
        </programlisting>
      </para>
      
      <para>To begin with, we will take the code for working with the main grid. All we 
      have to write into it is the properties of the model (field types and sizes, search, 
      sorting, visibility parameters. etc.).
        <programlisting>
// invoice grid
var dbGrid = $(&quot;#jqg&quot;).jqGrid({
  url: '@Url.Action(&quot;GetData&quot;)', URL to retrieve data
  datatype: &quot;json&quot;, // format data
  mtype: &quot;GET&quot;, // type of http request
  // model description
  colModel: [
  {
    label: 'Id', 
    name: 'INVOICE_ID', 
    key: true,
    hidden: true 
  },
  {
    label: 'CUSTOMER_ID', 
    name: 'CUSTOMER_ID', 
    hidden: true, 
    editrules: { edithidden: true, required: true }, 
    editable: true, 
    edittype:'custom', // own type
    editoptions: {
      custom_element: function (value, options) {
        // add hidden input
        return $(&quot;&lt;input&gt;&quot;)
            .attr('type', 'hidden')
            .attr('rowid', options.rowId)
            .addClass(&quot;FormElement&quot;)
            .addClass(&quot;form-control&quot;)
            .val(value)
            .get(0);
      }
    }
  },
  {
    label: 'Date',
    name: 'INVOICE_DATE',
    width: 60, 
    sortable: true, 
    editable: true, 
    search: true, 
    edittype: &quot;text&quot;, // type of input
    align: &quot;right&quot;,
    formatter: 'date', // formatted as date
    sorttype: 'date', // sorted as date
    formatoptions: { // date format
      srcformat: 'd.m.Y H:i:s',
      newformat: 'd.m.Y H:i:s'
    },
    editoptions: {
      // initializing the form element for editing
      dataInit: function (element) {
        // create datepicker
        $(element).datepicker({
          id: 'invoiceDate_datePicker',
          dateFormat: 'dd.mm.yy',
          minDate: new Date(2000, 0, 1),
          maxDate: new Date(2030, 0, 1)
        });
      }
    },
    searchoptions: {
      // initializing the form element for searching
      dataInit: function (element) {
        // create datepicker
        $(element).datepicker({
          id: 'invoiceDate_datePicker',
          dateFormat: 'dd.mm.yy',
          minDate: new Date(2000, 0, 1),
          maxDate: new Date(2030, 0, 1)
        });
      },
      searchoptions: { // searching types
        sopt: ['eq', 'lt', 'le', 'gt', 'ge']
      },
    }
  },
  {
    label: 'Customer',
    name: 'CUSTOMER_NAME',
    width: 250,
    editable: true,
    edittype: &quot;text&quot;,
    editoptions: {
      size: 50,
      maxlength: 60,
      readonly: true 
    },
    editrules: { required: true },
    search: true,
    searchoptions: {
      sopt: ['eq', 'bw', 'cn']
    },
  },
  {
    label: 'Amount',
    name: 'TOTAL_SALE',
    width: 60,
    sortable: false,
    editable: false,
    search: false,
    align: &quot;right&quot;,
    formatter: 'currency', // format as currency
    sorttype: 'number',
    searchrules: {
      &quot;required&quot;: true,
      &quot;number&quot;: true,
      &quot;minValue&quot;: 0
    }
  },
  {
    label: 'Paid',
    name: 'PAID',
    width: 30,
    sortable: false,
    editable: true,
    search: true,
    searchoptions: {
      sopt: ['eq']
    },
    edittype: &quot;checkbox&quot;,
    formatter: &quot;checkbox&quot;,
    stype: &quot;checkbox&quot;,
    align: &quot;center&quot;,
    editoptions: {
      value: &quot;1&quot;,
      offval: &quot;0&quot;
    }
  }
  ],
  rowNum: 500, // number of rows displayed
  loadonce: false, 
  sortname: 'INVOICE_DATE', // sort by default by NAME column
  sortorder: &quot;desc&quot;,
  width: window.innerWidth - 80, // grid width
  height: 500, // grid height
  viewrecords: true, // display the number of records
  caption: &quot;Invoices&quot;, // grid caption
  pager: '#jpager', // pagination element
  subGrid: true, // show subgrid
  // javascript function for displaying the parent grid
  subGridRowExpanded: showChildGrid,
  subGridOptions: { 
    // upload data only once
    reloadOnExpand: false,
    // load the subgrid rows only when you click on the icon &quot;+&quot;
    selectOnExpand: true
  },
});

// display the navigation bar
dbGrid.jqGrid('navGrid', '#jpager',
  {
    search: true, 
    add: true, 
    edit: true, 
    del: true, 
    view: false, 
    refresh: true, 
    searchtext: &quot;Search&quot;,
    addtext: &quot;Add&quot;,
    edittext: &quot;Edit&quot;,
    deltext: &quot;Delete&quot;,
    viewtext: &quot;View&quot;,
    viewtitle: &quot;Selected record&quot;,
    refreshtext: &quot;Refresh&quot;
  },
  update(&quot;edit&quot;),
  update(&quot;add&quot;),
  update(&quot;del&quot;)
);
        </programlisting>
      </para>
      
      <para>We'll add one more <quote>custom</quote> button to the main grid, 
      for paying the invoice.
        <programlisting>
// Add a button to pay the invoice
dbGrid.navButtonAdd('#jpager',
{
  buttonicon: &quot;glyphicon-usd&quot;,
  title: &quot;Pay&quot;,
  caption: &quot;Pay&quot;,
  position: &quot;last&quot;,
  onClickButton: function () {
    // get the current record ID
    var id = dbGrid.getGridParam(&quot;selrow&quot;);
    if (id) {
      var url = '@Url.Action(&quot;Pay&quot;)';
      $.ajax({
        url: url,
        type: 'POST',
        data: { id: id },
        success: function (data) {
          // check if an error has occurred
          if (data.hasOwnProperty(&quot;error&quot;)) {
            alertDialog('Error', data.error);
          }
          else {
            // refresh grid
            $(&quot;#jqg&quot;).jqGrid(
              'setGridParam',
              {
                datatype: 'json'
              }
            ).trigger('reloadGrid');
          }
        }
      });
    }
  }
});
        </programlisting>
      </para>
    </section>  <!-- fbdevgd30-mvc-secondary-views -->

    <section id="fbdevgd30-mvc-secondary-dialogs">
      <title>Dialog Boxes for Invoices</title>
      <para>The dialog boxes for editing secondary sets of data are much more complicated 
      than for the primary sets. Since they often use options selected from other modules, 
      it will not be possible to use the standard jqGrid methods to build these edit dialog 
      boxes. However,  this library has an option to build dialog boxes using templates, 
      which we will use.</para>
      
      <para>To enable customer selection, we will create a read-only field with a button at 
      its right hand side for opening the form displaying the customer selection grid.
        <programlisting>
// returns properties to create edit dialogs
function update(act) {
  // editing dialog template
  var template = &quot;&lt;div style='margin-left:15px;' id='dlgEditInvoice'&gt;&quot;;
  template += &quot;&lt;div&gt;{CUSTOMER_ID} &lt;/div&gt;&quot;;
  template += &quot;&lt;div&gt; Date: &lt;/div&gt;&lt;div&gt;{INVOICE_DATE} &lt;/div&gt;&quot;;
  // customer input field with a button
  template += &quot;&lt;div&gt; Customer &lt;sup&gt;*&lt;/sup&gt;:&lt;/div&gt;&quot;;
  template += &quot;&lt;div&gt;&quot;;
  template += &quot;&lt;div style='float: left;'&gt;{CUSTOMER_NAME}&lt;/div&gt; &quot;;
  template += &quot;&lt;a style='margin-left: 0.2em;' class='btn'&quot;;
  template += &quot; onclick='showCustomerWindow(); return false;'&gt;&quot;;
  template += &quot;&lt;span class='glyphicon glyphicon-folder-open'&gt;&lt;/span&gt;&quot;;
  template += &quot; Select&lt;/a&gt; &quot;;
  template += &quot;&lt;div style='clear: both;'&gt;&lt;/div&gt;&quot;;
  template += &quot;&lt;/div&gt;&quot;;
  template += &quot;&lt;div&gt; {PAID} Paid &lt;/div&gt;&quot;;
  template += &quot;&lt;hr style='width: 100%;'/&gt;&quot;;
  template += &quot;&lt;div&gt; {sData} {cData} &lt;/div&gt;&quot;;
  template += &quot;&lt;/div&gt;&quot;;
  return {
    top: $(&quot;.container.body-content&quot;).position().top + 150,
    left: $(&quot;.container.body-content&quot;).position().left + 150,
    modal: true,
    drag: true,
    closeOnEscape: true,
    closeAfterAdd: true, 
    closeAfterEdit: true, 
    reloadAfterSubmit: true, 
    template: (act != &quot;del&quot;) ? template : null,
    onclickSubmit: function (params, postdata) {
      // get row id
      var selectedRow = dbGrid.getGridParam(&quot;selrow&quot;);
      switch (act) {
        case &quot;add&quot;: 
          params.url = '@Url.Action(&quot;Create&quot;)';
          // get customer id for current row
          postdata.CUSTOMER_ID =
            $('#dlgEditInvoice input[name=CUSTOMER_ID]').val();
          break;
        case &quot;edit&quot;:
          params.url = '@Url.Action(&quot;Edit&quot;)';
          postdata.INVOICE_ID = selectedRow;
          // get customer id for current row
          postdata.CUSTOMER_ID =
            $('#dlgEditInvoice input[name=CUSTOMER_ID]').val();
          break;
        case &quot;del&quot;:
          params.url = '@Url.Action(&quot;Delete&quot;)';
          postdata.INVOICE_ID = selectedRow;
          break;
      }
    },
    afterSubmit: function (response, postdata) {
      var responseData = response.responseJSON;
      // check the result for error messages
      if (responseData.hasOwnProperty(&quot;error&quot;)) {
        if (responseData.error.length) {
          return [false, responseData.error];
        }
        }
        else {
          // refresh grid
          $(this).jqGrid(
            'setGridParam',
            {
              datatype: 'json'
            }
          ).trigger('reloadGrid');
        }
        return [true, &quot;&quot;, 0];
      }
    };
  };
}
        </programlisting>
      </para>
      
      <para>Now we will write a function for opening the customer module that invokes
      the Bootstrap library to create a dialog box containing the grid from which a 
      customer can be selected. It is actually the same grid we used earlier but, this 
      time, it is enclosed by a dialog box. A click on the OK button will place the 
      customer identifier and the customer name into the input fields of the parent 
      dialog box for editing invoices.
        <programlisting>
/**
 * Display a window for selecting a customer
 */
function showCustomerWindow() {
  // the main block of the dialog
  var dlg = $('&lt;div&gt;')
     .attr('id', 'dlgChooseCustomer')
     .attr('aria-hidden', 'true')
     .attr('role', 'dialog')
     .attr('data-backdrop', 'static')
     .css(&quot;z-index&quot;, '2000')
     .addClass('modal')
     .appendTo($('body'));

  // block with the contents of the dialog
  var dlgContent = $(&quot;&lt;div&gt;&quot;)
     .addClass(&quot;modal-content&quot;)
     .css('width', '730px')
     .appendTo($('&lt;div&gt;')
     .addClass('modal-dialog')
     .appendTo(dlg));

  // block with dialogue header
  var dlgHeader = $('&lt;div&gt;').addClass(&quot;modal-header&quot;).appendTo(dlgContent);

  // button &quot;X&quot; for closing
  $(&quot;&lt;button&gt;&quot;)
    .addClass(&quot;close&quot;)
    .attr('type', 'button')
    .attr('aria-hidden', 'true')
    .attr('data-dismiss', 'modal')
    .html(&quot;&amp;asmp;times;&quot;)
    .appendTo(dlgHeader);

  // title
  $(&quot;&lt;h5&gt;&quot;).addClass(&quot;modal-title&quot;)
           .html(&quot;Select customer&quot;)
           .appendTo(dlgHeader);

  // body of dialogue
  var dlgBody = $('&lt;div&gt;')
     .addClass(&quot;modal-body&quot;)
     .appendTo(dlgContent);

  // footer of the dialogue
  var dlgFooter = $('&lt;div&gt;').addClass(&quot;modal-footer&quot;).appendTo(dlgContent);

  // button &quot;OK&quot;
  $(&quot;&lt;button&gt;&quot;)
    .attr('type', 'button')
    .addClass('btn')
    .html('OK')
    .on('click', function () {
       var rowId = $(&quot;#jqgCustomer&quot;).jqGrid(&quot;getGridParam&quot;, &quot;selrow&quot;);
       var row = $(&quot;#jqgCustomer&quot;).jqGrid(&quot;getRowData&quot;, rowId);
       // To save the identifier and customer name
       // to the input elements of the parent form
       $('#dlgEditInvoice input[name=CUSTOMER_ID]').val(rowId);
       $('#dlgEditInvoice input[name=CUSTOMER_NAME]').val(row[&quot;NAME&quot;]);
       dlg.modal('hide');
  })
  .appendTo(dlgFooter);
  
  // button &quot;Cancel&quot;
  $(&quot;&lt;button&gt;&quot;)
    .attr('type', 'button')
    .addClass('btn')
    .html('Cancel')
    .on('click', function () { dlg.modal('hide'); })
    .appendTo(dlgFooter);

  // add a table to display the customers in the body of the dialog
  $('&lt;table&gt;')
    .attr('id', 'jqgCustomer')
    .appendTo(dlgBody);

  // add the navigation bar
  $('&lt;div&gt;')
    .attr('id', 'jqgCustomerPager')
    .appendTo(dlgBody);

  dlg.on('hidden.bs.modal', function () {
    dlg.remove();
  });

  // show dialog
  dlg.modal();

  // create and initialize jqGrid
  var dbGrid = $(&quot;#jqgCustomer&quot;).jqGrid({
    url: '@Url.Action(&quot;GetData&quot;, &quot;Customer&quot;)', // URL to retrieve data
    mtype: &quot;GET&quot;, // http type of request
    datatype: &quot;json&quot;, // data format
    page: 1,
    width: '100%',
    // view description
    colModel: [
    {
      label: 'Id', 
      name: 'CUSTOMER_ID', 
      key: true, 
      hidden: true 
    },
    {
      label: 'Name',
      name: 'NAME',
      width: 250, 
      sortable: true, 
      editable: true, 
      edittype: &quot;text&quot;, // input type
      search: true, 
      searchoptions: {
        sopt: ['eq', 'bw', 'cn'] // allowed search operators
      },
      // size and maximum length for the input field
      editoptions: { size: 30, maxlength: 60 },
      // required input
      editrules: { required: true }
    },
    {
      label: 'Address',
      name: 'ADDRESS',
      width: 300,
      sortable: false, 
      editable: true, 
      search: false, 
      edittype: &quot;textarea&quot;,
      editoptions: { maxlength: 250, cols: 30, rows: 4 }
    },
    {
      label: 'Zip Code',
      name: 'ZIPCODE',
      width: 60,
      sortable: false,
      editable: true,
      search: false,
      edittype: &quot;text&quot;,
      editoptions: { size: 30, maxlength: 10 },
    },
    {
      label: 'Phone',
      name: 'PHONE',
      width: 85,
      sortable: false,
      editable: true,
      search: false,
      edittype: &quot;text&quot;,
      editoptions: { size: 30, maxlength: 14 },
    }
    ],
    loadonce: false,
    pager: '#jqgCustomerPager',
    rowNum: 500, // number of rows displayed
    sortname: 'NAME', // sort by default by NAME column
    sortorder: &quot;asc&quot;, 
    height: 500
  });

  dbGrid.jqGrid('navGrid', '#jqgCustomerPager',
    {
      search: true, 
      add: false, 
      edit: false, 
      del: false, 
      view: false, 
      refresh: true, 
      searchtext: &quot;Search&quot;,
      viewtext: &quot;View&quot;,
      viewtitle: &quot;Selected record&quot;,
      refreshtext: &quot;Refresh&quot;
    }
  );
}
        </programlisting>
      </para>
      
      <para>All that is left to write for the invoice module is the 
      <classname>showChildGrid</classname> function that enables the invoice lines 
      to be displayed and edited. Our function will create a grid with invoice lines 
      dynamically after a click on the '+' button to show the details.</para>
      <para>Loading data for the lines requires passing the primary key from the selected
      invoice header.
        <programlisting>
// handler of the event of opening the parent grid
// takes two parameters: the identifier of the parent record
// and the value of the primary key
function showChildGrid(parentRowID, parentRowKey) {
  var childGridID = parentRowID + &quot;_table&quot;;
  var childGridPagerID = parentRowID + &quot;_pager&quot;;
  // send the primary key of the parent record
  // to filter the entries of the invoice items
  var childGridURL = '@Url.Action(&quot;GetDetailData&quot;)';
  childGridURL = childGridURL + &quot;?invoice_id=&quot;
    + encodeURIComponent(parentRowKey)
  
  // add HTML elements to display the table and page navigation
  // as children for the selected row in the master grid
  $('&lt;table&gt;')
    .attr('id', childGridID)
    .appendTo($('#' + parentRowID));

  $('&lt;div&gt;')
    .attr('id', childGridPagerID)
    .addClass('scroll')
    .appendTo($('#' + parentRowID));
  
  // create and initialize the child grid
  var detailGrid = $(&quot;#&quot; + childGridID).jqGrid({
    url: childGridURL,
    mtype: &quot;GET&quot;,
    datatype: &quot;json&quot;,
    page: 1,
    colModel: [
    {
      label: 'Invoice Line ID',
      name: 'INVOICE_LINE_ID',
      key: true,
      hidden: true
    },
    {
      label: 'Invoice ID',
      name: 'INVOICE_ID',
      hidden: true,
      editrules: { edithidden: true, required: true },
      editable: true,
      edittype: 'custom',
      editoptions: {
        custom_element: function (value, options) {
          // create hidden input
          return $(&quot;&lt;input&gt;&quot;)
                 .attr('type', 'hidden')
                 .attr('rowid', options.rowId)
                 .addClass(&quot;FormElement&quot;)
                 .addClass(&quot;form-control&quot;)
                 .val(parentRowKey)
                 .get(0);
        }
      }
    },
    {
      label: 'Product ID', 
      name: 'PRODUCT_ID',
      hidden: true,
      editrules: { edithidden: true, required: true },
      editable: true,
      edittype: 'custom',
      editoptions: {
        custom_element: function (value, options) {
          // create hidden input
          return $(&quot;&lt;input&gt;&quot;)
                 .attr('type', 'hidden')
                 .attr('rowid', options.rowId)
                 .addClass(&quot;FormElement&quot;)
                 .addClass(&quot;form-control&quot;)
                 .val(value)
                 .get(0);
        }
      }
    },
    {
      label: 'Product',
      name: 'Product',
      width: 300,
      editable: true,
      edittype: &quot;text&quot;,
      editoptions: {
        size: 50,
        maxlength: 60,
        readonly: true
      },
      editrules: { required: true }
    },
    {
      label: 'Price',
      name: 'Price',
      formatter: 'currency',
      editable: true,
      editoptions: {
        readonly: true
      },
      align: &quot;right&quot;,
      width: 100
    },
    {
      label: 'Quantity',
      name: 'Quantity',
      align: &quot;right&quot;,
      width: 100,
      editable: true,
      editrules: { required: true, number: true, minValue: 1 },
      editoptions: {
        dataEvents: [
        {
          type: 'change',
          fn: function (e) {
            var quantity = $(this).val() - 0;
            var price =
              $('#dlgEditInvoiceLine input[name=Price]').val() - 0;
            $('#dlgEditInvoiceLine input[name=Total]').val(quantity * price);
          }
        }
        ],
        defaultValue: 1
      }
    },
    {
      label: 'Total',
      name: 'Total',
      formatter: 'currency',
      align: &quot;right&quot;,
      width: 100,
      editable: true,
      editoptions: {
        readonly: true
      }
    }
    ],
    loadonce: false,
    width: '100%',
    height: '100%',
    pager: &quot;#&quot; + childGridPagerID
  });

  // displaying the toolbar
  $(&quot;#&quot; + childGridID).jqGrid('navGrid', '#' + childGridPagerID,
    {
      search: false, 
      add: true, 
      edit: true, 
      del: true, 
      refresh: true 
    },
    updateDetail(&quot;edit&quot;), 
    updateDetail(&quot;add&quot;), 
    updateDetail(&quot;del&quot;) 
  );

  // function that returns settings for the editing dialog
  function updateDetail(act) {
    // editing dialog template
    var template = &quot;&lt;div style='margin-left:15px;' id='dlgEditInvoiceLine'&gt;&quot;;
    template += &quot;&lt;div&gt;{INVOICE_ID} &lt;/div&gt;&quot;;
    template += &quot;&lt;div&gt;{PRODUCT_ID} &lt;/div&gt;&quot;;
    // input field for goods with a button
    template += &quot;&lt;div&gt; Product &lt;sup&gt;*&lt;/sup&gt;:&lt;/div&gt;&quot;;
    template += &quot;&lt;div&gt;&quot;;
    template += &quot;&lt;div style='float: left;'&gt;{Product}&lt;/div&gt; &quot;;
    template += &quot;&lt;a style='margin-left: 0.2em;' class='btn' &quot;;
    template += &quot;onclick='showProductWindow(); return false;'&gt;&quot;;
    template += &quot;&lt;span class='glyphicon glyphicon-folder-open'&gt;&lt;/span&gt;&quot;;
    template += &quot; ???????&lt;/a&gt; &quot;;
    template += &quot;&lt;div style='clear: both;'&gt;&lt;/div&gt;&quot;;
    template += &quot;&lt;/div&gt;&quot;;
    template += &quot;&lt;div&gt; Quantity: &lt;/div&gt;&lt;div&gt;{Quantity} &lt;/div&gt;&quot;;
    template += &quot;&lt;div&gt; Price: &lt;/div&gt;&lt;div&gt;{Price} &lt;/div&gt;&quot;;
    template += &quot;&lt;div&gt; Total: &lt;/div&gt;&lt;div&gt;{Total} &lt;/div&gt;&quot;;
    template += &quot;&lt;hr style='width: 100%;'/&gt;&quot;;
    template += &quot;&lt;div&gt; {sData} {cData} &lt;/div&gt;&quot;;
    template += &quot;&lt;/div&gt;&quot;;
    return {
      top: $(&quot;.container.body-content&quot;).position().top + 150,
      left: $(&quot;.container.body-content&quot;).position().left + 150,
      modal: true,
      drag: true,
      closeOnEscape: true,
      closeAfterAdd: true, 
      closeAfterEdit: true, 
      reloadAfterSubmit: true, 
      template: (act != &quot;del&quot;) ? template : null,
      onclickSubmit: function (params, postdata) {
        var selectedRow = detailGrid.getGridParam(&quot;selrow&quot;);
        switch (act) {
          case &quot;add&quot;:
            params.url = '@Url.Action(&quot;CreateDetail&quot;)';
            // get invoice id
            postdata.INVOICE_ID =
              $('#dlgEditInvoiceLine input[name=INVOICE_ID]').val();
            // get the product ID for the current record
            postdata.PRODUCT_ID =
              $('#dlgEditInvoiceLine input[name=PRODUCT_ID]').val();
            break;
          case &quot;edit&quot;:
            params.url = '@Url.Action(&quot;EditDetail&quot;)';
            // get current record id
            postdata.INVOICE_LINE_ID = selectedRow;
            break;
          case &quot;del&quot;:
            params.url = '@Url.Action(&quot;DeleteDetail&quot;)';
            // get current record id
            postdata.INVOICE_LINE_ID = selectedRow;
            break;
        }
      },
      afterSubmit: function (response, postdata) {
        var responseData = response.responseJSON;
        // check the result for error messages
        if (responseData.hasOwnProperty(&quot;error&quot;)) {
          if (responseData.error.length) {
            return [false, responseData.error];
          }
        }
        else {
          // refresh grid
          $(this).jqGrid(
            'setGridParam',
            {
              datatype: 'json'
            }
          ).trigger('reloadGrid');
        }
        return [true, &quot;&quot;, 0];
      }
    };
  };
}
        </programlisting>
      </para>
      
      <para>Now we are done with creating the invoice module. Although the 
      <classname>showProductWindow function</classname> that is used to select a product 
      from the list while filling out invoice lines is not examined here, it is totally 
      similar to the <classname>showCustomerWindow</classname> function that we examined 
      earlier to implement the selection of customers from the customer module.</para>
      
      <para>An observant reader might have noticed that the functions for displaying the 
      selection from the module and for displaying the module itself were almost identical. 
      Something you could do yourself to improve the code is to move these functions into 
      separate .js script files.</para>
    </section> <!-- fbdevgd30-mvc-secondary-dialogs -->
  </section> <!-- fbdevgd30-mvc-secondary-ui -->

  <section id="fbdevgd30-mvc-authentication">
    <title>Authentication</title>
    <para>The ASP.NET technology has a powerful mechanism for managing authentication 
    in .NET applications called <firstterm>ASP.NET Identity</firstterm>. The infrastructure 
    of OWIN and AspNet Identity make it possible to perform both standard authentication and 
    authentication via external services through accounts in Google, Twitter, Facebook, et al.
    </para>
    <para>The description of the ASP.NET Identity technology is quite comprehensive and goes 
    beyond the scope of this publication but you can read about it at 
    <ulink url="http://www.asp.net/identity">http://www.asp.net/identity</ulink>.</para>
    <para>For our application, we will take a less complicated approach based on form 
    authentication. Enabling form authentication entails some changes in the 
    <filename>web.config</filename> configuration file. Find the &lt;system.web&gt; 
    section and insert the following subsection inside it:
      <literallayout class="monospaced">
&lt;authentication mode=&quot;Forms&quot;&gt;
  &lt;forms name=&quot;cookies&quot; timeout=&quot;2880&quot; loginUrl=&quot;~/Account/Login&quot;
         defaultUrl=&quot;~/Invoice/Index&quot;/&gt;
&lt;/authentication&gt;
      </literallayout>
    </para>
    <para>Setting <code>mode=&quot;Forms&quot;</code> enables form authentication. Some parameters 
    need to follow it. The following list of parameters is available:
      <variablelist>
        <varlistentry>
          <term>cookieless</term>
          <listitem><para>specifies whether cookie sets are used and how they are used. It
          can take the following values:</para>
            <itemizedlist spacing="compact">
              <listitem><para><classname>UseCookies</classname>&#x2014;specifies that the cookie sets will always be used,
              regardless of the device</para></listitem>
              <listitem><para><classname>UseUri</classname>&#x2014;cookies sets are never used</para></listitem>
              <listitem><para><classname>AutoDetect</classname>&#x2014;if the device supports cookie sets, they are used,
              otherwise, they are not used; a test determining their support is run for this setting.</para></listitem>
              <listitem><para><classname>UseDeviceProfile</classname>&#x2014;if the device supports cookie sets, they
              are used, otherwise, they are not used; no detection test is run. Used by default.</para></listitem>
            </itemizedlist>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>defaultUrl</term>
          <listitem><para>specifies the URL to redirect to after authentication</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>domain</term>
          <listitem><para>specifies cookie sets for the entire domain, allowing for the same
          cookie sets to be used for the main domain and its sub-domains.
          By default, its value is an empty string.</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>loginUrl</term>
          <listitem><para>the URL for user authentication. The default value
          is <code>&quot;~/Account/Login&quot;</code>.</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>name</term>
          <listitem><para>specifies the name for the cookie set. The default value
          is <code>&quot;.ASPXAUTH&quot;</code>.</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>path</term>
          <listitem><para>specifies the path for the cookie set. The default value is &quot;/&quot;.</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>requireSSL</term>
          <listitem><para>specifies whether an SSL connection is required for sending cookie sets.
          The default value is false</para></listitem>
        </varlistentry>
        <varlistentry>
          <term>timeout</term>
          <listitem><para>specifies the timeout for cookies in minutes.</para></listitem>
        </varlistentry>
      </variablelist>
    </para>
    
    <para>In our application, we will store authentication data in the same database that
    stores all other data to avoid the need for an additional connection string.</para>
    
    <section id="fbdevgd30-mvc-auth-infrastructure">
      <title>Infrastructure for Authentication</title>
      <para>Now we need to create all the infrastructure required for authentication&#x2014;models,
      controllers and views. The <classname>WebUser</classname> model describes the user:
        <programlisting>
[Table(&quot;Firebird.WEBUSER&quot;)]
public partial class WEBUSER
{
  [System.Diagnostics.CodeAnalysis.SuppressMessage(&quot;Microsoft.Usage&quot;,
   &quot;CA2214:DoNotCallOverridableMethodsInConstructors&quot;)]
  public WEBUSER()
  {
    WEBUSERINROLES = new HashSet&lt;WEBUSERINROLE&gt;();
  }

  [Key]
  [DatabaseGenerated(DatabaseGeneratedOption.None)]
  public int WEBUSER_ID { get; set; }

  [Required]
  [StringLength(63)]
  public string EMAIL { get; set; }

  [Required]
  [StringLength(63)]
  public string PASSWD { get; set; }

  [System.Diagnostics.CodeAnalysis.SuppressMessage(&quot;Microsoft.Usage&quot;,
   &quot;CA2227:CollectionPropertiesShouldBeReadOnly&quot;)]
  public virtual ICollection&lt;WEBUSERINROLE&gt; WEBUSERINROLES { get; set; }
}
We'll add two more models: one for the description of roles (WEBROLE) and another one for binding the roles to users (WEBUSERINROLE).
[Table(&quot;Firebird.WEBROLE&quot;)]
public partial class WEBROLE
{
  [Key]
  [DatabaseGenerated(DatabaseGeneratedOption.None)]
  public int WEBROLE_ID { get; set; }

  [Required]
  [StringLength(63)]
  public string NAME { get; set; }
}

[Table(&quot;Firebird.WEBUSERINROLE&quot;)]
public partial class WEBUSERINROLE
{
  [Key]
  [DatabaseGenerated(DatabaseGeneratedOption.None)]
  public int ID { get; set; }

  [Required]
  public int WEBUSER_ID { get; set; }

  [Required]
  public int WEBROLE_ID { get; set; }

  public virtual WEBUSER WEBUSER { get; set; }

  public virtual WEBROLE WEBROLE { get; set; }
}

We will use the Fluent API to specify relations between WEBUSER and WEBUSERINROLE in the DbModel class.
&#x2026;
  public virtual DbSet&lt;WEBUSER&gt; WEBUSERS { get; set; }
  public virtual DbSet&lt;WEBROLE&gt; WEBROLES { get; set; }
  public virtual DbSet&lt;WEBUSERINROLE&gt; WEBUSERINROLES { get; set; }
&#x2026;
  protected override void OnModelCreating(DbModelBuilder modelBuilder)
  {
    modelBuilder.Entity&lt;WEBUSER&gt;()
      .HasMany(e =&gt; e.WEBUSERINROLES)
      .WithRequired(e =&gt; e.WEBUSER)
      .WillCascadeOnDelete(false);
    &#x2026;
  }
&#x2026;
        </programlisting>
      </para>
      <para>Since we use the Database First technology, tables in the database can be created
      automatically.  I prefer to control the process so here is a script for creating the 
      additional tables:
      <programlisting>
RECREATE TABLE WEBUSER (
  WEBUSER_ID INT NOT NULL,
  EMAIL VARCHAR(63) NOT NULL,
  PASSWD VARCHAR(63) NOT NULL,
  CONSTRAINT PK_WEBUSER PRIMARY KEY(WEBUSER_ID),
  CONSTRAINT UNQ_WEBUSER UNIQUE(EMAIL)
);

RECREATE TABLE WEBROLE (
  WEBROLE_ID INT NOT NULL,
  NAME VARCHAR(63) NOT NULL,
  CONSTRAINT PK_WEBROLE PRIMARY KEY(WEBROLE_ID),
  CONSTRAINT UNQ_WEBROLE UNIQUE(NAME)
);

RECREATE TABLE WEBUSERINROLE (
  ID INT NOT NULL,
  WEBUSER_ID INT NOT NULL,
  WEBROLE_ID INT NOT NULL,
  CONSTRAINT PK_WEBUSERINROLE PRIMARY KEY(ID)
);

ALTER TABLE WEBUSERINROLE
ADD CONSTRAINT FK_WEBUSERINROLE_USER
FOREIGN KEY (WEBUSER_ID) REFERENCES WEBUSER (WEBUSER_ID);

ALTER TABLE WEBUSERINROLE
ADD CONSTRAINT FK_WEBUSERINROLE_ROLE
FOREIGN KEY (WEBROLE_ID) REFERENCES WEBROLE (WEBROLE_ID);

RECREATE SEQUENCE SEQ_WEBUSER;
RECREATE SEQUENCE SEQ_WEBROLE;
RECREATE SEQUENCE SEQ_WEBUSERINROLE;

SET TERM ^;

RECREATE TRIGGER TBI_WEBUSER
FOR WEBUSER
ACTIVE BEFORE INSERT
AS
BEGIN
  IF (NEW.WEBUSER_ID IS NULL) THEN
    NEW.WEBUSER_ID = NEXT VALUE FOR SEQ_WEBUSER;
END^

RECREATE TRIGGER TBI_WEBROLE
FOR WEBROLE
ACTIVE BEFORE INSERT
AS
BEGIN
  IF (NEW.WEBROLE_ID IS NULL) THEN
    NEW.WEBROLE_ID = NEXT VALUE FOR SEQ_WEBROLE;
END^

RECREATE TRIGGER TBI_WEBUSERINROLE
FOR WEBUSERINROLE
ACTIVE BEFORE INSERT
AS
BEGIN
  IF (NEW.ID IS NULL) THEN
    NEW.ID = NEXT VALUE FOR SEQ_WEBUSERINROLE;
END^

SET TERM ;^
        </programlisting>
      </para>

      <para>To test it, we'll add two users and two roles:
        <programlisting>
INSERT INTO WEBUSER (EMAIL, PASSWD) VALUES ('john', '12345');
INSERT INTO WEBUSER (EMAIL, PASSWD) VALUES ('alex', '123');
COMMIT;

INSERT INTO WEBROLE (NAME) VALUES ('admin');
INSERT INTO WEBROLE (NAME) VALUES ('manager');
COMMIT;

-- Link users and roles
INSERT INTO WEBUSERINROLE(WEBUSER_ID, WEBROLE_ID) VALUES(1, 1);
INSERT INTO WEBUSERINROLE(WEBUSER_ID, WEBROLE_ID) VALUES(1, 2);
INSERT INTO WEBUSERINROLE(WEBUSER_ID, WEBROLE_ID) VALUES(2, 2);
COMMIT;
        </programlisting>
      </para>
      <note>
        <title>Comment about passwords</title>
        <para>Usually, some hash from the password, rather than the actual
        password, is stored in an open form, using the md5 algorithm, for example.
        For our example, we have simplified authentication somewhat.</para>
      </note>

      <para>Our code will not interact directly with the WebUser model during
      registration and authentication. Instead, we will add some special models
      to the project:
        <programlisting>
namespace FBMVCExample.Models
{
  using System;
  using System.Collections.Generic;
  using System.ComponentModel.DataAnnotations;
  using System.ComponentModel.DataAnnotations.Schema;
  using System.Data.Entity.Spatial;

  // Login model
  public class LoginModel
  {
    [Required]
    public string Name { get; set; }

    [Required]
    [DataType(DataType.Password)]
    public string Password { get; set; }
  }

  // Model for registering a new user
  public class RegisterModel
  {
    [Required]
    public string Name { get; set; }

    [Required]
    [DataType(DataType.Password)]
    public string Password { get; set; }

    [Required]
    [DataType(DataType.Password)]
    [Compare(&quot;Password&quot;, ErrorMessage = &quot; Passwords do not match &quot;)]
    public string ConfirmPassword { get; set; }
  }
}
        </programlisting>
      </para>

      <para>These models will be used for the authentication and registration views, respectively.
    The authentication view is coded as follows:
        <programlisting>
@model FBMVCExample.Models.LoginModel

@{
  ViewBag.Title = &quot;Login&quot;;
}

&lt;h2&gt;Login&lt;/h2&gt;

@using (Html.BeginForm())
{
  @Html.AntiForgeryToken()
  &lt;div class=&quot;form-horizontal&quot;&gt;

    @Html.ValidationSummary(true)
    &lt;div class=&quot;form-group&quot;&gt;

      @Html.LabelFor(model =&gt; model.Name,
        new { @class = &quot;control-label col-md-2&quot; })
      &lt;div class=&quot;col-md-10&quot;&gt;
        @Html.EditorFor(model =&gt; model.Name)
        @Html.ValidationMessageFor(model =&gt; model.Name)
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
      @Html.LabelFor(model =&gt; model.Password,
        new { @class = &quot;control-label col-md-2&quot; })
      &lt;div class=&quot;col-md-10&quot;&gt;
        @Html.EditorFor(model =&gt; model.Password)
        @Html.ValidationMessageFor(model =&gt; model.Password)
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
      &lt;div class=&quot;col-md-offset-2 col-md-10&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Logon&quot; class=&quot;btn btn-default&quot; /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
}

@section Scripts {
  @Scripts.Render(&quot;~/bundles/jqueryval&quot;)
}

The registration view, in turn, is coded as follows:
@model FBMVCExample.Models.RegisterModel

@{
  ViewBag.Title = &quot;Registration&quot;;
}

&lt;h2&gt;???????????&lt;/h2&gt;

@using (Html.BeginForm())
{
  @Html.AntiForgeryToken()
  &lt;div class=&quot;form-horizontal&quot;&gt;

    @Html.ValidationSummary(true)
    &lt;div class=&quot;form-group&quot;&gt;
      @Html.LabelFor(model =&gt; model.Name,
        new { @class = &quot;control-label col-md-2&quot; })

      &lt;div class=&quot;col-md-10&quot;&gt;
        @Html.EditorFor(model =&gt; model.Name)
        @Html.ValidationMessageFor(model =&gt; model.Name)
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
      @Html.LabelFor(model =&gt; model.Password,
        new { @class = &quot;control-label col-md-2&quot; })

      &lt;div class=&quot;col-md-10&quot;&gt;
        @Html.EditorFor(model =&gt; model.Password)
        @Html.ValidationMessageFor(model =&gt; model.Password)
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
      @Html.LabelFor(model =&gt; model.ConfirmPassword,
        new { @class = &quot;control-label col-md-2&quot; })

      &lt;div class=&quot;col-md-10&quot;&gt;
        @Html.EditorFor(model =&gt; model.ConfirmPassword)
        @Html.ValidationMessageFor(model =&gt; model.ConfirmPassword)
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
      &lt;div class=&quot;col-md-offset-2 col-md-10&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Register&quot;
               class=&quot;btn btn-default&quot; /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
}

@section Scripts {
  @Scripts.Render(&quot;~/bundles/jqueryval&quot;)
}
        </programlisting>
      </para>
      <note>
        <title>Comment about users</title>
        <para>The model, views and controllers for user authentication and registration
        are made as simple as possible in this example.  A user usually has a lot more
        attributes than just a username and a password.</para>
      </note>

      <para>Now let us add one more controller&#x2014;AccountController&#x2014;with the
      following contents:
        <programlisting>
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Security;
using FBMVCExample.Models;

namespace FBMVCExample.Controllers
{
  public class AccountController : Controller
  {
    public ActionResult Login()
    {
      return View();
    }

    [HttpPost]
    [ValidateAntiForgeryToken]
    public ActionResult Login(LoginModel model)
    {
      if (ModelState.IsValid)
      {
        // search user in db
        WEBUSER user = null;
        using (DbModel db = new DbModel())
        {
          user = db.WEBUSERS.FirstOrDefault(
               u =&gt; u.EMAIL == model.Name &amp;&amp;
                    u.PASSWD == model.Password);
        }
        // if you find a user with a login and password,
        // then remember it and do a redirect to the start page
        if (user != null)
        {
          FormsAuthentication.SetAuthCookie(model.Name, true);
          return RedirectToAction(&quot;Index&quot;, &quot;Invoice&quot;);
        }
        else
        {
          ModelState.AddModelError(&quot;&quot;,
            &quot; A user with such a username and password does not exist &quot;);
        }
      }
      return View(model);
    }

    [Authorize(Roles = &quot;admin&quot;)]
    public ActionResult Register()
    {
      return View();
    }

    [HttpPost]
    [ValidateAntiForgeryToken]
    public ActionResult Register(RegisterModel model)
    {
      if (ModelState.IsValid)
      {
        WEBUSER user = null;
        using (DbModel db = new DbModel())
        {
          user = db.WEBUSERS.FirstOrDefault(u =&gt; u.EMAIL == model.Name);
        }
        if (user == null)
        {
          // create a new user
          using (DbModel db = new DbModel())
          {
            // get a new identifier using a sequence
            int userId = db.NextValueFor(&quot;SEQ_WEBUSER&quot;);
            db.WEBUSERS.Add(new WEBUSER {
              WEBUSER_ID = userId,
              EMAIL = model.Name,
              PASSWD = model.Password
            });
            db.SaveChanges();
            user = db.WEBUSERS.Where(u =&gt; u.WEBUSER_ID == userId)
                     .FirstOrDefault();
            // find the role of manager
            // This role will be the default role, i.e.
            // will be issued automatically upon registration
            var defaultRole =
                db.WEBROLES
                  .Where(r =&gt; r.NAME == &quot;manager&quot;)
                  .FirstOrDefault();
            // Assign the default role to the newly added user
            if (user != null &amp;&amp; defaultRole != null)
            {
              db.WEBUSERINROLES.Add(new WEBUSERINROLE
                {
                  WEBUSER_ID = user.WEBUSER_ID,
                  WEBROLE_ID = defaultRole.WEBROLE_ID
                });
              db.SaveChanges();
            }
          }
          // if the user is successfully added to the database
          if (user != null)
          {
            FormsAuthentication.SetAuthCookie(model.Name, true);
            return RedirectToAction(&quot;Login&quot;, &quot;Account&quot;);
          }
        }
        else
        {
          ModelState.AddModelError(&quot;&quot;,
            &quot;User with such login already exists&quot;);
        }
      }
      return View(model);
    }

    public ActionResult Logoff()
    {
      FormsAuthentication.SignOut();
      return RedirectToAction(&quot;Login&quot;, &quot;Account&quot;);
    }
  }
}
        </programlisting>
      </para>

      <para>Note the attribute <code>[Authorize(Roles = &quot;admin&quot;)]</code> to stipulate
      that only a user with the admin role can perform the user registration operation. This
      mechanism is called an <firstterm>authentication filter</firstterm>. We will get back to
      it <link linkend="fbdevgd30-mvc-authorize">a bit later</link>.</para>

      <section id="fbdevgd30-mvc-auth-add-user">
        <title>Adding a New User</title>
        <para>We add a new user to the database during registration and check during 
        authentication as to whether that user exists. If the user is found, we use 
        form authentication to set a cookie, as follows:
          <programlisting>
FormsAuthentication.SetAuthCookie(model.Name, true);
          </programlisting>
        </para>
        
        <para>All information about a user in Asp.Net MVC is stored in the proprty 
        <classname>HttpContext.User</classname> that implements the <classname>IPrincipal</classname> 
        interface defined in the <classname>System.Security.Principal</classname> namespace.</para>
        <para>The IPrincipal interface defines the <classname>Identity</classname> property that
        stores the object of the IIdentity interface describing the current user.</para>
        <para>The <classname>IIdentity</classname> interface has the following properties:
          <itemizedlist spacing="compact">
            <listitem><para>AuthenticationType: authentication type</para></listitem>
            <listitem><para>IsAuthenticated: returns true if the user is logged in</para></listitem>
            <listitem><para>Name: the username in the system</para></listitem>
          </itemizedlist>
        </para>
        
        <para>To determine whether a user is logged in, ASP.NET MVC receives cookies from the 
        browser and if the user is logged in, the property <classname>IIdentity.IsAuthenticated</classname> 
        is set to true and the <classname>Name</classname> property gets the username as its value.</para>
        
        <para>Next, we will add authentication items using the <firstterm>universal providers</firstterm> 
        mechanism.</para>
      </section> <!-- fbdevgd30-mvc-auth-add-user -->

      <section id="fbdevgd30-mvc-auth-uni-providers">
        <title>Universal Providers</title>
        <para>Universal providers offer a ready-made authentication functionality. At the same 
        time, these providers are flexible enough that we can redefine them to work in whatever 
        way we need them to. It is not necessary to redefine and use all four providers.  That is 
        handy if we do not need all of the fancy ASP.NET Identity features, but just a very 
        simple authentication system.</para>
        <para>So, our next step is to redefine the role provider. To do this, we need to add the 
        Microsoft.AspNet.Providers package using NuGet.</para>
        
        <section id="fbdevgd30-mvc-auth-role-provider">
          <title>Defining the Role Provider</title>
          <para>To define the role provider, first we add the <filename>Providers</filename> folder 
          to the project and then add a new <classname>MyRoleProvider</classname> class to it:
            <programlisting>
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Security;
using FBMVCExample.Models;

namespace FBMVCExample.Providers
{
  public class MyRoleProvider : RoleProvider
  {
    /// &lt;summary&gt;
    /// Returns the list of user roles
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;username&quot;&gt;Username&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public override string[] GetRolesForUser(string username)
    {
      string[] roles = new string[] { };
      using (DbModel db = new DbModel())
      {
        // Get the user
        WEBUSER user = db.WEBUSERS.FirstOrDefault(
                         u =&gt; u.EMAIL == username);
        if (user != null)
        {
          // fill in an array of available roles
          int i = 0;
          roles = new string[user.WEBUSERINROLES.Count];
          foreach (var rolesInUser in user.WEBUSERINROLES)
          {
            roles[i] = rolesInUser.WEBROLE.NAME;
            i++;
          }
        }
      }
      return roles;
    }

    /// &lt;summary&gt;
    /// Creating a new role
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;roleName&quot;&gt;Role name&lt;/param&gt;
    public override void CreateRole(string roleName)
    {
      using (DbModel db = new DbModel())
      {
        WEBROLE newRole = new WEBROLE() { NAME = roleName };
        db.WEBROLES.Add(newRole);
        db.SaveChanges();
      }
    }

    /// &lt;summary&gt;
    /// Returns whether the user role is present
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;username&quot;&gt;User name&lt;/param&gt;
    /// &lt;param name=&quot;roleName&quot;&gt;Role name&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public override bool IsUserInRole(string username, string roleName)
    {
      bool outputResult = false;
      using (DbModel db = new DbModel())
      {
        var userInRole =
            from ur in db.WEBUSERINROLES
            where ur.WEBUSER.EMAIL == username &amp;&amp;
                  ur.WEBROLE.NAME == roleName
            select new { id = ur.ID };
        outputResult = userInRole.Count() &gt; 0;
      }
      return outputResult;
    }

    public override void AddUsersToRoles(string[] usernames,
string[] roleNames)
    {
      throw new NotImplementedException();
    }

    public override string ApplicationName
    {
      get { throw new NotImplementedException(); }
      set { throw new NotImplementedException(); }
    }

    public override bool DeleteRole(string roleName,
bool throwOnPopulatedRole)
    {
      throw new NotImplementedException();
    }

    public override string[] FindUsersInRole(string roleName,
string usernameToMatch)
    {
      throw new NotImplementedException();
    }

    public override string[] GetAllRoles()
    {
      throw new NotImplementedException();
    }

    public override string[] GetUsersInRole(string roleName)
    {
      throw new NotImplementedException();
    }

    public override void RemoveUsersFromRoles(string[] usernames,
string[] roleNames)
    {
      throw new NotImplementedException();
    }

    public override bool RoleExists(string roleName)
    {
      throw new NotImplementedException();
    }
  }
}
            </programlisting>
          </para>
          <para>For the purpose of illustration, three methods are redefined:
            <itemizedlist spacing="compact">
              <listitem><para>GetRolesForUser&#x2014;for obtaining a set of roles for a specified user</para></listitem>
              <listitem><para>CreateRole&#x2014;for creating a role</para></listitem>
              <listitem><para>IsUserInRole&#x2014;determines whether the user has a specified role in the system</para></listitem>
            </itemizedlist>
          </para>
        </section> <!-- fbdevgd30-mvc-auth-role-provider -->

        <section id="fbdevgd30-mvc-auth-role-provider-config">
          <title>Configuring the Role Provider for Use</title>
          <para>To use the role provider in the application, we need to add its definition
          to the configuration file. Open the <filename>web.config file</filename> and remove 
          the definition of providers added automatically during the installation of the
           Microsoft.AspNet.Providers package.</para>
           <para>Next, we insert our provider within the system.web section:
             <literallayout class="monospaced">
&lt;system.web&gt;
  &lt;authentication mode=&quot;Forms&quot;&gt;
    &lt;forms name=&quot;cookies&quot; timeout=&quot;2880&quot; loginUrl=&quot;~/Account/Login&quot;
           defaultUrl=&quot;~/Invoice/Index&quot;/&gt;
  &lt;/authentication&gt;
  &lt;roleManager enabled=&quot;true&quot; defaultProvider=&quot;MyRoleProvider&quot;&gt;
    &lt;providers&gt;
      &lt;add name=&quot;MyRoleProvider&quot;
           type=&quot;FBMVCExample.Providers.MyRoleProvider&quot; /&gt;
    &lt;/providers&gt;
  &lt;/roleManager&gt;
&lt;/system.web&gt;
            </literallayout>
          </para>
        </section> <!-- fbdevgd30-mvc-auth-role-provider-config -->
      </section> <!-- fbdevgd30-mvc-auth-uni-providers -->
    </section> <!-- fbdevgd30-mvc-auth-infrastructure -->
  </section> <!-- fbdevgd30-mvc-authentication -->
  
  <section id="fbdevgd30-mvc-authorize">
    <title>Authorizing Access to Controller Methods</title>
    <para>Now we can limit (filter) access to the methods of various controllers using the
    <classname>Authorize</classname> attribute. We have already seen how it is used 
    in the AccountController controller:
      <programlisting>
[Authorize(Roles = &quot;admin&quot;)]
public ActionResult Register()
{&#x2026;
      </programlisting>
    </para>
    <para>This filter can be used at two levels: on a controller <emphasis>as a whole</emphasis>
    and on an individual operation of a controller. We will set different rights for our main 
    controllers: CustomerController, InvoiceController and ProductController. In our project, 
    a user with the <database>MANAGER</database> role can view and edit data in all three tables. 
    Setting a filter for the InvoiceController controller would be coded as follows:
      <programlisting>
[Authorize(Roles = &quot;manager&quot;)]
public class InvoiceController : Controller
{
  private DbModel db = new DbModel();
  
  // Show view
  public ActionResult Index()
  {
    return View();
  }
&#x2026;
      </programlisting>
    </para>
    <para>Setting filters in the other controllers can be implemented in a
    similar manner.</para>
  </section>

  <section id="fbdg30-mvc-get-source-code">
    <title>Source Code</title>
    <para>The source code for the sample application can be obtained from 
    <ulink url="https://www.firebirdsql.org/file/documentation/reference_manuals/fbdevgd-en/code/FBMVCExample.zip">FBMVCExample.zip</ulink>.
    </para>
  </section>

</chapter>