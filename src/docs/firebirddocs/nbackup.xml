<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<article id="nbackup">
  <articleinfo>
    <title>Firebird's nbackup tool</title>

    <author>
      <firstname>Paul</firstname>

      <surname>Vinkenoog</surname>
    </author>

    <othercredit>
      <firstname>Mark</firstname>

      <surname>Rotteveel</surname>
    </othercredit>

    <edition>September 2014 — Document version 1.4</edition>
  </articleinfo>

  <section id="nbackup-intro">
    <title>Introduction</title>

    <para><firstterm>Nbackup</firstterm> is a backup utility included in the Firebird download
    packages since version 2.0. It offers possibilities not present in <firstterm>gbak</firstterm> –
    Firebird's pre-existing backup tool – but doesn't replace the latter. Both programmes have their
    strengths and weaknesses; they will likely coexist for some time to come.</para>
  </section>

  <section id="nbackup-overview">
    <title>Nbackup features – an overview</title>

    <para>With nbackup, you can perform two different kinds of tasks:</para>

    <orderedlist>
      <listitem>
        <para>Making and restoring of both full and <firstterm>incremental</firstterm> backups. An
        <firstterm>incremental backup</firstterm> only contains the mutations since some specific
        previous backup.</para>
      </listitem>

      <listitem>
        <para>Locking the main database file so you can subsequently back it up yourself with
        copying or backup tools of your own choice. In this mode, nbackup doesn't back up anything;
        it just creates the conditions under which you can safely make the backup yourself. There's
        a provision for restoring here, too.</para>
      </listitem>
    </orderedlist>

    <para>Both modes can operate on an active database, without hindering connected users. The
    backup created will always reflect the state of the database <emphasis>at the beginning of the
    operation</emphasis>. Furthermore, only <database>SYSDBA</database> and the database owner (and
    sometimes OS admins) can make a backup, but every user can restore a backup to a new database.
    In these respects nbackup doesn't differ from gbak.</para>

    <section id="nbackup-advantages">
      <title>Advantages of nbackup</title>

      <itemizedlist>
        <listitem>
          <para><emphasis>Both modes:</emphasis> high speed (as high as hardware and OS will allow),
          because nbackup doesn't look at the actual data. In backup mode the contents are written
          more or less blindly to the backup file.</para>
        </listitem>

        <listitem>
          <para><emphasis>Backup/restore mode:</emphasis> time and disk space savings, because you
          don't need to make a full backup every time. This can make a huge difference with
          databases in the gigabyte range.</para>
        </listitem>

        <listitem>
          <para><emphasis>Lock/unlock mode:</emphasis> total freedom in your choice of backup, copy,
          and/or compression tools.</para>
        </listitem>
      </itemizedlist>
    </section>

    <section id="nbackup-limitations">
      <title>Limitations of nbackup</title>

      <itemizedlist>
        <listitem>
          <para>Nbackup will not sweep and compact your database the way gbak does.</para>
        </listitem>

        <listitem>
          <para>You can't change the database owner with an nbackup backup/restore cycle, like you
          can with gbak.</para>
        </listitem>

        <listitem>
          <para>Nbackup can't make <firstterm>transportable backups</firstterm>, that is: backups
          you can restore on an incompatible platform or under another server version.</para>
        </listitem>

        <listitem>
          <para>At this moment, nbackup should not be used on multi-file databases.</para>
        </listitem>

        <listitem>
          <para>Nbackup itself can only back up local databases. However, in Firebird 2.5 and above
          its backup and restore tasks can also be performed remotely through the Services
          Manager.</para>
        </listitem>

        <listitem>
          <para>Except when the Services Manager is used (in Firebird 2.5+) backing up with nbackup
          requires direct access to the database file. With gbak this is not the case.</para>
        </listitem>
      </itemizedlist>
    </section>
  </section>

  <section id="nbackup-functions-params">
    <title>Functions and parameters</title>

    <para>The following table gives an overview of nbackup's parameters. If the field
    <quote>Added</quote> is empty, the parameter has existed since nbackup's introduction in
    Firebird 2.0.</para>

    <table id="nbackup-tbl-params">
      <title>Nbackup parameters</title>

      <tgroup cols="3">
        <colspec colname="colParam" colwidth="4*"/>

        <colspec colname="colFunction" colwidth="5*"/>

        <colspec colname="colAdded" colwidth="1*"/>

        <thead>
          <row>
            <entry align="center">Parameter</entry>

            <entry align="center">Function</entry>

            <entry align="center">Added</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>-B <replaceable>n</replaceable> <replaceable>&lt;database&gt;</replaceable>
            [<replaceable>&lt;filename&gt;</replaceable>]</entry>

            <entry>Make level-<replaceable>n</replaceable> backup of database to file</entry>

            <entry/>
          </row>

          <row>
            <entry>-R <replaceable>&lt;database&gt;</replaceable>
            [<replaceable>&lt;filename&gt;</replaceable> ...]</entry>

            <entry>Restore database from backup file(s)</entry>

            <entry/>
          </row>

          <row>
            <entry>-L <replaceable>&lt;database&gt;</replaceable></entry>

            <entry>Lock database</entry>

            <entry/>
          </row>

          <row>
            <entry>-N <replaceable>&lt;database&gt;</replaceable></entry>

            <entry>Unlock locked database</entry>

            <entry/>
          </row>

          <row>
            <entry>-F <replaceable>&lt;database&gt;</replaceable></entry>

            <entry>Unlock user-restored database</entry>

            <entry/>
          </row>

          <row>
            <entry>-S</entry>

            <entry>Give size in database pages (with -L)</entry>

            <entry>2.1</entry>
          </row>

          <row>
            <entry>-T</entry>

            <entry>Suppress database triggers (with -B, -L, -N)</entry>

            <entry>2.1</entry>
          </row>

          <row>
            <entry>-D on|off</entry>

            <entry>Direct I/O on/off (with -B)</entry>

            <entry>2.1.4</entry>
          </row>

          <row>
            <entry>-U <replaceable>&lt;username&gt;</replaceable></entry>

            <entry>Supply user name (with -B, -L, -N)</entry>

            <entry/>
          </row>

          <row>
            <entry>-P <replaceable>&lt;password&gt;</replaceable></entry>

            <entry>Supply password (with -B, -L, -N)</entry>

            <entry/>
          </row>

          <row>
            <entry>-FE <replaceable>&lt;filename&gt;</replaceable></entry>

            <entry>Fetch password from file (with -B, -L, -N)</entry>

            <entry>2.5</entry>
          </row>

          <row>
            <entry>-Z</entry>

            <entry>Version info (by itself or with -B, -R, -L, -N, -F)</entry>

            <entry>2.5</entry>
          </row>

          <row>
            <entry>-?</entry>

            <entry>Help (switches off all other parameters)</entry>

            <entry>2.5</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Depending on the chosen main function (<parameter>-B</parameter>,
    <parameter>-R</parameter>, <parameter>-L</parameter>, <parameter>-N</parameter> or
    <parameter>-F</parameter>), nbackup may require different types of access to the database: a
    Firebird server connection, direct file access, or both. The following table gives the
    details:</para>

    <table id="nbackup-nl-tbl-access">
      <title>Access required</title>

      <tgroup cols="3">
        <colspec colname="colParam" colwidth="1*"/>

        <colspec colname="colFunction" colwidth="3*"/>

        <colspec colname="colAccess" colwidth="3*"/>

        <thead>
          <row>
            <entry align="center">Parameter</entry>

            <entry align="center">Function</entry>

            <entry align="center">Access</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>-B</entry>

            <entry>Backup</entry>

            <entry>server + file</entry>
          </row>

          <row>
            <entry>-R</entry>

            <entry>Restore</entry>

            <entry>file</entry>
          </row>

          <row>
            <entry>-L</entry>

            <entry>Lock</entry>

            <entry>server</entry>
          </row>

          <row>
            <entry>-N</entry>

            <entry>Unlock (undo -L)</entry>

            <entry>server</entry>
          </row>

          <row>
            <entry>-F</entry>

            <entry>Unlock after user restore</entry>

            <entry>file</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Where server access is required (with <parameter>-B</parameter>, <parameter>-L</parameter>
    and <parameter>-N</parameter>), the user must either provide a Firebird username and password
    (with <parameter>-U</parameter> and <parameter>-P</parameter>/<parameter>-FE</parameter> or
    through the environment variables <envar>ISC_USER</envar> and <envar>ISC_PASSWORD</envar>), or
    be admitted by the server on other grounds (e.g. as root under Posix or by trusted
    authentication under Windows).</para>

    <para>Where filesystem access is required (with <parameter>-B</parameter>,
    <parameter>-R</parameter> and <parameter>-F</parameter>), the user must have sufficient read
    and/or write privileges to the database file.</para>

    <para>Where filesystem access is required exclusively (with <parameter>-R</parameter> and
    <parameter>-F</parameter>), the user need not have a Firebird login and a running Firebird
    server need not be present.</para>

    <para>Please notice: The above table and text concern access to the
    <emphasis>database</emphasis>. Access to the backup file is – obviously – always on the
    filesystem level.</para>
  </section>

  <section id="nbackup-backups">
    <title>Making and restoring backups</title>

    <para>To begin with: <filename>nbackup.exe</filename> is located in the <filename
    class="directory">bin</filename> subdirectory of your Firebird folder. Typical locations are
    e.g. <filename class="directory">C:\Program Files\Firebird\Firebird_2_0\bin</filename> (Windows)
    or <filename class="directory">/opt/firebird/bin</filename> (Linux). Just like most of the tools
    that come with Firebird, nbackup has no graphical interface; you launch it from the command
    prompt or call it from within a batch file or application.</para>

    <warning>
      <para>Under heavy-load circumstances in some environments, nbackup 2.0.3 and below may cause
      problems that will lead to deadlocks or even corrupted databases. While these problems aren't
      common, they are serious enough to warrant upgrading to Firebird 2.0.4 or higher if you want
      to use nbackup comfortably. If it concerns large databases under Posix, the use of direct I/O
      may also make a difference. More about this in the section <link
      linkend="nbackup-backups-directio"><citetitle>Direct I/O</citetitle></link>.</para>

      <!--CORE-2316-->
    </warning>

    <section id="nbackup-backups-full">
      <title>Full backups</title>

      <section id="nbackup-backups-full-make">
        <title>Making full backups</title>

        <para>To make a full database backup, the command syntax is:</para>

        <blockquote>
          <programlisting>nbackup [-U <replaceable>&lt;user&gt;</replaceable> -P <replaceable>&lt;password&gt;</replaceable>] -B 0 <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backupfile&gt;</replaceable>]</programlisting>
        </blockquote>

        <para>For instance:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -B 0 inventory.fdb inventory_1-Mar-2006.nbk</screen>
        </blockquote>

        <para id="nbackup-backups-comments">Comments:</para>

        <itemizedlist>
          <listitem>
            <para>The parameter <parameter>-B</parameter> stands for backup (gee!). The
            <firstterm>backup level</firstterm> 0 indicates a full backup. Backup levels greater
            than 0 are used for incremental backups; we'll discuss those later on.</para>
          </listitem>

          <listitem>
            <para>Instead of a database filename you may also use an alias.</para>
          </listitem>

          <listitem>
            <para>Instead of a backup filename you may also specify <systemitem>stdout</systemitem>.
            This will send the backup to standard output, from where you can redirect it to e.g. a
            tape archiver or a compression tool.</para>
          </listitem>

          <listitem id="nbackup-backups-nologin">
            <para>The <parameter>-U</parameter> (user) and <parameter>-P</parameter> (password)
            parameters may be omitted if at least one of the following conditions is met:</para>

            <itemizedlist spacing="compact">
              <listitem>
                <para>The environment variables <envar>ISC_USER</envar> and
                <envar>ISC_PASSWORD</envar> have been set, either to <database>SYSDBA</database> or
                to the owner of the database.</para>
              </listitem>

              <listitem>
                <para>You are logged on as root on a Posix system. This makes you
                <database>SYSDBA</database> by default.</para>
              </listitem>

              <listitem>
                <para>Under Windows: Trusted authentication is enabled in
                <filename>firebird.conf</filename>, and you are logged on to the Windows account
                that owns the database. This is possible in Firebird 2.1 and above.</para>
              </listitem>

              <listitem>
                <para>Under Windows: Trusted authentication is enabled in
                <filename>firebird.conf</filename>, and you are logged on as a Windows
                administrator. In Firebird 2.1, this automatically gives you
                <database>SYSDBA</database> rights. In Firebird 2.5 and above, there is the
                additional condition that <database>AUTO ADMIN MAPPING</database> has been set in
                the database.</para>
              </listitem>
            </itemizedlist>

            <para>For clarity and brevity, the <parameter>-U</parameter> and
            <parameter>-P</parameter> parameters are not used in the examples.</para>
          </listitem>

          <listitem>
            <para>Starting with Firebird 2.5, instead of <parameter>-P</parameter>
            <replaceable>&lt;password&gt;</replaceable> you may also use <parameter>-FE</parameter>
            <replaceable>&lt;filename&gt;</replaceable>. This will cause nbackup to fetch the
            password from the given file. With <parameter>-FE</parameter>, the password itself
            doesn't appear in the command and will thus be better shielded against people who might
            otherwise pick it up via the command history, the <literal>w</literal> command on Unix
            or from a script or batchfile.</para>
          </listitem>

          <listitem>
            <para>In Firebird 2.1 and up, the firing of database triggers can be prevented by
            specifying the <parameter>-T</parameter> option. For more information, see <link
            linkend="nbackup-backups-dbtriggers"><citetitle>Suppressing database
            triggers</citetitle></link>.</para>
          </listitem>

          <listitem>
            <para>Starting with Firebird 2.1.4, it is possible to force direct I/O on or off by
            specifying <parameter>-D</parameter> <parameter>on</parameter> or
            <parameter>-D</parameter> <parameter>off</parameter>. For details and background see
            <link linkend="nbackup-backups-directio"><citetitle>Direct I/O</citetitle></link>,
            elsewhere in this manual.</para>
          </listitem>

          <listitem>
            <para>The different parameters (<parameter>-B</parameter>, <parameter>-U</parameter>
            etc.) may occur in any order. Of course each parameter should be immediately followed by
            its own argument(s). In the case of <parameter>-B</parameter> there are three of them:
            backup level, database, and backup file - in that order!</para>
          </listitem>

          <listitem>
            <para>If the <parameter>-B</parameter> parameter comes last, you
            <emphasis>may</emphasis> leave out the name of the backup file. In that case nbackup
            will compose a filename based on the database name, the backup level, and the current
            date and time. This can lead to a name clash (and a failed backup) if two backup
            commands of the same level are issued in the same minute.</para>
          </listitem>
        </itemizedlist>

        <warning>
          <para>Do <emphasis>not</emphasis> use nbackup for multi-file databases. This can lead to
          corruption and loss of data, despite the fact that nbackup will not complain about such a
          command.</para>
        </warning>

        <section id="nbackup-backups-workings">
          <title>A word on the inner workings</title>

          <para>Note: What follows here is not necessary knowledge to use nbackup. It just gives a
          rough (and incomplete) impression of what happens under the hood during execution of
          nbackup <parameter>-B</parameter>:</para>

          <procedure>
            <step>
              <para>First of all, the main database file is locked by changing an internal state
              flag. From this moment on, any and all mutations in the database are written to a
              temporary file - the difference file or <firstterm>delta file</firstterm>.</para>
            </step>

            <step>
              <para>Then the actual backup is made. This isn't a straight file copy; restoring must
              be done by nbackup as well.</para>
            </step>

            <step>
              <para>Upon completion of the backup, the contents of the delta file are integrated
              with the main database file. After that, the database is unlocked (flag goes back to
              <quote>normal</quote>) and the delta is removed.</para>
            </step>
          </procedure>

          <para>The functionality of steps 1 and 3 is provided by two new SQL statements:
          <database>ALTER DATABASE BEGIN BACKUP</database> and <database>ALTER DATABASE END
          BACKUP</database>. Contrary to what the names suggest, these statements do
          <emphasis>not</emphasis> take care of making the actual backup; rather, they create the
          conditions under which the main database file can be safely backed up. And to be clear:
          you don't need to issue these commands yourself; nbackup will do that for you, at the
          right moments.</para>
        </section>
      </section>

      <section id="nbackup-backups-full-restore">
        <title>Restoring a full backup</title>

        <para>A full backup is restored as follows:</para>

        <blockquote>
          <programlisting>nbackup -R <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backupfile&gt;</replaceable>]</programlisting>
        </blockquote>

        <para>For instance:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -R inventory.fdb inventory_1-Mar-2006.nbk</screen>
        </blockquote>

        <para id="nbackup-restore-comments">Comments:</para>

        <itemizedlist>
          <listitem>
            <para>You don't specify a level for a restore.</para>
          </listitem>

          <listitem>
            <para>When restoring, the <parameter>-R</parameter> parameter <emphasis>must</emphasis>
            come last, for reasons that will become clear later.</para>
          </listitem>

          <listitem>
            <para>Instead of a database filename you may also use an alias.</para>
          </listitem>

          <listitem>
            <para>If the specified database file already exists, the restore fails and you get an
            error message.</para>
          </listitem>

          <listitem>
            <para>Here too, you may omit the name of the backup file. If you do, nbackup will prompt
            you for it. <emphasis>(Attention! In Firebird 2.0 this <quote>interactive
            restore</quote> feature is broken, leaving you with an error message and a failed
            restore. Fixed in 2.0.1.)</emphasis></para>
          </listitem>

          <listitem>
            <para>Restoring works purely on the filesystem level and can even be done without a
            Firebird server running. Any credentials supplied via the <parameter>-U</parameter> and
            <parameter>-P</parameter> parameters are ignored. The same goes for passwords read from
            a file. However, nbackup <emphasis>does</emphasis> try to read the password from the
            file if the <parameter>-FE</parameter> parameter is present, and if an error occurs, the
            entire operation is abandoned.</para>
          </listitem>
        </itemizedlist>
      </section>
    </section>

    <section id="nbackup-backups-incr">
      <title>Incremental backups</title>

      <warning>
        <para>The incremental backup facility was entirely broken in Firebird 2.1, and fixed again
        in 2.1.1.</para>

        <!--CORE-1876-->
      </warning>

      <section id="nbackup-backups-incr-make">
        <title>Making incremental backups</title>

        <para>To make an incremental (<quote>differential</quote>) backup we specify a backup level
        greater than 0. An incremental backup of level <replaceable>N</replaceable> always contains
        the database mutations since the most recent level <replaceable>N-1</replaceable>
        backup.</para>

        <para>Examples:</para>

        <para>One day after the full backup (level 0), you make one with level 1:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -B 1 inventory.fdb inventory_2-Mar-2006.nbk</screen>
        </blockquote>

        <para>This backup will only contain the mutations of the last day.</para>

        <para>One day later again, you make another one with level 1:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -B 1 inventory.fdb inventory_3-Mar-2006.nbk</screen>
        </blockquote>

        <para>This one contains the mutations of the last <emphasis>two</emphasis> days, since the
        full backup, not only those since the previous level-1 backup.</para>

        <para>A couple of hours on we go for a level-2 backup:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -B 2 inventory.fdb inventory_3-Mar-2006_2.nbk</screen>
        </blockquote>

        <para>This youngest backup only contains the mutations since the most recent level-1 backup,
        that is: of the last few hours.</para>

        <note>
          <para>All the <link linkend="nbackup-backups-comments">comments</link> that have been made
          about full backups also apply to incremental backups.</para>
        </note>

        <warning>
          <para>Again: do not use nbackup for multi-file databases.</para>
        </warning>
      </section>

      <section id="nbackup-backups-incr-restore">
        <title>Restoring incremental backups</title>

        <para>When restoring incremental backups you must specify the entire chain of backup files,
        from level 0 through the one you wish to restore. The database is always built up from the
        ground, step by step. (It is this stepwise adding until the database is restored that gave
        rise to the term <emphasis>incremental backup</emphasis>.)</para>

        <para>The formal syntax is:</para>

        <blockquote>
          <programlisting>nbackup -R <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backup0&gt;</replaceable> [<replaceable>&lt;backup1&gt;</replaceable> [<replaceable>...</replaceable>] ] ]</programlisting>
        </blockquote>

        <para>So restoring the level-2 backup from the previous example goes as follows:</para>

        <blockquote>
          <screen>C:\Data&gt; nbackup -R inventory.fdb inventory_1-Mar-2006.nbk
           inventory_3-Mar-2006.nbk inventory_3-Mar-2006_2.nbk</screen>
        </blockquote>

        <para>Of course the line has been split here for layout reasons only - in reality you type
        the entire command and only hit <keycap>Enter</keycap> at the end.</para>

        <para>Comments (in addition to the <link linkend="nbackup-restore-comments">comments with
        restoring a full backup</link>):</para>

        <itemizedlist>
          <listitem>
            <para>Because it is not known beforehand how many filenames will follow the
            <parameter>-R</parameter> switch (as we don't specify a level when restoring), nbackup
            considers all arguments after the <parameter>-R</parameter> to be names of backup files.
            It is for this reason that no other parameter may follow the list of filenames.</para>
          </listitem>

          <listitem>
            <para>There is no formal limit to the number of backup levels, but in practice it will
            rarely make sense to go beyond 3 or 4.</para>
          </listitem>
        </itemizedlist>

        <section id="nbackup-backups-incr-nonfitting">
          <title>Non-connecting links</title>

          <para>What happens if you accidentally leave out a file, or specify a series of files that
          don't all belong together? You could imagine that you specify
          <filename>inventory_2-Mar-2006.nbk</filename> by mistake instead of
          <filename>inventory_3-Mar-2006.nbk</filename> in the above example. Both are level-1
          backup files, so in both cases we get a nice <quote>0, 1, 2</quote> level series. But our
          level-2 file is incremental to the level-1 backup of 3 March, not to the one of 2
          March.</para>

          <para>Fortunately such a mistake can never lead to an incorrectly restored database. Each
          backup file has its own unique ID. Furthermore, each backup file of level 1 or above
          contains the ID of the backup on which it is based. When restoring, nbackup checks these
          IDs; if somewhere in the chain the links don't connect, the operation is cancelled and you
          get an error message.</para>
        </section>
      </section>
    </section>

    <section id="nbackup-backups-rawdevices">
      <title>Backing up raw-device databases</title>

      <para>Firebird databases need not be files; they can also be placed on a so-called
      <firstterm>raw device</firstterm>, for instance a disk partition without a file system. The
      question where the <link linkend="nbackup-backups-workings">delta</link> has to be placed in
      such cases was at first overlooked during the development of
      <application>nbackup</application>. On Posix systems, if the database was located at e.g.
      <filename class="devicefile">/dev/hdb5</filename>, it could happen that the delta was created
      as <filename>/dev/hdb5.delta</filename>. In light of the nature and purpose of the
      <filename>/dev</filename> directory and its often limited available space, this is
      undesirable.</para>

      <para>As of Firebird 2.1, nbackup refuses to operate on raw-device databases unless an
      explicit location for the delta file has been set. The way to do this is discussed in <link
      linkend="nbackup-deltafile"><citetitle>Setting the delta file</citetitle></link>, later on in
      this manual.</para>
    </section>

    <section id="nbackup-backups-dbtriggers">
      <title>Suppressing database triggers (Firebird 2.1+)</title>

      <para>Firebird 2.1 introduced the concept of <firstterm>database triggers</firstterm>. Certain
      types of these triggers can fire upon making or breaking a database connection. As part of the
      backup process, nbackup opens a regular connection to the database (in some versions even more
      than once). To prevent database triggers from firing inadvertently, the new
      <parameter>-T</parameter> switch can be used. Notice that the corresponding switches in
      <application>gbak</application> and <application>isql</application> are called
      <parameter>-nodbtriggers</parameter> (we love diversity, here at Firebird).</para>
    </section>

    <section id="nbackup-backups-directio">
      <title>Direct I/O (Firebird 2.1.4+)</title>

      <para>Originally, nbackup used direct I/O only when making a backup under Windows NT (and
      successors like 2000, 2003 etc.) On all other OS'es, direct I/O was off. This caused problems
      on some Linux systems, so in versions 2.0.6 and 2.1.3 direct I/O was switched on under Linux
      as well. However, this turned out to be problematic for certain other Linux configurations. In
      2.1.4 and 2.5 the original behaviour was restored, but this time as a default that was
      overridable by a newly added parameter: <parameter>-D</parameter>. Its use is as
      follows:</para>

      <blockquote>
        <programlisting>nbackup -B 0 cups.fdb cups.nbk -D on    -- direct I/O on
nbackup -B 0 mugs.fdb mugs.nbk -D off   -- direct I/O off</programlisting>
      </blockquote>

      <para>Just like the option letters themselves, the arguments ON and OFF are
      case-insensitive.</para>

      <para>Direct I/O is only applied when making a backup, not during a restore. Under Windows it
      is realized by setting <constant>FILE_FLAG_NO_BUFFERING</constant>. On other systems,
      <constant>O_DIRECT</constant> and <constant>POSIX_FADV_NOREUSE</constant> are used. The latter
      two are sometimes unavailable; in such cases, they are (or one of them is) silently left out.
      Even if the user specified <parameter>-D</parameter> <parameter>on</parameter> explicitly,
      this doesn't lead to a warning or error message.</para>
    </section>

    <section id="nbackup-backups-inform-options">
      <title>Informational options (Firebird 2.5+)</title>

      <para>Apart from the already mentioned <parameter>-FE</parameter> and
      <parameter>-D</parameter> parameters, Firebird 2.5 also saw the introduction of the following
      two:</para>

      <variablelist>
        <varlistentry>
          <term><parameter>-Z</parameter></term>

          <listitem>
            <para>Shows single-line version information. This option can be used independently, but
            also in combination with other parameters, such as <parameter>-B</parameter>,
            <parameter>-R</parameter>, <parameter>-L</parameter> etc.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><parameter>-?</parameter></term>

          <listitem>
            <para>Shows a summary of nbackup's usage and command-line parameters. Attention: If this
            option is present, all the other parameters are ignored!</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </section>

    <section id="nbackup-backups-remote">
      <title>Backups on remote machines (Firebird 2.5+)</title>

      <para>Nbackup itself only operates on local databases. But in Firebird 2.5 and up,
      nbackup-type backups and restores can also be performed remotely via the Services Manager. For
      this, the program <filename>fbsvcmgr.exe</filename> on the local machine is used; it is
      located in the same folder as <filename>nbackup.exe</filename> and the other Firebird
      command-line tools. The first argument is always
      <quote><replaceable>hostname</replaceable>:<systemitem
      class="service">service_mgr</systemitem></quote>, with <replaceable>hostname</replaceable>
      being the name of the remote server. Other available parameters are:</para>

      <blockquote>
        <programlisting>-user <replaceable>username</replaceable>
-password <replaceable>password</replaceable>
-action_nbak
-action_nrest
-nbk_level <replaceable>n</replaceable>
-dbname <replaceable>database</replaceable>
-nbk_file <replaceable>filename</replaceable>
-nbk_no_triggers
-nbk_direct on|off</programlisting>
      </blockquote>

      <para>Making a full backup on the remote machine <systemitem
      class="systemname">frodo</systemitem> goes like this:</para>

      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nbak -nbk_level 0
  -dbname C:\databases\countries.fdb -nbk_file C:\databases\countries.nbk</programlisting>
      </blockquote>

      <para>And a subsequent incremental backup:</para>

      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nbak -nbk_level 1
  -dbname C:\databases\countries.fdb -nbk_file C:\databases\countries_1.nbk</programlisting>
      </blockquote>

      <para>To restore the whole shebang:</para>

      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nrest -dbname C:\databases\countries_restored.fdb
  -nbk_file C:\databases\countries.nbk -nbk_file C:\databases\countries_1.nbk</programlisting>
      </blockquote>

      <para><emphasis>Notice</emphasis>: Each of the above commands should be typed as a single
      sentence, without line breaks. The hyphens before the parameter names may be omitted, but
      especially with long commands like these it may be helpful to leave them in, so you can easily
      identify the individual parameters (the arguments don't get a hyphen).</para>

      <para>Comments:</para>

      <itemizedlist>
        <listitem>
          <para>The Services Manager always requires authentication, be it automatic (root under
          Posix, trusted under Windows) or explicit through the parameters
          <parameter>-user</parameter> and <parameter>-password</parameter>. The environment
          variables <envar>ISC_USER</envar> and <envar>ISC_PASSWORD</envar> are not used.
          <database>AUTO ADMIN MAPPING</database> in the database has no effect when connecting
          remotely (though this may also depend on the configuration of the network).</para>

          <para>Note: When Windows trusted authentication is in effect, the account name of the user
          on the local machine is passed to the Services Manager on the remote machine. If the owner
          of the remote database is a Windows account (e.g. <systemitem
          class="username">FRODO\PAUL</systemitem>) rather than a Firebird account,
          <emphasis>and</emphasis> the Windows account name on the local machine is the same as the
          owner account name on the remote machine, the caller is acknowledged as the database owner
          and allowed to make a backup. This could pose a security risk, because even on local
          networks user <systemitem class="username">PAUL</systemitem> on one machine is not
          necessarily the same person as user <systemitem class="username">PAUL</systemitem> on
          another machine.</para>
        </listitem>

        <listitem>
          <para>Restoring (<parameter>-action_nrest</parameter>) also requires authentication, but
          once verified the credentials are not used in any way. Hence, the user need not be the
          database owner, <database>SYSDBA</database> or superuser. In the case of Windows trusted
          authentication, the user need not exist at all on the remote machine (where the database
          is located).</para>

          <para>This weak authentication implies another potential security risk. Suppose a
          sensitive database is nbackupped, and the backups are well protected on the filesystem
          level. An average user can't restore the database with nbackup then, because nbackup runs
          in the user process space. But that same user, if he knows name and location of the
          backup, or can guess them by analogy, might be able to get hold of the database by having
          <application>fbsvcmgr</application> restore it to a public folder. After all, fbsvcmgr
          calls the Firebird server, which may have file-level access to the backup. Of course there
          are solutions to this, but it's important to be aware of the risk.</para>
        </listitem>

        <listitem>
          <para>The Services Manager can also be used locally; in that case the first argument
          becomes <parameter>service_mgr</parameter>, without hostname. When used locally,
          <database>AUTO ADMIN MAPPING</database> has the intended effect; this is still true if you
          prepend <literal>localhost:</literal> or the name of the local machine. Local use of the
          Services Manager can be beneficial if you don't have filesystem access to the database
          and/or backup files, but the Firebird server process does. If you do have sufficient
          rights, then it's more practical to use nbackup itself, with its much shorter
          commands.</para>
        </listitem>

        <listitem>
          <para>Specifying <parameter>-nbk_no_triggers</parameter> or
          <parameter>-nbk_direct</parameter> with <parameter>-action_nrest</parameter> leads to an
          error message. Nbackup itself is more lenient here: it simply ignores the
          <parameter>-T</parameter> and <parameter>-D</parameter> parameters if they are used in the
          wrong context.</para>
        </listitem>

        <listitem>
          <para>Instead of a database filename you may also use an alias.</para>
        </listitem>
      </itemizedlist>
    </section>

    <section id="nbackup-backups-pract">
      <title>A practical application</title>

      <para>An nbackup-based incremental backup scheme could look like this:</para>

      <itemizedlist spacing="compact">
        <listitem>
          <para>Each month a full backup (level 0) is made;</para>
        </listitem>

        <listitem>
          <para>Each week a level-1;</para>
        </listitem>

        <listitem>
          <para>A level-2 backup daily;</para>
        </listitem>

        <listitem>
          <para>A level-3 backup hourly.</para>
        </listitem>
      </itemizedlist>

      <para>As long as all backups are preserved, you can restore the database to its state at any
      hour in the past. For each restore action, a maximum of four backup files is used. Of course
      you schedule things in such a way that the bigger, time-consuming backups are made during
      off-peak hours. In this case the levels 0 and 1 could be made at weekends, and level 2 at
      night.</para>

      <para>If you don't want to keep everything for eternity, you can add a deletion
      schedule:</para>

      <itemizedlist spacing="compact">
        <listitem>
          <para>Level-3 backups are deleted after 8 days;</para>
        </listitem>

        <listitem>
          <para>Level-2s after a month;</para>
        </listitem>

        <listitem>
          <para>Level-1s after six months;</para>
        </listitem>

        <listitem>
          <para>Full backups after two years, but the first one of each year is kept.</para>
        </listitem>
      </itemizedlist>

      <para>This is only an example of course. What's useful in an individual case depends on the
      application, the size of the database, its activity, etc.</para>
    </section>

    <section id="nbackup-backups-readon">
      <title>Read on?</title>

      <para>At this point you know everything you need in order to make and restore full and/or
      incremental backups with nbackup. You only need to read any further if you want to use backup
      tools of your own choice for your Firebird databases (see <link
      linkend="nbackup-lock-unlock"><citetitle>Locking and unlocking</citetitle></link>), or if you
      want to override the default name or location of the delta file (see <link
      linkend="nbackup-deltafile"><citetitle>Setting the delta file</citetitle></link>).</para>

      <para>If you have no craving for any of that: good luck in your work with nbackup!</para>
    </section>
  </section>

  <section id="nbackup-lock-unlock">
    <title>Locking and unlocking</title>

    <para>If you prefer to use your own backup tools or just make a file copy, nbackup's lock-unlock
    mode comes into view. <quote>Locking</quote> means here that the main database file is frozen
    temporarily, not that no changes can be made to the database. Just like in backup mode,
    mutations are directed to a temporary delta file; upon unlocking, the delta file is merged with
    the main file.</para>

    <para>As a reminder: <filename>nbackup.exe</filename> lives in the <filename
    class="directory">bin</filename> subdir of your Firebird folder. Typical locations are e.g.
    <filename class="directory">C:\Program Files\Firebird\Firebird_2_0\bin</filename> (Windows) or
    <filename class="directory">/opt/firebird/bin</filename> (Linux). There's no GUI; you launch it
    from the command prompt or call it from within a batch file or application.</para>

    <section id="nbackup-lock-and-backup">
      <title>Locking the database and making the backup yourself</title>

      <para>A typical session in which you make your own backup goes as follows:</para>

      <procedure>
        <step>
          <para>Lock the database with the <parameter>-L</parameter> (lock) switch:</para>

          <blockquote>
            <programlisting>nbackup [-U <replaceable>&lt;user&gt;</replaceable> -P <replaceable>&lt;password&gt;</replaceable>] -L <replaceable>&lt;database&gt;</replaceable></programlisting>
          </blockquote>
        </step>

        <step>
          <para>Now copy/backup/zip the database file to your heart's content, with your own choice
          of tools. A simple file copy is also possible.</para>
        </step>

        <step>
          <para>Unlock the database with <parameter>-N</parameter> (uNlock):</para>

          <blockquote>
            <programlisting>nbackup [-U <replaceable>&lt;user&gt;</replaceable> -P <replaceable>&lt;password&gt;</replaceable>] -N <replaceable>&lt;database&gt;</replaceable></programlisting>
          </blockquote>
        </step>
      </procedure>

      <para>The last command will also cause any mutations - which have been written to the delta
      file - to be merged into the main file.</para>

      <para>The backup you made contains the data as they were at the moment the database was
      locked, regardless how long the locked state has lasted, and regardless how long you may have
      waited before making the actual backup.</para>

      <para>Comments:</para>

      <itemizedlist>
        <listitem>
          <para>Instead of a database filename you may also specify an alias.</para>
        </listitem>

        <listitem>
          <para>The <parameter>-U</parameter> and <parameter>-P</parameter> parameters may be
          omitted if the envars <envar>ISC_USER</envar> and <envar>ISC_PASSWORD</envar> are set, if
          you are root on a Posix system, or if trusted authentication under Windows permits it. For
          a detailed description see the <link linkend="nbackup-backups-nologin">comments under
          <citetitle>Making full backups</citetitle></link>.</para>
        </listitem>

        <listitem>
          <para>Starting with Firebird 2.5, instead of <parameter>-P</parameter>
          <replaceable>&lt;password&gt;</replaceable> you may also use <parameter>-FE</parameter>
          <replaceable>&lt;filename&gt;</replaceable>.</para>
        </listitem>

        <listitem>
          <para>Both <parameter>-L</parameter> and <parameter>-N</parameter> make a regular
          connection to the database, so in Firebird 2.1 and above it may be wise to add the
          <parameter>-T</parameter> parameter (see <link
          linkend="nbackup-backups-dbtriggers"><citetitle>Suppressing database
          triggers</citetitle></link>).</para>
        </listitem>

        <listitem>
          <para>If you're locking a raw-device database with Firebird 2.1 or above, the
          <parameter>-S</parameter> option can be very helpful; see <link
          linkend="nbackup-lock-unlock-rawdevices"><citetitle>Locking raw-device
          databases</citetitle></link>.</para>
        </listitem>

        <listitem>
          <para>You can optionally add <parameter>-Z</parameter> to have version information printed
          on the first line of the output.</para>
        </listitem>
      </itemizedlist>

      <warning>
        <para>What goes for backup/restore also applies to the lock/unlock switches: do not use them
        on multi-file databases. Until things have changed, don't let nbackup loose on multi-file
        databases at all!</para>
      </warning>
    </section>

    <section id="nbackup-restore-and-fixup">
      <title>Restoring a backup made after <quote>nbackup -L</quote></title>

      <para>An copy of a locked database is itself a locked database too, so you can't just copy it
      back and start using it. Should your original database get lost or damaged and the self-made
      copy needs to be restored (or should you wish to install the copy on another machine), proceed
      like this:</para>

      <procedure>
        <step>
          <para>Copy/restore/unzip the backed-up database file yourself with the necessary
          tools.</para>
        </step>

        <step>
          <para>Now unlock the database, <emphasis>not</emphasis> with the <parameter>-N</parameter>
          switch, but with <parameter>-F</parameter> (fixup):</para>

          <blockquote>
            <programlisting>nbackup -F <replaceable>&lt;database&gt;</replaceable></programlisting>
          </blockquote>

          <para>Here too, you can optionally use an alias instead of a filename, and add
          <parameter>-Z</parameter> for version info. Other options make no sense.</para>
        </step>
      </procedure>

      <para>Why are there two unlock switches, <parameter>-N</parameter> and
      <parameter>-F</parameter>?</para>

      <itemizedlist spacing="compact">
        <listitem>
          <para><parameter>-N</parameter> first sees that any changes made since the locking by
          <parameter>-L</parameter> are merged into the main database file. After that, the database
          goes back into normal read/write mode and the temporary file is deleted.</para>
        </listitem>

        <listitem>
          <para><parameter>-F</parameter> only changes the state flag of the user-restored database
          to <quote>normal</quote>.</para>
        </listitem>
      </itemizedlist>

      <para>So you use:</para>

      <itemizedlist spacing="compact">
        <listitem>
          <para><parameter>-N</parameter> after having <emphasis>made</emphasis> a copy/backup
          yourself (to reverse the <parameter>-L</parameter> issued earlier);</para>
        </listitem>

        <listitem>
          <para><parameter>-F</parameter> after having <emphasis>restored</emphasis> such a backup
          yourself.</para>
        </listitem>
      </itemizedlist>

      <note>
        <para>It is a bit unfortunate that the last switch should be called
        <parameter>-F</parameter> for Fixup. After all, it doesn't fix anything; it only
        <emphasis>unlocks</emphasis> the database. The <parameter>-N</parameter> (uNlock) flag on
        the other hand performs not only an unlock, but also a fixup (integration of mutations into
        the main file). But we'll have to live with that. Come to think of it: you
        <emphasis>can</emphasis> read <parameter>-F</parameter> as
        <emphasis>Flag-only</emphasis>.</para>
      </note>
    </section>

    <section id="nbackup-lock-unlock-extrainfo">
      <title>Under the hood</title>

      <para>Note: This section doesn't contain any necessary knowledge, but provides some extra
      information which could deepen your understanding of the various switches.</para>

      <!--These two orderedlists should really be procedures, but I want compact spacing!-->

      <para><command>nbackup <parameter>-L</parameter></command> does the following:</para>

      <orderedlist spacing="compact">
        <listitem>
          <para>Connect to the database;</para>
        </listitem>

        <listitem>
          <para>Start a transaction;</para>
        </listitem>

        <listitem>
          <para>Call ALTER DATABASE BEGIN BACKUP (this statement has been discussed in the <link
          linkend="nbackup-backups-workings">extra information on nbackup -B</link>);</para>
        </listitem>

        <listitem>
          <para>Commit the transaction;</para>
        </listitem>

        <listitem>
          <para>Disconnect from the database.</para>
        </listitem>
      </orderedlist>

      <para><command>nbackup <parameter>-N</parameter></command> follows the same steps, but with
      <quote><database>...END BACKUP</database></quote> in step 3.</para>

      <para><command>nbackup <parameter>-F</parameter></command> works as follows:</para>

      <orderedlist spacing="compact">
        <listitem>
          <para>The restored database file is opened;</para>
        </listitem>

        <listitem>
          <para>Within the file, the state flag is changed from locked
          (<constant>nbak_state_stalled</constant>) to normal
          (<constant>nbak_state_normal</constant>);</para>
        </listitem>

        <listitem>
          <para>The file is closed again.</para>
        </listitem>
      </orderedlist>

      <note>
        <para>nbackup <parameter>-F</parameter> operates purely on file level and can therefore also
        be performed without a Firebird server running. Any credentials supplied via the
        <parameter>-U</parameter>, <parameter>-P</parameter> or <parameter>-FE</parameter>
        parameters are ignored, just as with nbackup <parameter>-R</parameter>.</para>
      </note>
    </section>

    <section id="nbackup-lock-unlock-rawdevices">
      <title>Locking raw-device databases</title>

      <para>As discussed in <link linkend="nbackup-backups-rawdevices"><citetitle>Backing up
      raw-device databases</citetitle></link>, problems can arise if a delta has to be created for a
      database located on a raw device. Therefore, in Firebird 2.1 and up, nbackup refuses to
      operate on raw-device databases unless an explicit location for the delta file has been set
      previously. For the procedure, see <link linkend="nbackup-deltafile"><citetitle>Setting the
      delta file</citetitle></link>, a little further down.</para>

      <para>There's also another problem if you lock and copy a raw device: you don't know the
      actual size of the database! The raw device may be 10 GB, but the database might only take up
      200 MB of that space. To prevent having to copy the entire device just to be on the safe side
      – possibly wasting huge amounts of time and space – Firebird 2.1 has introduced a new
      parameter for nbackup: <parameter>-S</parameter>. This parameter is only valid in combination
      with <parameter>-L</parameter> and when it is present, nbackup writes the database size in
      pages to <systemitem>stdout</systemitem> after locking the database. Because the size is given
      in pages, it has to be multiplied by the database page size in order to get the actual number
      of bytes to be copied. Or, if you use the <filename>dd</filename> copy utility, you could
      specify the page size as <parameter>(i)bs</parameter> and the output of
      <filename>nbackup</filename> <parameter>-L</parameter> <parameter>-S</parameter> as
      <parameter>count</parameter>.</para>
    </section>
  </section>

  <section id="nbackup-deltafile">
    <title>Setting the delta file</title>

    <para>By default, the delta file lives in the same directory as the database itself. The file
    name is also the same, but with <filename class="extension">.delta</filename> appended. This is
    usually not a problem, but sometimes it is desirable or even necessary to change the location,
    e.g. when the database is stored on a raw device. Nbackup itself has no provision for setting
    the location; this must be done through SQL.</para>

    <para>Make a connection to the database with any client that allows you to enter your own SQL
    statements and give the command:</para>

    <blockquote>
      <programlisting>alter database add difference file '<replaceable>path-and-filename</replaceable>'</programlisting>
    </blockquote>

    <para>The custom delta file specification is persistent in the database; it is stored in the
    system table <database>RDB$FILES</database>. To revert to the default behaviour, issue the
    following statement:</para>

    <blockquote>
      <programlisting>alter database drop difference file</programlisting>
    </blockquote>

    <para>You can also specify a custom delta location while creating a new database:</para>

    <blockquote>
      <programlisting>create database '<replaceable>path-and-dbname</replaceable>' difference file '<replaceable>path-and-deltaname</replaceable>'</programlisting>
    </blockquote>

    <note>
      <title>Notes</title>

      <itemizedlist>
        <listitem>
          <para>If you specify a bare file name with <database>[ADD] DIFFERENCE FILE</database>, the
          delta will likely <emphasis>not</emphasis> be created in the same directory as the
          database, but in the current directory as seen from the server. On Windows this may e.g.
          be the system directory. The same logic applies to relative paths.</para>
        </listitem>

        <listitem>
          <para>The entire directory path must already exist. Firebird doesn't attempt to create any
          missing directories.</para>
        </listitem>

        <listitem>
          <para>If you want to change your custom delta specification, you must first
          <database>DROP</database> the old one and then <database>ADD</database> the new
          one.</para>
        </listitem>
      </itemizedlist>
    </note>
  </section>

  <section id="nbackup-backuphistory">
    <title>Backup history</title>

    <para>The firebird database keeps a history of all nbackup activity in the system table
    <database class="table">RDB$BACKUP_HISTORY</database>. This information is used by nbackup
    itself for internal housekeeping, but can also be used to find out when the last backup was
    done, on which level and what the filename is.</para>

    <para>For example, to see the last 5 backups you can use:</para>

    <blockquote>
      <programlisting language="sql">SELECT RDB$BACKUP_ID, RDB$TIMESTAMP, RDB$BACKUP_LEVEL, RDB$GUID, 
    RDB$SCN, RDB$FILE_NAME
FROM RDB$BACKUP_HISTORY
ORDER BY RDB$TIMESTAMP DESC
ROWS 5</programlisting>
    </blockquote>

    <para>The columns of <database class="table">RDB$BACKUP_HISTORY</database> are:</para>

    <para><informaltable>
        <tgroup cols="2">
          <thead>
            <row>
              <entry>Column</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><database class="field">RDB$BACKUP_ID</database></entry>

              <entry>Primary key</entry>
            </row>

            <row>
              <entry><database class="field">RDB$TIMESTAMP</database></entry>

              <entry>Time and date of backup</entry>
            </row>

            <row>
              <entry><database class="field">RDB$BACKUP_LEVEL</database></entry>

              <entry>Backup level</entry>
            </row>

            <row>
              <entry><database class="field">RDB$GUID</database></entry>

              <entry>GUID of the backup (used to check dependencies between files)</entry>
            </row>

            <row>
              <entry><database class="field">RDB$SCN</database></entry>

              <entry>Highest page marker in the backup</entry>
            </row>

            <row>
              <entry><database class="field">RDB$FILE_NAME</database></entry>

              <entry>Filename of the backup</entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable></para>

    <para>For an explanation of the field <database class="field">RDB$SCN</database> see the section
    <xref endterm="nbackup-background-title" linkend="nbackup-background"/>.</para>

    <para>The contents of the table <database class="table">RDB$BACKUP_HISTORY</database> are not
    backed up and restored by gbak; see the section <xref endterm="nbackup-background-title"
    linkend="nbackup-background"/> for details.</para>
  </section>

  <section id="nbackup-background">
    <title id="nbackup-background-title">Technical background information</title>

    <para>Nbackup performs a physical backup of the database pages by copying pages that have been
    modified since the last backup of the immediately preceding level. A level <literal>0</literal>
    backup copies all pages, while a level <literal>1</literal> copies only those pages that have
    been modified after the most recent level <literal>0</literal>. To be able to find the modified
    pages, Firebird uses a marker that is called the <firstterm>SCN</firstterm> (short for page
    scan). This number is incremented at each backup state change. For each backup with nbackup
    there are three state changes:</para>

    <orderedlist>
      <listitem>
        <para><constant>nbak_state_normal</constant> (no backup) to
        <constant>nbak_state_stalled</constant> (database writes to delta file)</para>
      </listitem>

      <listitem>
        <para><constant>nbak_state_stalled</constant> to <constant>nbak_state_merge</constant>
        (merging delta file back into database)</para>
      </listitem>

      <listitem>
        <para><constant>nbak_state_merge</constant> to <constant>nbak_state_normal</constant> (no
        backup)</para>
      </listitem>
    </orderedlist>

    <note>
      <para>These three state changes occur even if the backup fails.</para>
    </note>

    <para>The SCN of the database before the start of the backup is recorded together with the
    backup. The very first backup gets SCN <literal>0</literal>, the second <literal>3</literal>,
    etc. This number is independent from the level of the backup. The SCN is used to mark the pages
    of a database. So for example:</para>

    <informaltable colsep="0" frame="none" rowsep="0">
      <tgroup cols="2">
        <colspec colwidth="*"/>

        <colspec colwidth="15*"/>

        <thead>
          <row>
            <entry>SCN</entry>

            <entry>Explanation</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry><literal>0</literal></entry>

            <entry>Pages before any backup</entry>
          </row>

          <row>
            <entry><literal>1</literal></entry>

            <entry>Pages written/updated into the delta file during the backup</entry>
          </row>

          <row>
            <entry><literal>2</literal></entry>

            <entry>Pages written/updated during the merge of delta file into main backup</entry>
          </row>

          <row>
            <entry><literal>3</literal></entry>

            <entry>Pages written/updated after ending first backup+merge</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>

    <para>When a level <literal>1</literal> backup is made, nbackup looks for the last level
    <literal>0</literal> backup and backs up all pages with an SCN higher than the SCN of that level
    <literal>0</literal> backup (and so on).</para>

    <para>A backup and restore with gbak does not restore the content of the <database
    class="table">RDB$BACKUP_HISTORY</database> table and it resets the SCN of all pages back to
    <literal>0</literal>. The reason for this is that gbak creates a logical backup instead of a
    physical backup. So a restore using gbak will rewrite the entire database (and can even change
    the page size). This renders previous backups with nbackup meaningless as a starting point for
    subsequent backups: you need to start with a fresh level <literal>0</literal>.</para>
  </section>

  <appendix id="nbackup-dochist">
    <title>Document history</title>

    <para>The exact file history is recorded in the <filename class="directory">manual</filename>
    module in our CVS tree; see <ulink
    url="http://firebird.cvs.sourceforge.net/viewvc/firebird/manual/src/docs/firebirddocs/nbackup.xml?view=log">http://firebird.cvs.sourceforge.net/viewvc/firebird/manual/src/docs/firebirddocs/nbackup.xml?view=log</ulink></para>

    <para><revhistory>
        <revision>
          <revnumber>0.1</revnumber>

          <date>21 Oct 2005</date>

          <authorinitials>PV</authorinitials>

          <revdescription>
            <para>First edition.</para>
          </revdescription>
        </revision>

        <revision>
          <revnumber>1.0</revnumber>

          <date>1 Dec 2006</date>

          <authorinitials>PV</authorinitials>

          <revdescription>
            <para>Removed <quote>beta</quote> reference in edition info. Changed warning against
            specifying backup file names interactively with nbackup -R. Removed <quote>(or will
            be)</quote> from first sentence in Document History.</para>

            <para>Changed <literal>C:\Databases</literal> to <literal>C:\Data</literal> in the
            examples, just to keep the lines from running out of the shaded <sgmltag
            class="starttag">screen</sgmltag> areas in the PDF.</para>

            <para>Added section <citetitle>Setting the delta file</citetitle>, and changed section
            <citetitle>Read on?</citetitle> accordingly.</para>
          </revdescription>
        </revision>

        <revision>
          <revnumber>1.1</revnumber>

          <date>5 May 2008</date>

          <authorinitials>PV</authorinitials>

          <revdescription>
            <para><citetitle>Making and restoring backups</citetitle>: Added warning about
            heavy-load risks with nbackup 2.0.0–2.0.3.</para>

            <para><citetitle>Restoring a full backup</citetitle>: Corrected wrong statement that
            nbackup will overwrite an existing database if there are no active connections. Changed
            italic text about interactive restore failure to a Note and mentioned its fix in
            2.0.1.</para>

            <para><citetitle>Incremental backups</citetitle>: Inserted warning that incremental
            backups are broken in 2.1.</para>

            <para><citetitle>Suppressing database triggers (Firebird 2.1+)</citetitle>: New
            section.</para>

            <para><citetitle>Read on?</citetitle>: Fixed typo (you -&gt; your).</para>
          </revdescription>
        </revision>

        <revision>
          <revnumber>1.2</revnumber>

          <date>19 Sep 2011</date>

          <authorinitials>PV</authorinitials>

          <revdescription>
            <para>Document source formatting: Changed max. line length to 100, without open
            lines.</para>

            <para>All sections and subsections now have an <sgmltag>id</sgmltag>.</para>

            <para><citetitle>Introduction</citetitle>: Edited first sentence.</para>

            <para><citetitle>Nbackup features - an overview</citetitle>: First sentence: groups
            -&gt; kinds. Edited last para before first subsection: mentioned that only
            <database>SYSDBA</database>, owner and sometimes OS admins can make a backup.</para>

            <para><citetitle>Nbackup features - an overview :: Limitations of nbackup</citetitle>:
            Edited previously last listitem to mention Services Manager. Added listitem about direct
            file access. Removed last para.</para>

            <para><citetitle>Functions and parameters</citetitle>: New section.</para>

            <para><citetitle>Making and restoring backups</citetitle>: Slightly altered last
            sentence of first para. Extended warning: added info on the role of direct I/O with
            large databases under Posix.</para>

            <para><citetitle>Making and restoring backups :: Full backups :: Making full
            backups</citetitle>: Corrected and extended listitem on <parameter>-U</parameter> and
            <parameter>-P</parameter> parameters. Added listitems on <parameter>-FE</parameter>
            parameter (new in 2.5), <parameter>-T</parameter> parameter (new in 2.1) and
            <parameter>-D</parameter> parameter (new in 2.5, backport to 2.1.4). In listitem
            starting with <quote>The different parameters</quote>, the parenthesized text now reads
            (<parameter>-B</parameter>, <parameter>-U</parameter> etc.), because many new parameters
            have been added.</para>

            <para><citetitle>Making and restoring backups :: A word on the inner
            workings</citetitle>: Small edit (image -&gt; impression).</para>

            <para><citetitle>Making and restoring backups :: Full backups :: Restoring a full
            backup</citetitle>: Removed parameters <parameter>-U</parameter> and
            <parameter>-P</parameter> from specification. Added listitem on aliases. Changed
            separate Note about interactive restore failure back to italic text inside the listitem
            itself. Added listitem about non-necessity of running server and ignoring
            credentials.</para>

            <para><citetitle>Making and restoring backups :: Incremental backups</citetitle>: Edited
            Warning: mentioned fix in 2.1.1.</para>

            <para><citetitle>Making and restoring backups :: Incremental backups :: Restoring
            incremental backups</citetitle>: Removed parameters <parameter>-U</parameter> and
            <parameter>-P</parameter> from formal syntax and 1st listitem.</para>

            <para><citetitle>Making and restoring backups :: Backing up raw-device
            databases</citetitle>: New section.</para>

            <para><citetitle>Making and restoring backups :: Suppressing database
            triggers</citetitle>: Edited and extended this section, but removed the
            <quote><database>SYSDBA</database> and owner only</quote> remark.</para>

            <para><citetitle>Making and restoring backups :: Direct I/O (Firebird
            2.1.4+)</citetitle>: New section.</para>

            <para><citetitle>Making and restoring backups :: Informational options (Firebird
            2.5+)</citetitle>: New section.</para>

            <para><citetitle>Making and restoring backups :: Backups on remote machines (Firebird
            2.5+)</citetitle>: New section.</para>

            <para><citetitle>Locking and unlocking</citetitle>: Slightly altered last sentence of
            second para.</para>

            <para><citetitle>Locking and unlocking :: Locking the database and backing up
            yourself</citetitle>: Added Comments (para + itemizedlist).</para>

            <para><citetitle>Locking and unlocking :: Restoring a backup made after <quote>nbackup
            -L</quote></citetitle>: Added info on use of alias and <parameter>-Z</parameter> to step
            2 of procedure. In next para, translated <quote>en</quote> (leftover from Dutch
            original) -&gt; <quote>and</quote>. Added sentence to Note about reading
            <parameter>-F</parameter> as Flag-only.</para>

            <para><citetitle>Locking and unlocking :: Locking raw-device databases</citetitle>: New
            section.</para>

            <para><citetitle>Locking and unlocking :: Under the hood</citetitle>: Edited
            Note.</para>

            <para><citetitle>Setting the delta file</citetitle>: 1st para largely rewritten; now
            refers to raw-device databases. Split off last sentence into a para of its own. Added
            info (para + programlisting) about setting delta with <database>CREATE
            DATABASE</database>. 1st listitem in Notes: <database>ADD</database> -&gt;
            <database>[ADD]</database>.</para>

            <para><citetitle>Document history</citetitle>: Changed ulink to CVS (both text and url);
            now points directly to document.</para>

            <para><citetitle>License notice</citetitle>: End year in copyright mention now
            2011.</para>
          </revdescription>
        </revision>

        <revision>
          <revnumber>1.3</revnumber>

          <date>12 Oct 2011</date>

          <authorinitials>PV</authorinitials>

          <revdescription>
            <para><citetitle>Functions and parameters</citetitle>: In first table: self-restored
            -&gt; user-restored. In second table: self-restore -&gt; user restore.</para>

            <para><citetitle>Locking and unlocking :: Locking the database and backing up
            yourself</citetitle>: Section renamed <citetitle>Locking the database and making the
            backup yourself</citetitle>.</para>

            <para><citetitle>Locking and unlocking :: Restoring a backup made after <quote>nbackup
            -L</quote></citetitle>: 2nd listitem in 1st itemizedlist: self-restored -&gt;
            user-restored.</para>
          </revdescription>
        </revision>

        <revision>
          <revnumber>1.4</revnumber>

          <date>18 Sep 2014</date>

          <authorinitials>MR</authorinitials>

          <revdescription>
            <para><citetitle>Backup history</citetitle>: New section</para>

            <para><citetitle>Technical background information</citetitle> New section</para>
          </revdescription>
        </revision>
      </revhistory></para>
  </appendix>

  <appendix id="nbackup-license">
    <title>License notice</title>

    <para>The contents of this Documentation are subject to the Public Documentation License Version
    1.0 (the <quote>License</quote>); you may only use this Documentation if you comply with the
    terms of this License. Copies of the License are available at <ulink
    url="http://www.firebirdsql.org/pdfmanual/pdl.pdf">http://www.firebirdsql.org/pdfmanual/pdl.pdf</ulink>
    (PDF) and <ulink
    url="http://www.firebirdsql.org/manual/pdl.html">http://www.firebirdsql.org/manual/pdl.html</ulink>
    (HTML).</para>

    <para>The Original Documentation is titled <citetitle>Firebird's nbackup
    tool</citetitle>.</para>

    <para>The Initial Writer of the Original Documentation is: Paul Vinkenoog.</para>

    <para>Copyright (C) 2005–2011. All Rights Reserved. Initial Writer contact: &lt;firstname&gt; at
    &lt;lastname&gt; dot nl.</para>

    <para>Contributor(s): Mark Rotteveel</para>
  </appendix>
</article>
