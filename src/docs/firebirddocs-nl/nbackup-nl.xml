<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
    "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<article id="nbackup-nl" lang="nl">
  <articleinfo>
    <title>Firebirds nbackup-tool</title>
    <author>
      <firstname>Paul</firstname>
      <surname>Vinkenoog</surname>
    </author>
    <edition>19 sep 2011 — Documentversie 1.2-nl</edition>
  </articleinfo>
  <section id="nbackup-nl-intro">
    <title>Inleiding</title>
    <para><firstterm>Nbackup</firstterm> is een backupprogramma dat met Firebird wordt meegeleverd
    sinds versie 2.0. Het biedt mogelijkheden die het al langer bestaande
    <firstterm>gbak</firstterm> niet heeft, maar is geen vervanging voor deze oudere tool. Beide
    programma's hebben hun sterke en zwakke punten; vooralsnog zullen ze naast elkaar blijven
    bestaan.</para>
  </section>
  <section id="nbackup-nl-overzicht">
    <title>Kenmerken van nbackup – een overzicht</title>
    <titleabbrev>Kenmerken van nbackup</titleabbrev>
    <para>Met nbackup kunnen twee verschillende soorten taken worden uitgevoerd:</para>
    <orderedlist>
      <listitem>
        <para>Het maken en terugzetten van zowel volledige als aanvullende backups. Een aanvullende
        backup (Engelse term: <firstterm>incremental backup</firstterm>) bevat alleen de wijzigingen
        sinds een bepaalde voorgaande backup.</para>
      </listitem>
      <listitem>
        <para>Het vergrendelen van het databasebestand zodat het vervolgens met kopieer- of
        backuptools naar keuze kan worden gebackupt. In deze modus maakt nbackup dus géén backup;
        het zorgt alleen dat je er zelf een kunt maken zonder risico op corruptie van de database.
        Ook hierbij is er een voorziening voor terugzetten.</para>
      </listitem>
    </orderedlist>
    <para>Beide modi kunnen op een actieve database worden toegepast, zonder hinder voor verbonden
    gebruikers. De gemaakte backup komt steeds overeen met de toestand van de database <emphasis>aan
    het begin van de operatie</emphasis>. Voorts geldt dat een backup alleen door de eigenaar en
    <database>SYSDBA</database> (en soms ook door OS-admins) kan worden gemaakt, maar dat iedere
    gebruiker een backup kan terugzetten naar een nieuwe database. Op deze punten is er dus geen
    verschil met gbak.</para>
    <section id="nbackup-nl-voordelen">
      <title>Voordelen van nbackup</title>
      <itemizedlist>
        <listitem>
          <para><emphasis>Beide modi:</emphasis> een hoge snelheid (zo hoog als hardware en
          besturingssysteem toelaten), want nbackup kijkt niet naar de data zelf. In de backupmodus
          worden de gegevens min of meer blindelings naar het backupbestand geschreven.</para>
        </listitem>
        <listitem>
          <para><emphasis>Backup-restoremodus:</emphasis> tijd- en ruimtewinst, want er is niet elke
          keer een volledige backup nodig. Dit kan enorm schelen bij omvangrijke databases.</para>
        </listitem>
        <listitem>
          <para><emphasis>Vergrendel-ontgrendelmodus:</emphasis> volledige vrijheid in de keuze van
          de backup-, kopieer- en/of compressietools.</para>
        </listitem>
      </itemizedlist>
    </section>
    <section id="nbackup-nl-beperkingen">
      <title>Beperkingen van nbackup</title>
      <itemizedlist>
        <listitem>
          <para>Nbackup zorgt niet voor het opschonen en verdichten van de database zoals gbak dat
          doet.</para>
        </listitem>
        <listitem>
          <para>Met een nbackup backup-restorecyclus kun je niet de eigenaar van de database
          veranderen, zoals met gbak.</para>
        </listitem>
        <listitem>
          <para>Nbackup kan geen <firstterm>transporteerbare backups</firstterm> maken, d.w.z.
          backups die je kunt terugzetten op een ander platform of andere serverversie.</para>
        </listitem>
        <listitem>
          <para>Nbackup is vooralsnog alleen bruikbaar voor databases die uit een enkel bestand
          bestaan.</para>
        </listitem>
        <listitem>
          <para>Nbackup zelf kan alleen lokale databases backuppen en terugzetten. Wel is het vanaf
          Firebird 2.5 mogelijk om via de Services Manager deze functies ook op verre machines uit
          te voeren.</para>
        </listitem>
        <listitem>
          <para>Behalve bij gebruik van de Services Manager (in Firebird 2.5+) moet de gebruiker
          voor het maken van een backup met nbackup rechtstreekse bestandstoegang tot de database
          hebben. Met gbak is dit niet nodig.</para>
        </listitem>
      </itemizedlist>
    </section>
  </section>
  <section id="nbackup-nl-functies-params">
    <title>Functies en parameters</title>
    <para>Hieronder volgt een overzicht van nbackups parameters. Als het veld <quote>Sinds</quote>
    leeg is, bestaat de parameter al vanaf de eerste versie van nbackup, in Firebird 2.0.</para>
    <table id="nbackup-nl-tbl-params">
      <title>Parameters van nbackup</title>
      <tgroup cols="3">
        <colspec colname="kolParam" colwidth="4*" />
        <colspec colname="kolFunctie" colwidth="5*" />
        <colspec colname="kolSinds" colwidth="1*" />
        <thead>
          <row>
            <entry align="center">Parameter</entry>
            <entry align="center">Functie</entry>
            <entry align="center">Sinds</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>-B <replaceable>n</replaceable> <replaceable>&lt;database&gt;</replaceable>
            [<replaceable>&lt;bestand&gt;</replaceable>]</entry>
            <entry>Backup database naar bestand, niveau <replaceable>n</replaceable></entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-R <replaceable>&lt;database&gt;</replaceable>
            [<replaceable>&lt;bestand&gt;</replaceable> ...]</entry>
            <entry>Herstel database vanuit bestand(en)</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-L <replaceable>&lt;database&gt;</replaceable></entry>
            <entry>Vergrendel database</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-N <replaceable>&lt;database&gt;</replaceable></entry>
            <entry>Ontgrendel vergrendelde database</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-F <replaceable>&lt;database&gt;</replaceable></entry>
            <entry>Ontgrendel zelf teruggezette database</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-S</entry>
            <entry>Geef grootte in pagina's (bij -L)</entry>
            <entry>2.1</entry>
          </row>
          <row>
            <entry>-T</entry>
            <entry>Onderdruk databasetriggers (bij -B, -L, -N)</entry>
            <entry>2.1</entry>
          </row>
          <row>
            <entry>-D on|off</entry>
            <entry>Rechtstreekse I/O aan/uit (bij -B)</entry>
            <entry>2.1.4</entry>
          </row>
          <row>
            <entry>-U <replaceable>&lt;naam&gt;</replaceable></entry>
            <entry>Geef gebruikersnaam op (bij -B, -L, -N)</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-P <replaceable>&lt;wachtwoord&gt;</replaceable></entry>
            <entry>Geef wachtwoord op (bij -B, -L, -N)</entry>
            <entry>&nbsp;</entry>
          </row>
          <row>
            <entry>-FE <replaceable>&lt;bestand&gt;</replaceable></entry>
            <entry>Lees wachtwoord uit bestand (bij -B, -L, -N)</entry>
            <entry>2.5</entry>
          </row>
          <row>
            <entry>-Z</entry>
            <entry>Toon versie-info (los of bij -B, -R, -L, -N, -F)</entry>
            <entry>2.5</entry>
          </row>
          <row>
            <entry>-?</entry>
            <entry>Help (schakelt alle andere opties uit)</entry>
            <entry>2.5</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <para>Parameters van nbackup zijn niet hoofdlettergevoelig. Alle parameters zullen uitgebreid
    worden besproken in het vervolg van deze handleiding.</para>
    <para>Afhankelijk van de gebruikte hoofdfunctie (<parameter>-B</parameter>,
    <parameter>-R</parameter>, <parameter>-L</parameter>, <parameter>-N</parameter> of
    <parameter>-F</parameter>) kan nbackup verschillende typen toegang tot de database nodig hebben:
    een verbinding via de Firebirdserver, rechtstreekse bestandstoegang, of beide. Hieronder een
    overzicht:</para>
    <table id="nbackup-nl-tbl-access">
      <title>Benodigde toegang</title>
      <tgroup cols="3">
        <colspec colname="kolParam" colwidth="1*" />
        <colspec colname="kolFunctie" colwidth="3*" />
        <colspec colname="kolToegang" colwidth="3*" />
        <thead>
          <row>
            <entry align="center">Parameter</entry>
            <entry align="center">Functie</entry>
            <entry align="center">Toegang</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>-B</entry>
            <entry>Backup</entry>
            <entry>server + bestand</entry>
          </row>
          <row>
            <entry>-R</entry>
            <entry>Herstel</entry>
            <entry>bestand</entry>
          </row>
          <row>
            <entry>-L</entry>
            <entry>Vergrendel</entry>
            <entry>server</entry>
          </row>
          <row>
            <entry>-N</entry>
            <entry>Ontgrendel na -L</entry>
            <entry>server</entry>
          </row>
          <row>
            <entry>-F</entry>
            <entry>Ontgrendel na zelf terugzetten</entry>
            <entry>bestand</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <para>Waar servertoegang nodig is (bij <parameter>-B</parameter>, <parameter>-L</parameter> en
    <parameter>-N</parameter>), moet de gebruiker ofwel een naam en wachtwoord opgeven (met
    <parameter>-U</parameter> en <parameter>-P</parameter>/<parameter>-FE</parameter> of via de
    omgevingsvariabelen <envar>ISC_USER</envar> en <envar>ISC_PASSWORD</envar>), ofwel op andere
    gronden door de server worden toegelaten (bijv. als root onder Posix of door <quote>trusted
    authentication</quote> onder Windows).</para>
    <para>Waar bestandstoegang nodig is (bij <parameter>-B</parameter>, <parameter>-R</parameter> en
    <parameter>-F</parameter>), moet de gebruiker voldoende lees- en/of schrijfrechten hebben op het
    databasebestand.</para>
    <para>Waar alléén bestandstoegang nodig is (bij <parameter>-R</parameter> en
    <parameter>-F</parameter>), hoeft de gebruiker niet over een Firebird-inlog te beschikken en
    hoeft zelfs geen server te draaien.</para>
    <para>NB: In het bovenstaande gaat het telkens om toegang tot de <emphasis>database</emphasis>.
    De toegang tot de backup is natuurlijk altijd puur op bestandsniveau.</para>
    <!--TE DOEN voor een evt. volgende versie:

Breid deze info nog meer uit en maak een tabel waarin voor elke operatie is vermeld:
- Of er bestandstoegang nodig is op a) database en b) backup en voor allebei: zo ja, welke (lees- en/of schrijf-)
- Of Firebird-authenticatie nodig is en zo ja: zwak (zoals soms bij Service Manager) of strikt.-->
  </section>
  <section id="nbackup-nl-backups">
    <title>Backups maken en terugzetten</title>
    <para>Vooraf: <filename>nbackup.exe</filename> bevindt zich in de <filename
    class="directory">bin</filename>-subdirectory van je Firebird-map. Typische locaties zijn
    bijvoorbeeld <filename class="directory">C:\Program Files\Firebird\Firebird_2_0\bin</filename>
    (Windows) of <filename class="directory">/opt/firebird/bin</filename> (Linux). Net als de meeste
    meegeleverde tools heeft <application>nbackup</application> geen grafische interface; je start
    het vanaf de opdrachtregel of roept het aan vanuit een batchbestand of programma.</para>
    <warning>
      <para>Bij zware belasting kunnen nbackup 2.0.3 en lager soms problemen veroorzaken die leiden
      tot vastlopers of zelfs beschadigde databases. Hoewel deze problemen niet vaak voorkomen, zijn
      ze toch ernstig genoeg om upgraden naar Firebird 2.0.4 of hoger te rechtvaardigen als je
      nbackup met een gerust hart wilt gebruiken. Bij grote databases op Posix-systemen kan ook het
      al dan niet toepassen van rechtstreekse invoer/uitvoer een rol spelen. Zie hiervoor de
      paragraaf <link linkend="nbackup-nl-backups-directio"><citetitle>Rechtstreekse
      I/O</citetitle></link>.</para>
      <!--CORE-2316-->
    </warning>
    <section id="nbackup-nl-backups-voll">
      <title>Volledige backups</title>
      <section id="nbackup-nl-backups-voll-maken">
        <title>Een volledige backup maken</title>
        <para>Om een volledige backup te maken luidt de opdracht:</para>
        <blockquote>
          <programlisting>nbackup [-U <replaceable>&lt;gebr&gt;</replaceable> -P <replaceable>&lt;wachtw&gt;</replaceable>] -B 0 <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backupbestand&gt;</replaceable>]</programlisting>
        </blockquote>
        <para>Voorbeeld:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -B 0 inventaris.fdb inventaris_1-mrt-2006.nbk</screen>
        </blockquote>
        <para id="nbackup-nl-backups-opm">Opmerkingen:</para>
        <itemizedlist>
          <listitem>
            <para>De parameter <parameter>-B</parameter> staat voor backup (goh!). Het
            <firstterm>backupniveau</firstterm> 0 betekent dat er een volledige backup wordt
            gemaakt. Backupniveaus hoger dan 0 worden gebruikt voor aanvullende backups; deze worden
            verderop besproken.</para>
          </listitem>
          <listitem>
            <para>In plaats van een databasebestandsnaam mag ook een alias worden opgegeven.</para>
          </listitem>
          <listitem>
            <para>In plaats van een backupbestandsnaam mag ook <systemitem>stdout</systemitem>
            worden opgegeven. De backup wordt dan naar de standaarduitvoer gestuurd en kan vandaar
            worden doorgeleid naar bijvoorbeeld een bandarchief of een compressieprogramma.</para>
          </listitem>
          <listitem id="nbackup-nl-backups-zonder-inlog">
            <para>De parameters <parameter>-U</parameter> (user) en <parameter>-P</parameter>
            (password) kunnen worden weggelaten als aan minstens één van de volgende voorwaarden is
            voldaan:</para>
            <itemizedlist spacing="compact">
              <listitem>
                <para>De omgevingsvariabelen <envar>ISC_USER</envar> en <envar>ISC_PASSWORD</envar>
                zijn ingesteld, ofwel op <database>SYSDBA</database>, ofwel op de eigenaar van de
                database.</para>
              </listitem>
              <listitem>
                <para>Je bent als root ingelogd op een Posixsysteem. Dit maakt je automatisch
                <database>SYSDBA</database>.</para>
                <!--Zoek uit hoe het zit met interbas, interbase en firebird - werkt dat alleen bij Superserver?-->
              </listitem>
              <listitem>
                <para>Onder Windows: <firstterm>trusted authentication</firstterm> (vertrouwde
                inlog) is aangezet in <filename>firebird.conf</filename>, en het Windows-account
                waaronder je bent aangemeld is eigenaar van de database. Dit is mogelijk vanaf
                Firebird 2.1.</para>
              </listitem>
              <listitem>
                <para>Onder Windows: je bent lid van de Administrators-groep èn trusted
                authentication staat aan in <filename>firebird.conf</filename>. In Firebird 2.1 heb
                je dan automatisch <database>SYSDBA</database>-rechten. Vanaf Firebird 2.5 geldt als
                aanvullende eis dat <database>AUTO ADMIN MAPPING</database> aangezet moet zijn in de
                database.</para>
              </listitem>
            </itemizedlist>
            <para>Voor de overzichtelijkheid laten we de parameters <parameter>-U</parameter> en
            <parameter>-P</parameter> in de voorbeelden telkens weg.</para>
          </listitem>
          <listitem>
            <para>Met ingang van Firebird 2.5 kan in plaats van <parameter>-P</parameter>
            <replaceable>&lt;wachtwoord&gt;</replaceable> ook <parameter>-FE</parameter>
            <replaceable>&lt;bestandsnaam&gt;</replaceable> worden opgegeven. In dat geval wordt het
            wachtwoord uit het opgegeven bestand gelezen. Voordeel is dat het wachtwoord zo beter
            afgeschermd kan worden; het komt niet op de opdrachtregel terecht of in een
            script/batchbestand waar mogelijk allerlei mensen bij kunnen.
            (<parameter>-FE</parameter> staat voor <firstterm>fetch</firstterm>, haal op.)</para>
          </listitem>
          <listitem>
            <para>In Firebird 2.1 en hoger kan met de parameter <parameter>-T</parameter> worden
            voorkomen dat databasetriggers worden afgevuurd bij het maken van de backup. Voor meer
            info zie <link linkend="nbackup-nl-backups-dbtriggers"><citetitle>Databasetriggers
            onderdrukken</citetitle></link>.</para>
          </listitem>
          <listitem>
            <para>Met ingang van Firebird 2.1.4 kan de gebruiker zelf bepalen of nbackup
            rechtstreekse I/O toepast bij het maken van de backup. Dit gebeurt met de opties
            <parameter>-D</parameter> <parameter>on</parameter> en <parameter>-D</parameter>
            <parameter>off</parameter>. Meer details en achtergronden in de paragraaf <link
            linkend="nbackup-nl-backups-directio"><citetitle>Rechtstreekse I/O</citetitle></link>,
            elders in deze handleiding.</para>
          </listitem>
          <listitem>
            <para>De verschillende parameters (<parameter>-B</parameter>, <parameter>-U</parameter>
            enz.) mogen in elke gewenste volgorde voorkomen. Wel moet elke parameter direct worden
            gevolgd door zijn eigen bijbehorende argument(en). Voor <parameter>-B</parameter> zijn
            dat er drie: niveaugetal, database en backupbestand — in die volgorde!</para>
          </listitem>
          <listitem>
            <para>Als de <parameter>-B</parameter>-parameter als laatste komt,
            <emphasis>mag</emphasis> de naam van het backupbestand worden weggelaten. nbackup stelt
            dan zelf een naam samen, gebaseerd op de naam van de database, het backupniveau, de
            datum en de tijd. Dit kan overigens tot een botsing leiden (en tot een mislukte backup)
            als twee backupopdrachten van hetzelfde niveau in dezelfde minuut worden gegeven.</para>
          </listitem>
        </itemizedlist>
        <warning>
          <para>Gebruik nbackup <emphasis>niet</emphasis> voor databases die uit meerdere bestanden
          bestaan. Dit kan leiden tot corruptie en gegevensverlies, ondanks het feit dat nbackup
          niet zal protesteren tegen een dergelijke opdracht.</para>
        </warning>
        <section id="nbackup-nl-backups-werking">
          <title>Iets over de werking</title>
          <para>NB: Wat onder dit kopje volgt is géén noodzakelijke kennis voor het gebruik van
          nbackup. Het geeft alleen een globaal (en onvolledig) beeld van wat er onder de motorkap
          gebeurt tijdens de uitvoering van nbackup <parameter>-B</parameter>:</para>
          <procedure>
            <step>
              <para>Om te beginnen wordt het databasebestand vergrendeld door het wijzigen van een
              interne toestandsvlag. Vanaf dit moment worden alle wijzigingen in de database
              weggeschreven naar een tijdelijk bestand — het verschilbestand oftewel
              <firstterm>deltabestand</firstterm>.</para>
            </step>
            <step>
              <para>Daarna wordt de feitelijke backup gemaakt. Dit is geen rechttoe-rechtane
              bestandskopie; terugzetten moet dus ook weer met nbackup gebeuren.</para>
            </step>
            <step>
              <para>Nadat de backup gemaakt is, wordt de inhoud van het deltabestand geïntegreerd
              met het hoofdbestand. Vervolgens wordt het hoofdbestand ontgrendeld (vlag gaat weer op
              <quote>normaal</quote>) en de delta verwijderd.</para>
            </step>
          </procedure>
          <para>De functionaliteit van de stappen 1 en 3 wordt verzorgd door twee nieuwe
          SQL-opdrachten: <database>ALTER DATABASE BEGIN BACKUP</database> en <database>ALTER
          DATABASE END BACKUP</database>. In tegenstelling tot hetgeen de namen suggereren, zorgen
          deze opdrachten <emphasis>niet</emphasis> voor het maken van de backup zelf; ze scheppen
          alleen de noodzakelijke voorwaarden waaronder het hoofdbestand veilig kan worden
          gebackupt. En voor alle duidelijkheid: je hoeft deze SQL-opdrachten niet zelf te geven;
          nbackup zorgt hiervoor, op de juiste momenten.</para>
        </section>
      </section>
      <section id="nbackup-nl-backups-voll-terugzetten">
        <title>Een volledige backup terugzetten</title>
        <para>Een volledige backup wordt als volgt teruggezet:</para>
        <blockquote>
          <programlisting>nbackup -R <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backupbestand&gt;</replaceable>]</programlisting>
        </blockquote>
        <para>Voorbeeld:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -R inventaris.fdb inventaris_1-mrt-2006.nbk</screen>
        </blockquote>
        <para id="nbackup-nl-terugzetten-opm">Opmerkingen:</para>
        <itemizedlist>
          <listitem>
            <para>Bij het terugzetten wordt geen niveau aangegeven.</para>
          </listitem>
          <listitem>
            <para>Bij het terugzetten <emphasis>moet</emphasis> de parameter
            <parameter>-R</parameter> (restore) de laatste zijn; dit om redenen die later duidelijk
            zullen worden.</para>
          </listitem>
          <listitem>
            <para>In plaats van een databasebestandsnaam mag ook een alias worden opgegeven.</para>
          </listitem>
          <listitem>
            <para>Als de opgegeven database al bestaat, mislukt het terugzetten en krijg je een
            foutmelding.</para>
          </listitem>
          <listitem>
            <para>Ook bij het terugzetten mag de naam van het backupbestand worden weggelaten.
            Nbackup vraagt je dan om de naam alsnog op te geven. <emphasis>(Let op: In Firebird 2.0
            is deze interactieve terugzetvoorziening defect; je krijgt dan een foutmelding en het
            terugzetten mislukt. Hersteld in 2.0.1.)</emphasis></para>
          </listitem>
          <listitem>
            <para>Het terugzetten werkt puur op bestandsniveau en kan dus ook worden uitgevoerd
            zonder dat er een Firebirdserver draait. Eventuele met <parameter>-U</parameter> en
            <parameter>-P</parameter> meegegeven inloggegevens worden genegeerd. Ook als de
            <parameter>-FE</parameter>-optie is gegeven, wordt het uit het bestand gelezen
            wachtwoord niet gebruikt. Het wordt echter in eerste instantie wel ingelezen; treedt
            daarbij een probleem op, dan mislukt het terugzetten.</para>
          </listitem>
        </itemizedlist>
      </section>
    </section>
    <section id="nbackup-nl-backups-aanv">
      <title>Aanvullende backups</title>
      <warning>
        <para>De aanvullende-backupsvoorziening was compleet defect in Firebird 2.1, en weer
        hersteld in 2.1.1.</para>
        <!--CORE-1876-->
      </warning>
      <section id="nbackup-nl-backups-aanv-maken">
        <title>Aanvullende backups maken</title>
        <para>Om een aanvullende backup te maken geven we een niveau hoger dan 0 aan. Een
        aanvullende backup van niveau <replaceable>N</replaceable> bevat telkens de wijzigingen in
        de database sinds de meest recente backup van niveau <replaceable>N-1</replaceable>.</para>
        <para>Voorbeelden:</para>
        <para>Een dag na het maken van de volledige backup (met niveau 0) maak je er een met niveau
        1:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -B 1 inventaris.fdb inventaris_2-mrt-2006.nbk</screen>
        </blockquote>
        <para>Deze backup bevat dus alleen de wijzigingen van de laatste dag.</para>
        <para>Weer een dag later maak je er nog eentje van niveau 1:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -B 1 inventaris.fdb inventaris_3-mrt-2006.nbk</screen>
        </blockquote>
        <para>Deze backup bevat de wijzigingen van de laatste <emphasis>twee</emphasis> dagen, sinds
        de volledige backup, dus niet alleen die sinds de vorige niveau-1-backup.</para>
        <para>Een paar uur later maken we een backup van niveau 2:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -B 2 inventaris.fdb inventaris_3-mrt-2006_2.nbk</screen>
        </blockquote>
        <para>Deze jongste backup bevat alleen de wijzigingen sinds de meest recente
        niveau-1-backup, dus die van de laatste paar uren.</para>
        <note>
          <para>Alle <link linkend="nbackup-nl-backups-opm">opmerkingen</link> die gemaakt zijn bij
          het maken van volledige backups, gelden ook voor aanvullende backups.</para>
        </note>
        <warning>
          <para>Nogmaals: gebruik nbackup niet voor databases die uit meerdere bestanden
          bestaan.</para>
        </warning>
      </section>
      <section id="nbackup-nl-backups-aanv-terugzetten">
        <title>Aanvullende backups terugzetten</title>
        <para>Bij het terugzetten van aanvullende backups moet de hele reeks backupbestanden worden
        gespecificeerd vanaf niveau 0 tot en met het gewenste niveau. De database wordt daarbij
        altijd vanaf de grond opnieuw opgebouwd, in stappen (dit stapsgewijs aanvullen tot een
        volledig herstelde database verklaart de Engelse term <foreignphrase>incremental
        backup</foreignphrase>).</para>
        <para>De formele syntaxis luidt:</para>
        <blockquote>
          <programlisting>nbackup -R <replaceable>&lt;database&gt;</replaceable> [<replaceable>&lt;backup0&gt;</replaceable> [<replaceable>&lt;backup1&gt;</replaceable> [<replaceable>...</replaceable>] ] ]</programlisting>
        </blockquote>
        <para>Het terugzetten van de niveau-2-backup uit het voorgaande voorbeeld gaat dus als
        volgt:</para>
        <blockquote>
          <screen>C:\Data&gt; nbackup -R inventaris.fdb inventaris_1-mrt-2006.nbk
           inventaris_3-mrt-2006.nbk inventaris_3-mrt-2006_2.nbk</screen>
        </blockquote>
        <para>Uiteraard is de regel hier alleen gesplitst voor de overzichtelijkheid — in de
        praktijk typ je alles achter elkaar en drukt dan pas op <keycap>Enter</keycap>.</para>
        <para>Opmerkingen (in aanvulling op de <link
        linkend="nbackup-nl-terugzetten-opm">opmerkingen bij het terugzetten van een volledige
        backup</link>):</para>
        <itemizedlist>
          <listitem>
            <para>Omdat bij de <parameter>-R</parameter>-optie niet van tevoren bekend is hoeveel
            bestandsnamen er zullen volgen (bij terugzetten geven we immers geen niveaugetal op),
            gaat nbackup ervan uit dat alle argumenten na de <parameter>-R</parameter> namen van
            backupbestanden zijn. Het is hierom dat er na de lijst met bestandsnamen geen andere
            parameter meer mag volgen.</para>
          </listitem>
          <listitem>
            <para>Er is geen formele limiet aan het aantal backupniveaus, maar verder gaan dan
            niveau 3 of 4 zal in de praktijk zelden nut hebben.</para>
          </listitem>
        </itemizedlist>
        <section id="nbackup-nl-backups-aanv-nietpassend">
          <title>Niet-passende schakels</title>
          <para>Wat gebeurt er als je per ongeluk een bestand weglaat, of een reeks bestanden
          opgeeft die niet allemaal bij elkaar passen? Je zou je voor kunnen stellen dat je in het
          bovenstaande voorbeeld bij vergissing <filename>inventaris_2-mrt-2006.nbk</filename>
          opgeeft in plaats van <filename>inventaris_3-mrt-2006.nbk</filename>. Beide zijn
          backupbestanden van niveau 1; in beide gevallen krijgen we dus een keurige niveaureeks 0,
          1, 2. Maar het niveau-2-bestand is aanvullend ten opzichte van de niveau-1-backup van 3
          maart, niet t.o.v. die van 2 maart.</para>
          <para>Gelukkig kan een dergelijke vergissing nooit tot een foutief teruggezette database
          leiden. Elk backupbestand bevat namelijk een unieke ID. Voorts is in elke backup van
          niveau 1 of hoger de ID opgeslagen van de backup waarop hij gebaseerd is. Bij het
          terugzetten controleert nbackup deze gegevens; als er ergens in de keten iets niet klopt,
          wordt de operatie geannuleerd en krijg je een foutmelding.</para>
        </section>
      </section>
    </section>
    <section id="nbackup-nl-backups-kaal-app">
      <title>Databases op kale apparaten backuppen</title>
      <para>Een Firebird-database hoeft geen bestand te zijn, maar kan zich ook op een zogeheten
      <firstterm>kaal apparaat</firstterm>, bijvoorbeeld een schijfpartitie zonder bestandssysteem,
      bevinden. De vraag waar de <link linkend="nbackup-nl-backups-werking">delta</link> dan
      geplaatst moet worden, is bij het ontwikkelen van <application>nbackup</application> in eerste
      instantie over het hoofd gezien. Op Posix-systemen kon het zo gebeuren dat als de database
      zich op <filename class="devicefile">/dev/hdb5</filename> bevond, een deltabestand
      <filename>/dev/hdb5.delta</filename> werd aangemaakt. Dat is onwenselijk gezien aard en doel
      van de <filename>/dev</filename>-map en de meestal geringe beschikbare ruimte.</para>
      <para>Vanaf Firebird 2.1 weigert nbackup dan ook te werken met databases op kale apparaten als
      niet expliciet een locatie voor het deltabestand is ingesteld. Hoe dit moet, wordt besproken
      in <link linkend="nbackup-nl-deltabestand"><citetitle>Het deltabestand
      instellen</citetitle></link>, verderop in deze handleiding.</para>
    </section>
    <section id="nbackup-nl-backups-dbtriggers">
      <title>Databasetriggers onderdrukken (Firebird 2.1+)</title>
      <para>Sinds versie 2.1 ondersteunt Firebird het gebruik van
      <firstterm>databasetriggers</firstterm>. Deze kunnen o.a. worden afgevuurd bij het maken en
      verbreken van een verbinding. Rond het uitvoeren van een backup maakt nbackup via de server
      verbinding met de database (in sommige versies zelfs meermalen). Om nu te voorkomen dat
      hierbij onbedoeld databasetriggers afgevuurd worden, kan de optie <parameter>-T</parameter>
      worden meegegeven. NB: de overeenkomstige optie in <application>gbak</application> en
      <application>isql</application> heet <parameter>-nodbtriggers</parameter> (we zijn dol op
      variatie, hier bij Firebird).</para>
    </section>
    <section id="nbackup-nl-backups-directio">
      <title>Rechtstreekse I/O (Firebird 2.1.4+)</title>
      <para>Oorspronkelijk gebruikte nbackup bij het maken van de backup onder Windows NT (en
      afgeleiden zoals 2000, 2003 enz.) rechtstreekse invoer/uitvoer, en in alle andere gevallen
      niet. Omdat dit op sommige Linuxsystemen voor problemen zorgde, werd in Firebird 2.0.6 en
      2.1.3 ook onder Linux voor rechtstreekse I/O gekozen. Maar dit leidde weer tot problemen op
      andere Linuxsystemen. Daarom is in 2.1.4 en 2.5 het standaardgedrag weer zoals voorheen, en is
      een parameter <parameter>-D</parameter> toegevoegd waarmee de gebruiker zelf de rechtstreekse
      I/O aan of uit kan zetten. Het gebruik is als volgt:</para>
      <blockquote>
        <programlisting>nbackup -B 0 glazen.fdb glazen.nbk -D on    -- rechtstreekse I/O aan
nbackup -B 0 bekers.fdb bekers.nbk -D off   -- rechtstreekse I/O uit</programlisting>
      </blockquote>
      <para>De argumenten ON en OFF zijn niet hoofdlettergevoelig, evenmin als de parameterletters
      zelf.</para>
      <para>Rechtstreekse I/O wordt alléén toegepast bij het maken van een backup, niet bij het
      terugzetten. Onder Windows wordt hiertoe <constant>FILE_FLAG_NO_BUFFERING</constant> aangezet.
      Op andere systemen worden <constant>O_DIRECT</constant> en
      <constant>POSIX_FADV_NOREUSE</constant> gebruikt. Deze laatste twee vlaggen zijn soms niet
      beschikbaar; in zo'n geval worden ze (of wordt er één) stilzwijgend weggelaten. Ook als de
      gebruiker expliciet <parameter>-D</parameter> <parameter>on</parameter> heeft meegegeven,
      leidt dit niet tot een waarschuwing of foutmelding.</para>
    </section>
    <section id="nbackup-nl-backups-inform-opties">
      <title>Informatieve opties (Firebird 2.5+)</title>
      <para>Behalve de al genoemde parameters <parameter>-FE</parameter> en
      <parameter>-D</parameter> zijn in Firebird 2.5 ook nog de volgende twee toegevoegd:</para>
      <variablelist>
        <varlistentry>
          <term><parameter>-Z</parameter></term>
          <listitem>
            <para>Toont éénregelige versie-informatie. Deze optie kan los worden gebruikt, maar ook
            in combinatie met andere parameters zoals <parameter>-B</parameter>,
            <parameter>-R</parameter>, <parameter>-L</parameter> enz.</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><parameter>-?</parameter></term>
          <listitem>
            <para>Geeft een beknopt overzicht van het gebruik van nbackup en de diverse parameters.
            NB: als deze optie aanwezig is, worden alle andere parameters genegeerd!</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </section>
    <section id="nbackup-nl-backups-ver">
      <title>Backups op verre machines (Firebird 2.5+)</title>
      <para>Nbackup zelf werkt alleen op lokale databases. Maar vanaf Firebird 2.5 kunnen via de
      Service Manager ook op verre machines backups en restores van het nbackup-type worden
      uitgevoerd. Hiervoor gebruik je op de lokale machine het programma
      <filename>fbsvcmgr.exe</filename>, dat in dezelfde map staat als
      <filename>nbackup.exe</filename> en de overige Firebird-hulpprogramma's. Als eerste argument
      geef je <quote><replaceable>hostnaam</replaceable>:<systemitem
      class="service">service_mgr</systemitem></quote> op, waarbij je
      <replaceable>hostnaam</replaceable> natuurlijk vervangt door de naam van de verre server.
      Overige parameters zijn:</para>
      <blockquote>
        <programlisting>-user <replaceable>gebrnaam</replaceable>
-password <replaceable>wachtwoord</replaceable>
-action_nbak
-action_nrest
-nbk_level <replaceable>n</replaceable>
-dbname <replaceable>database</replaceable>
-nbk_file <replaceable>bestnaam</replaceable>
-nbk_no_triggers
-nbk_direct on|off</programlisting>
      </blockquote>
      <para>Het maken van een volledige backup op de verre machine <systemitem
      class="systemname">frodo</systemitem> gaat dan bijvoorbeeld zo:</para>
      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nbak -nbk_level 0
  -dbname C:\databases\landen.fdb -nbk_file C:\databases\landen.nbk</programlisting>
      </blockquote>
      <para>En van een latere aanvullende backup:</para>
      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nbak -nbk_level 1
  -dbname C:\databases\landen.fdb -nbk_file C:\databases\landen_1.nbk</programlisting>
      </blockquote>
      <para>Terugzetten van de hele zwikzwak gaat als volgt:</para>
      <blockquote>
        <programlisting>fbsvcmgr frodo:service_mgr -user sysdba -password masterke
  -action_nrest -dbname C:\databases\landen_hersteld.fdb
  -nbk_file C:\databases\landen.nbk -nbk_file C:\databases\landen_1.nbk</programlisting>
      </blockquote>
      <para>Let op: in werkelijkheid moet elk van de bovenstaande opdrachten als één zin worden
      getypt, zonder regeleinden. Verder mogen de streepjes voor de parameternamen worden
      weggelaten, maar juist bij dit soort lange opdrachten is het meestal prettiger om ze wel te
      gebruiken: je ziet dan duidelijk de afzonderlijke parameters (de argumenten krijgen geen
      streepje).</para>
      <para>Opmerkingen:</para>
      <itemizedlist>
        <listitem>
          <para>De Services Manager verlangt altijd authenticatie, hetzij automatisch (root onder
          Posix, <quote>trusted</quote> onder Windows), hetzij expliciet via de parameters
          <parameter>-user</parameter> en <parameter>-password</parameter>. De omgevingsvariabelen
          <envar>ISC_USER</envar> en <envar>ISC_PASSWORD</envar> worden echter niet ingelezen.
          <database>AUTO ADMIN MAPPING</database> in de database heeft geen effect als je vanaf een
          andere machine verbinding maakt (maar misschien is dit afhankelijk van de configuratie van
          het netwerk).</para>
          <para>NB: Bij Windows trusted krijgt de Services Manager op de verre machine de
          gebruikersnaam doorgegeven van de aanroeper op de lokale machine. Is de eigenaar van de
          database een Windows-account (bijv. <systemitem class="username">FRODO\PAUL</systemitem>)
          i.p.v. een Firebirdaccount, en komt de Windows-accountnaam van de aanroeper op de lokale
          machine overeen met het eigenaar-account op de verre machine, dan wordt de aanroeper als
          eigenaar erkend en kan de backup gemaakt worden. Dit kan een veiligheidsrisico opleveren,
          want ook binnen een lokaal netwerk hoeft gebruiker <systemitem
          class="username">PAUL</systemitem> op de ene machine niet dezelfde persoon te zijn als
          <systemitem class="username">PAUL</systemitem> op de andere.</para>
        </listitem>
        <listitem>
          <para>Ook bij terugzetten (<parameter>-action_nrest</parameter>) is authenticatie vereist,
          maar de inloggegevens worden dan verder niet gebruikt. De gebruiker hoeft dus geen
          eigenaar, <database>SYSDBA</database> of superuser te zijn. In geval van Windows trusted
          authentication hoeft de gebruiker op de verre machine (waar de database zich bevindt)
          zelfs helemaal niet te bestaan.</para>
          <para>Deze zwakke authenticatie levert ook weer een potentieel veiligheidsrisico op. Stel
          dat er van een gevoelige database nbackups worden gemaakt, en dat deze op bestandsniveau
          goed worden beveiligd. Een willekeurige gebruiker kan dan niet met nbackup de database
          herstellen, want nbackup draait in de procesruimte van de gebruiker. Maar diezelfde
          gebruiker kan – als hij locatie en bestandsnaam weet, of deze op grond van analogie kan
          raden – wellicht met <application>fbsvcmgr</application> de database naar een publieke map
          terugzetten en hem aldus te pakken krijgen. Immers, fbsvcmgr roept de Firebirdserver aan
          en die heeft mogelijk wèl bestandstoegang tot de backup. Natuurlijk zijn hier oplossingen
          voor te bedenken, maar het is wel zaak om je van dit risico bewust te zijn.</para>
          <!--Geldt iets dergelijks ook voor de traditionele gbak/restore als je het via de Services Manager doet?

Zoek verder uit en open evt. een tracker-ticket of bespreek in fb-devel. De remedie is eenvoudig: vereis een grondige
authenticatie voor (n)restore.-->
        </listitem>
        <listitem>
          <para>De Services Manager kan ook lokaal worden gebruikt; het eerste argument wordt dan
          <parameter>service_mgr</parameter>, zonder hostnaam. Bij lokaal gebruik heeft
          <database>AUTO ADMIN MAPPING</database> wel het normale effect; dit geldt ook als je
          bijvoorbeeld <literal>localhost:</literal> of de naam van de lokale machine voorvoegt.
          Lokaal gebruik van de Services Manager kan van nut zijn als je zelf geen bestandstoegang
          hebt tot database en/of backup, en het Firebirdproces wel. Heb je wel voldoende
          bestandsrechten, dan kun je beter nbackup zelf gebruiken, met zijn veel kortere
          opdrachtregels.</para>
        </listitem>
        <listitem>
          <para>Gebruik van <parameter>-nbk_no_triggers</parameter> of
          <parameter>-nbk_direct</parameter> bij <parameter>-action_nrest</parameter> leidt tot een
          foutmelding. Nbackup zelf is hier soepeler in: die negeert de parameters
          <parameter>-T</parameter> en <parameter>-D</parameter> gewoon als je ze gebruikt waar ze
          niet van toepassing zijn.</para>
        </listitem>
        <listitem>
          <para>In plaats van een databasenaam mag ook een alias worden gebruikt.</para>
        </listitem>
      </itemizedlist>
    </section>
    <section id="nbackup-nl-backups-prakt">
      <title>Toepassing in de praktijk</title>
      <para>Een backupschema met gebruik van nbackup zou er als volgt uit kunnen zien:</para>
      <itemizedlist spacing="compact">
        <listitem>
          <para>Elke maand een volledige backup (niveau 0);</para>
        </listitem>
        <listitem>
          <para>Elke week een niveau 1;</para>
        </listitem>
        <listitem>
          <para>Dagelijks een niveau 2;</para>
        </listitem>
        <listitem>
          <para>Elk uur een niveau 3.</para>
        </listitem>
      </itemizedlist>
      <para>Zolang alle backups bewaard worden, kun je met dit schema de database herstellen tot de
      toestand van elk gewenst uur in het verleden. Hierbij worden voor elke herstelactie maximaal
      vier backupbestanden gebruikt. Natuurlijk regel je e.e.a. zo dat de grotere, tijdrovende
      backups op rustige uren gepland worden. In dit geval zouden de backups van de niveaus 0 en 1
      in de weekeinden gemaakt kunnen worden, en die van niveau 2 's nachts.</para>
      <para>Wil je niet alles voor de eeuwigheid bewaren, dan kun je er een wisschema aan
      koppelen:</para>
      <itemizedlist spacing="compact">
        <listitem>
          <para>Niveau-3-backups worden gewist als ze ouder zijn dan acht dagen;</para>
        </listitem>
        <listitem>
          <para>Backups van niveau 2 na een maand;</para>
        </listitem>
        <listitem>
          <para>Niveau 1 na zes maanden;</para>
        </listitem>
        <listitem>
          <para>Niveau 0 na twee jaar, behalve bijvoorbeeld de eerste van elk jaar.</para>
        </listitem>
      </itemizedlist>
      <para>Dit is uiteraard maar een voorbeeld. Wat in een bepaald geval nuttig is, hangt af van de
      toepassing, de databasegrootte, de activiteit, enzovoort.</para>
    </section>
    <section id="nbackup-nl-backups-verder">
      <title>Verder lezen?</title>
      <para>Je weet nu alles wat nodig is om met nbackup volledige en/of aanvullende backups te
      maken en terug te zetten. Je hoeft alleen verder te lezen als je backuptools naar keuze wilt
      gebruiken voor je Firebird-databases (zie <link
      linkend="nbackup-nl-vergr-ontgr"><citetitle>Vergrendelen en ontgrendelen</citetitle></link>),
      of als je de standaardnaam of -locatie van het deltabestand wilt aanpassen (zie <link
      linkend="nbackup-nl-deltabestand"><citetitle>Het deltabestand
      instellen</citetitle></link>).</para>
      <para>Heb je daar allemaal geen behoefte aan, dan wensen we je veel succes toe bij het werken
      met nbackup!</para>
    </section>
  </section>
  <section id="nbackup-nl-vergr-ontgr">
    <title>Vergrendelen en ontgrendelen</title>
    <para>Wil je liever met je eigen backupgereedschap een veiligheidskopie maken, of gewoon een
    bestandskopie maken, dan komt modus 2, de ver/ontgrendeltaak, in beeld.
    <quote>Vergrendelen</quote> houdt hier in dat het hoofdbestand van de database tijdelijk wordt
    bevroren, <emphasis>niet</emphasis> dat er geen wijzigingen in de database mogen plaatsvinden.
    Net als bij modus 1 worden wijzigingen naar een tijdelijk bestand geschreven en na ontgrendelen
    alsnog opgenomen in het hoofdbestand.</para>
    <para>Ter herinnering: <filename>nbackup.exe</filename> bevindt zich in de <filename
    class="directory">bin</filename>-subdirectory van je Firebird-map. Typische locaties zijn
    bijvoorbeeld <filename class="directory">C:\Program Files\Firebird\Firebird_2_0\bin</filename>
    (Windows) of <filename class="directory">/opt/firebird/bin</filename> (Linux). Er is geen
    grafische interface; je start het vanaf de opdrachtregel of roept het aan vanuit een
    batchbestand of programma.</para>
    <section id="nbackup-nl-vergr-backup">
      <title>Database vergrendelen en zelf backuppen</title>
      <para>Een typische sessie waarbij je zelf de backup maakt, verloopt als volgt.</para>
      <procedure>
        <step>
          <para>Vergrendel de database met de optie <parameter>-L</parameter> (lock):</para>
          <blockquote>
            <para><programlisting>nbackup [-U <replaceable>&lt;gebruiker&gt;</replaceable> -P <replaceable>&lt;wachtwoord&gt;</replaceable>] -L <replaceable>&lt;database&gt;</replaceable></programlisting></para>
          </blockquote>
        </step>
        <step>
          <para>Kopieer/backup/zip het databasebestand nu naar hartelust met gereedschap van je
          eigen keuze. Een simpele bestandskopie is ook mogelijk.</para>
        </step>
        <step>
          <para>Ontgrendel de database met <parameter>-N</parameter> (uNlock):</para>
          <blockquote>
            <para><programlisting>nbackup [-U <replaceable>&lt;gebruiker&gt;</replaceable> -P <replaceable>&lt;wachtwoord&gt;</replaceable>] -N <replaceable>&lt;database&gt;</replaceable></programlisting></para>
          </blockquote>
        </step>
      </procedure>
      <para>Door de laatste opdracht worden ook eventuele wijzigingen – die naar een tijdelijk
      bestand zijn weggeschreven – weer in het hoofdbestand verwerkt.</para>
      <para>De gemaakte backup/kopie bevat de gegevens zoals die op het moment van vergrendelen in
      de database aanwezig waren, ongeacht hoe lang de vergrendeling heeft geduurd en ongeacht
      hoelang je hebt gewacht met het maken van de feitelijke backup.</para>
      <para>Opmerkingen:</para>
      <itemizedlist>
        <listitem>
          <para>In plaats van een databasebestandsnaam mag ook een alias worden opgegeven.</para>
        </listitem>
        <listitem>
          <para>De parameters <parameter>-U</parameter> en <parameter>-P</parameter> kunnen worden
          weggelaten als <envar>ISC_USER</envar> en <envar>ISC_PASSWORD</envar> zijn ingesteld, als
          je root bent op een Posixsysteem, of als <quote>trusted authentication</quote> onder
          Windows dit mogelijk maakt. Zie voor een uitgebreidere beschrijving de <link
          linkend="nbackup-nl-backups-zonder-inlog">opmerkingen onder <citetitle>Een volledige
          backup maken</citetitle></link>.</para>
        </listitem>
        <listitem>
          <para>Met ingang van Firebird 2.5 kan in plaats van <parameter>-P</parameter>
          <replaceable>&lt;wachtwoord&gt;</replaceable> ook <parameter>-FE</parameter>
          <replaceable>&lt;bestandsnaam&gt;</replaceable> worden opgegeven.</para>
        </listitem>
        <listitem>
          <para>Zowel <parameter>-L</parameter> als <parameter>-N</parameter> maken verbinding met
          de database, dus in Firebird 2.1 en hoger kan het verstandig zijn om de optie
          <parameter>-T</parameter> toe te voegen (zie <link
          linkend="nbackup-nl-backups-dbtriggers"><citetitle>Databasetriggers
          onderdrukken</citetitle></link>).</para>
        </listitem>
        <listitem>
          <para>Bij het vergrendelen van een database op een kaal apparaat kan de
          <parameter>-S</parameter>-optie van groot nut zijn; zie <link
          linkend="nbackup-nl-vergr-kaal-app"><citetitle>Databases op kale apparaten
          vergrendelen</citetitle></link>.</para>
        </listitem>
        <listitem>
          <para>Eventueel kun je <parameter>-Z</parameter> toevoegen om éénregelige
          versie-informatie te laten tonen.</para>
        </listitem>
      </itemizedlist>
      <warning>
        <para>Ook voor de ver- en ontgrendelfuncties van nbackup geldt dat ze niet gebruikt moeten
        worden op databases die uit meerdere bestanden bestaan. Zolang er op dit punt niets
        veranderd is, moet nbackup op geen enkele wijze op dit soort databases worden
        losgelaten!</para>
      </warning>
    </section>
    <section id="nbackup-nl-terugz-fixup">
      <title>Terugzetten van een na <quote>nbackup -L</quote> gemaakte backup</title>
      <para>Een kopie van een vergrendelde database is natuurlijk zelf ook een vergrendelde
      database, en daarom niet meteen klaar voor normaal gebruik. Mocht je oorspronkelijke database
      verloren gaan of beschadigd raken, en de zelfgemaakte kopie moet worden teruggezet (of mocht
      je de kopie op een andere computer willen installeren), ga dan als volgt te werk:</para>
      <procedure>
        <step>
          <para>Kopieer/herstel/ontzip zelf de databasebackup met het daarvoor benodigde
          gereedschap.</para>
        </step>
        <step>
          <para>Ontgrendel vervolgens de teruggezette database <emphasis>niet</emphasis> met de
          <parameter>-N</parameter>-optie, maar met <parameter>-F</parameter> (fixup):</para>
          <blockquote>
            <para><programlisting>nbackup -F <replaceable>&lt;database&gt;</replaceable></programlisting></para>
          </blockquote>
          <para>Ook hier weer kun je eventueel een alias gebruiken in plaats van een bestandsnaam,
          en kan <parameter>-Z</parameter> toegevoegd worden voor versie-info. Andere opties hebben
          geen zin.</para>
        </step>
      </procedure>
      <para>Waarom zijn er twee ontgrendelopties, <parameter>-N</parameter> en
      <parameter>-F</parameter>?</para>
      <itemizedlist spacing="compact">
        <listitem>
          <para><parameter>-N</parameter> zorgt er eerst voor dat eventuele wijzigingen, gemaakt
          sinds het vergrendelen door <parameter>-L</parameter>, worden verwerkt in het hoofdbestand
          van de database. Vervolgens wordt de database weer volledig vrijgegeven voor lezen en
          schrijven, en het tijdelijke bestand wordt gewist.</para>
        </listitem>
        <listitem>
          <para><parameter>-F</parameter> zet alleen maar de statusvlag van de zelf teruggezette
          database weer op <quote>normaal</quote>.</para>
        </listitem>
      </itemizedlist>
      <para>Je gebruikt dus:</para>
      <itemizedlist spacing="compact">
        <listitem>
          <para><parameter>-N</parameter> na het zelf <emphasis>maken</emphasis> van een
          kopie/backup (om de eerder gegeven <parameter>-L</parameter> weer ongedaan te
          maken);</para>
        </listitem>
        <listitem>
          <para><parameter>-F</parameter> na het zelf <emphasis>terugzetten</emphasis> van een
          dergelijke backup.</para>
        </listitem>
      </itemizedlist>
      <note>
        <para>Het is een beetje ongelukkig dat de laatste optie <parameter>-F</parameter> (van
        Fixup) is genoemd. Er wordt immers niets gerepareerd; de database wordt alleen
        <emphasis>ontgrendeld</emphasis>. De optie <parameter>-N</parameter> (uNlock, ontgrendel)
        daarentegen voert niet alleen een ontgrendeling uit, maar maakt ook de database weer in orde
        (<emphasis>fikst</emphasis> de database) door de tussentijdse mutaties te integreren. Maar
        hier zullen we mee moeten leven. Overigens: je <emphasis>zou</emphasis>
        <parameter>-F</parameter> op kunnen vatten als <emphasis>Flag-only</emphasis> (alleen
        vlag).</para>
      </note>
    </section>
    <section id="nbackup-nl-vergr-extra">
      <title>Onder de motorkap</title>
      <para>NB: Deze paragraaf bevat geen noodzakelijke kennis, maar biedt wat extra informatie die
      je inzicht in de verschillende schakelopties kan verdiepen.</para>
      <!--Deze twee orderedlists moeten eigenlijk procedures zijn, maar ik wil compacte spatiëring!-->
      <para><command>nbackup <parameter>-L</parameter></command> doet het volgende:</para>
      <orderedlist spacing="compact">
        <listitem>
          <para>Verbinden met de database;</para>
        </listitem>
        <listitem>
          <para>Transactie starten;</para>
        </listitem>
        <listitem>
          <para>ALTER DATABASE BEGIN BACKUP aanroepen (de werking hiervan is besproken in de <link
          linkend="nbackup-nl-backups-werking">extra informatie bij nbackup -B</link>);</para>
        </listitem>
        <listitem>
          <para>Transactie bekrachtigen met <database>COMMIT</database>;</para>
        </listitem>
        <listitem>
          <para>Verbinding met database verbreken.</para>
        </listitem>
      </orderedlist>
      <para><command>nbackup <parameter>-N</parameter></command> doorloopt dezelfde stappen, maar
      uiteraard met <quote><database>...END BACKUP</database></quote> in stap 3.</para>
      <para><command>nbackup <parameter>-F</parameter></command> werkt als volgt:</para>
      <orderedlist spacing="compact">
        <listitem>
          <para>Het teruggezette databasebestand wordt geopend;</para>
        </listitem>
        <listitem>
          <para>In het bestand wordt de toestandsvlag gewijzigd van vergrendeld
          (<constant>nbak_state_stalled</constant>) naar normaal
          (<constant>nbak_state_normal</constant>);</para>
        </listitem>
        <listitem>
          <para>Het bestand wordt weer gesloten.</para>
        </listitem>
      </orderedlist>
      <note>
        <para>nbackup <parameter>-F</parameter> werkt puur op bestandsniveau en kan dus ook worden
        uitgevoerd zonder dat er een Firebirdserver draait. Eventuele via <parameter>-U</parameter>,
        <parameter>-P</parameter> en/of <parameter>-FE</parameter> aangeleverde inloggegevens worden
        dan ook genegeerd, net als bij nbackup <parameter>-R</parameter>.</para>
      </note>
    </section>
    <section id="nbackup-nl-vergr-kaal-app">
      <title>Databases op kale apparaten vergrendelen</title>
      <para>Zoals al besproken in <link linkend="nbackup-nl-backups-kaal-app"><citetitle>Databases
      op kale apparaten backuppen</citetitle></link> kunnen er problemen ontstaan als een
      deltabestand moet worden gemaakt voor een database op een kaal apparaat. Ook bij het
      vergrendelen geldt daarom vanaf Firebird 2.1 dat nbackup weigert te werken met databases op
      kale apparaten, tenzij vooraf een expliciete locatie voor het deltabestand is ingesteld. Zie
      hiervoor <link linkend="nbackup-nl-deltabestand"><citetitle>Het deltabestand
      instellen</citetitle></link>, even verderop.</para>
      <para>Bij het vergrendelen en zelf kopiëren van een kaal apparaat doet zich ook nog het
      volgende probleem voor: je weet niet hoe groot de database is! Misschien is het kale apparaat
      10 GB, maar neemt de database daarop nog maar 200 MB in. Om te voorkomen dat je voor de
      zekerheid het hele apparaat zou moeten kopiëren, met alle tijd- en ruimteverspilling van dien,
      is in Firebird 2.1 een nieuwe schakeloptie toegevoegd: <parameter>-S</parameter>. Deze optie
      is alleen geldig in combinatie met <parameter>-L</parameter> en zorgt ervoor dat nbackup na
      het vergrendelen de omvang van de database naar de standaarduitvoer schrijft. De omvang wordt
      opgegeven in databasepagina's en moet dus met de paginagrootte van de database worden
      vermenigvuldigd om de te kopiëren hoeveelheid bytes te verkrijgen. Bij gebruik van het
      kopieerprogramma <filename>dd</filename> kun je ook als <parameter>(i)bs</parameter> de
      paginagrootte opgeven en als <parameter>count</parameter> de uitvoer van
      <filename>nbackup</filename> <parameter>-L</parameter> <parameter>-S</parameter>.</para>
    </section>
  </section>
  <section id="nbackup-nl-deltabestand">
    <title>Het deltabestand instellen</title>
    <para>Het deltabestand wordt standaard aangelegd in dezelfde map als de database. De
    bestandsnaam is ook dezelfde, maar dan met <filename class="extension">.delta</filename>
    erachter. Normaal gesproken is dit geen probleem, maar soms is het wenselijk of zelfs
    noodzakelijk om de locatie te veranderen, bijvoorbeeld als de database zich op een kaal apparaat
    bevindt. Het instellen van de locatie kan niet met nbackup zelf, maar moet met een SQL-opdracht
    gebeuren.</para>
    <para>Maak verbinding met de database vanuit een programma waarin je je eigen SQL-opdrachten
    kunt invoeren en geef het commando:</para>
    <blockquote>
      <programlisting>alter database add difference file '<replaceable>pad-en-bestandsnaam</replaceable>'</programlisting>
    </blockquote>
    <para>De aangepaste delta-instelling blijft behouden in de database; ze wordt opgeslagen in de
    systeemtabel <database>RDB$FILES</database>. Met de onderstaande opdracht keer je desgewenst
    terug naar de standaardroutine:</para>
    <blockquote>
      <programlisting>alter database drop difference file</programlisting>
    </blockquote>
    <para>Je kunt ook meteen bij het maken van een nieuwe database een aangepaste locatie voor het
    deltabestand opgeven:</para>
    <blockquote>
      <programlisting>create database '<replaceable>pad-en-dbnaam</replaceable>' difference file '<replaceable>pad-en-deltanaam</replaceable>'</programlisting>
    </blockquote>
    <note>
      <title>Opmerkingen</title>
      <itemizedlist>
        <listitem>
          <para>Als je bij <database>[ADD] DIFFERENCE FILE</database> een kale bestandsnaam zonder
          padinfo opgeeft, zal de delta doorgaans <emphasis>niet</emphasis> aangelegd worden in
          dezelfde map als de database, maar in de huidige directory zoals gezien vanuit de server.
          Onder Windows kan dit bijv. de systeemdirectory zijn. Hetzelfde geldt voor relatieve
          paden.</para>
        </listitem>
        <listitem>
          <para>Het volledige directorypad moet al bestaan. Firebird probeert geen ontbrekende
          mappen aan te leggen.</para>
        </listitem>
        <listitem>
          <para>Als je de ene aangepaste delta-instelling wilt vervangen door de andere, moet je
          eerst de bestaande verwijderen (<database>DROP</database>) en vervolgens de nieuwe
          toevoegen (<database>ADD</database>).</para>
        </listitem>
      </itemizedlist>
    </note>
  </section>
  <appendix id="nbackup-nl-dochist">
    <title>Documenthistorie</title>
    <para>De exacte geschiedenis van dit document is na te gaan in de module <filename
    class="directory">manual</filename> van het Firebird CVS-archief; zie <ulink
    url="http://firebird.cvs.sourceforge.net/viewvc/firebird/manual/src/docs/firebirddocs-nl/nbackup-nl.xml?view=log">http://firebird.cvs.sourceforge.net/viewvc/firebird/manual/src/docs/firebirddocs-nl/nbackup-nl.xml?view=log</ulink></para>
    <para><revhistory>
        <revision>
          <revnumber>0.1</revnumber>
          <date>21 okt 2005</date>
          <authorinitials>PV</authorinitials>
          <revdescription>
            <para>Eerste editie, gelijktijdig uitgebracht in het Nederlands en het Engels.</para>
          </revdescription>
        </revision>
        <revision>
          <revnumber>1.0</revnumber>
          <date>1 dec 2006</date>
          <authorinitials>PV</authorinitials>
          <revdescription>
            <para>Vernieuwde Engelse editie.</para>
          </revdescription>
        </revision>
        <revision>
          <revnumber>1.0-nl</revnumber>
          <date>5 jan 2007</date>
          <authorinitials>PV</authorinitials>
          <revdescription>
            <para>Nederlandse editie weer gelijkgetrokken met de Engelse d.m.v. de volgende
            wijzigingen:</para>
            <para><quote>Bèta</quote>-verwijzing verwijderd uit editie-info. Waarschuwing tegen
            interactief opgeven van backupbestandsnamen bij nbackup -R aangepast.</para>
            <para><literal>C:\Databases</literal> overal in de voorbeelden door
            <literal>C:\Data</literal> vervangen, zodat de regels niet doorlopen tot buiten de
            afwijkend gekleurde <sgmltag class="starttag">screen</sgmltag>-gebieden in de PDF's. Om
            dezelfde reden tweemaal <literal>gebruiker</literal> ingekort tot
            <literal>gebr</literal>.</para>
            <para>Sectie <citetitle>Het deltabestand instellen</citetitle> toegevoegd, en sectie
            <citetitle>Verder lezen?</citetitle> dienovereenkomstig gewijzigd.</para>
            <para>Tevens hier en daar formuleringen en/of spelling aangepast.</para>
          </revdescription>
        </revision>
        <revision>
          <revnumber>1.1-nl</revnumber>
          <date> </date>
          <authorinitials> </authorinitials>
          <revdescription>
            <para>Een Nederlandse editie 1.1 is er nooit geweest. De volgende editie heet 1.2-nl en
            komt overeen met de Engelse editie 1.2.</para>
          </revdescription>
        </revision>
        <revision>
          <revnumber>1.2-nl</revnumber>
          <date>19 sep 2011</date>
          <authorinitials>PV</authorinitials>
          <revdescription>
            <para>Opmaak van de brontekst: maximale regellengte op 100 gezet, zonder
            witregels.</para>
            <para>Alle secties en subsecties hebben nu een <sgmltag>id</sgmltag>.</para>
            <para><citetitle>Inleiding</citetitle>: eerste zin aangepast.</para>
            <para><citetitle>Kenmerken van nbackup — een overzicht</citetitle>: Laatste para voor
            eerste subsectie bewerkt: vermeld dat alleen <database>SYSDBA</database>, eigenaar en
            soms OS-admins een backup kunnen maken.</para>
            <para><citetitle>Kenmerken van nbackup — een overzicht :: Beperkingen van
            nbackup</citetitle>: Voormalig laatste listitem bewerkt: toegang via Services Manager
            vermeld. Listitem toegevoegd inz. rechtstreekse bestandstoegang. Laatste para
            verwijderd.</para>
            <para><citetitle>Functies en parameters</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Backups maken en terugzetten</citetitle>: Laatste zin van eerste alinea
            licht gewijzigd. Waarschuwing toegevoegd inz. risico's met nbackup 2.0.0–2.0.3 onder
            zware belasting, en de invloed van rechtstreekse I/O bij grote databases onder
            Posix.</para>
            <para><citetitle>Backups maken en terugzetten :: Volledige backups :: Een volledige
            backup maken</citetitle>: Listitem over <parameter>-U</parameter> en
            <parameter>-P</parameter> sterk uitgebreid en gecorrigeerd. Listitems toegevoegd over
            <parameter>-FE</parameter>-optie (nieuw in 2.5), <parameter>-T</parameter>-optie (nieuw
            in 2.1) en <parameter>-D</parameter>-optie (nieuw in 2.5, backport naar 2.1.4). In
            listitem dat begint met <quote>De verschillende parameters</quote> staat tussen de
            haakjes nu: (<parameter>-B</parameter>, <parameter>-U</parameter> enz.), omdat er vele
            parameters zijn bijgekomen.</para>
            <para><citetitle>Backups maken en terugzetten :: Volledige backups :: Een volledige
            backup terugzetten</citetitle>: Parameters <parameter>-U</parameter> en
            <parameter>-P</parameter> verwijderd uit specificatie. Listitem toegevoegd over alias.
            Foutieve bewering gecorrigeerd dat nbackup een bestaande database overschrijft als er
            geen actieve verbindingen zijn. Cursieve tekst over falen interactief terugzetten
            gewijzigd en reparatie in 2.0.1 vermeld. Listitem toegevoegd over niet-noodzaak
            draaiende server en negeren inloggegevens.</para>
            <para><citetitle>Backups maken en terugzetten :: Aanvullende backups</citetitle>:
            Waarschuwing ingevoegd dat deze voorziening totaal gebroken is in 2.1, en weer hersteld
            in 2.1.1.</para>
            <para><citetitle>Backups maken en terugzetten :: Aanvullende backups :: Aanvullende
            backups terugzetten</citetitle>: Parameters <parameter>-U</parameter> en
            <parameter>-P</parameter> verwijderd uit formele syntaxis en 1e listitem.</para>
            <para><citetitle>Backups maken en terugzetten :: Databases op kale apparaten
            backuppen</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Backups maken en terugzetten :: Databasetriggers onderdrukken (Firebird
            2.1+)</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Backups maken en terugzetten :: Rechtstreekse I/O (Firebird
            2.1.4+)</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Backups maken en terugzetten :: Informatieve opties (Firebird
            2.5+)</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Backups maken en terugzetten :: Backups op verre machines (Firebird
            2.5+)</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Vergrendelen en ontgrendelen</citetitle>: Laatste zin van tweede alinea
            licht gewijzigd.</para>
            <para><citetitle>Vergrendelen en ontgrendelen :: Database vergrendelen en zelf
            backuppen</citetitle>: Opmerkingen toegevoegd (para + itemizedlist).</para>
            <para><citetitle>Vergrendelen en ontgrendelen :: Terugzetten van een na <quote>nbackup
            -L</quote> gemaakte backup</citetitle>: Info over gebruik alias en
            <parameter>-Z</parameter> toegevoegd aan stap 2 van procedure. Zin aan Noot toegevoegd
            over opvatten <parameter>-F</parameter> als <emphasis>Flag-only</emphasis> (alleen
            vlag).</para>
            <para><citetitle>Vergrendelen en ontgrendelen :: Databases op kale apparaten
            vergrendelen</citetitle>: Nieuwe sectie.</para>
            <para><citetitle>Vergrendelen en ontgrendelen :: Onder de motorkap</citetitle>: Noot
            aangepast.</para>
            <para><citetitle>Het deltabestand instellen</citetitle>: 1e alinea deels herschreven,
            met o.a. verwijzing naar databases op kale apparaten. Laatste zin afgesplitst; is nu
            zelfstandige alinea. Info toegevoegd (para + programlisting) over opgeven delta bij
            <database>CREATE DATABASE</database>. 1e listitem in Opmerkingen:
            <database>ADD</database> -&gt; <database>[ADD]</database>.</para>
            <para><citetitle>Documenthistorie</citetitle>: Ulink naar CVS gewijzigd (zowel tekst als
            url); wijst nu rechtstreeks naar document.</para>
            <para><citetitle>Licentie</citetitle>: Eindjaar auteursrechtvermelding nu 2011.</para>
          </revdescription>
        </revision>
      </revhistory></para>
  </appendix>
  <appendix id="nbackup-nl-licentie">
    <title>Licentie</title>
    <para>De inhoud van deze Documentatie valt onder de <citetitle>Public Documentation License,
    Version 1.0</citetitle> (hierna te noemen de <quote>Licentie</quote>); gebruik van deze
    Documentatie is alleen toegestaan als voldaan wordt aan de voorwaarden van de Licentie.
    Exemplaren van de Licentie zijn verkrijgbaar op <ulink
    url="http://www.firebirdsql.org/pdfmanual/pdl.pdf">http://www.firebirdsql.org/pdfmanual/pdl.pdf</ulink>
    (PDF) en <ulink
    url="http://www.firebirdsql.org/manual/pdl.html">http://www.firebirdsql.org/manual/pdl.html</ulink>
    (HTML).</para>
    <para>De Oorspronkelijke Documentatie is getiteld <citetitle>Firebirds
    nbackup-tool</citetitle>.</para>
    <para>De Oorspronkelijke Schrijver van de Oorspronkelijke Documentatie is: Paul
    Vinkenoog.</para>
    <para>Copyright (C) 2005–2011. Alle rechten voorbehouden. Contactadres Oorspronkelijke
    Schrijver: &lt;voornaam&gt; op &lt;achternaam&gt; punt nl.</para>
  </appendix>
</article>
