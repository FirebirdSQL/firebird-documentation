  <chapter id="rnfbtwo-apiods">
  <chapterinfo>
    <title>Changes to the Firebird API and ODS</title>
  </chapterinfo>

    <section id="apiods-api" xreflabel="API Extensions"><!-- Level 1 section -->
    <title>API (Application Programming Interface)</title>
    <para>Some needed changes have been performed in the Firebird API.  They include.-</para>
    
      <section id="apiods-api-cleanup">
      <sectioninfo>
        <title>Cleanup of ibase.h</title>
        <author><firstname>D. Yemanov,</firstname><surname>A. Peshkov</surname></author>
      </sectioninfo>

      <para>The API header file, ibase.h has been subjected to a cleanup. with the result that public headers no
      longer contain private declarations.</para>
      </section>
      
      <section id="api-lock-timeout"><!-- Level 2 section -->
      <sectioninfo>
        <title>Lock Timeout for WAIT Transactions</title>
        <author><firstname>A.</firstname><surname>Karyakin, D. Yemanov</surname></author>
      </sectioninfo>
      <para>The new feature extends the WAIT mode by making provision to set a finite time interval to wait for the
      concurrent transactions. If the timeout has passed, an error (isc_lock_timeout) is reported.</para>

      <para>Timeout intervals can now be specified per transaction, using the new TPB constant
      <firstterm>isc_tpb_lock_timeout</firstterm> in the API.</para>
      <note>
        <para>The DSQL equivalent is implemented via the <firstterm>LOCK TIMEOUT &lt;value&gt;</firstterm> clause
        of the SET TRANSACTION statement.</para>
      </note>
      </section>

      <section id="apiods-api-info"><!-- Level 2 section -->
      <sectioninfo>
        <title>isc_dsql_info() Now Includes Relation Aliases</title>
        <author><firstname>D.</firstname><surname>Yemanov</surname></author>
      </sectioninfo>
      <para>The function call isc_dsql_sql_info() has been extended to enable relation aliases to be retrieved, if
      required.</para>
      </section>
      
      <section id="apiods-api-blobinfo"><!-- Level 2 section -->
      <sectioninfo>
        <title>Enhancement to isc_blob_lookup_desc()</title>
        <author><firstname>A.</firstname><surname>dos Santos Fernandes</surname></author>
      </sectioninfo>
      <para>isc_blob_lookup_desc() now also describes blobs that are outputs of stored procedures</para>
      </section>

      <section id="apiods-api-cli-vers"><!-- Level 2 section -->
      <sectioninfo>
        <title>API Identifies Client Version</title>
        <author><firstname>N.</firstname><surname>Samofatov</surname></author>
      </sectioninfo>
      <para>The macro definition <literal>FB_API_VER</literal> is added to ibase.h to indicate the current API 
      version. The number corresponds to the appropriate Firebird version.</para>
      <para>The current value of FB_API_VER is 20 (two-digit equivalent of 2.0). This macro can be used by 
      client applications to check the version of ibase.h its being compiled with.</para>
      </section>

      <section id="apiods-api-dbinfo"><!-- Level 2 section -->
      <sectioninfo>
        <title>Additions to the isc_database_info() Structure</title>
        <author><firstname>V.</firstname><surname>Horsun</surname></author>
      </sectioninfo>
        <para>The following items have been added to the isc_database_info() function call structure:</para>

        <section id="apiods-api-dbinfo-trcount"><!-- Level 3 section -->
          <title>isc_info_active_tran_count</title>
          <para>Returns the number of currently active transactions.</para>
        </section>
        <section id="apiods-api-dbinfo-crdate"><!-- Level 3 section -->
          <title>isc_info_creation_date</title>
          <para>Returns the date and time when the database was [re]created.</para>
          <para>To decode the returned value, call &nbsp;<literal>isc_vax_integer</literal>&nbsp; twice to 
          extract (first) the date and (second) the time portions of the ISC_TIMESTAMP. Then, use 
          &nbsp;<literal>isc_decode_timestamp()</literal>&nbsp; as usual.</para>
        </section>

      </section>

      <section id="apiods-api-trinfo"><!-- Level 2 section -->
      <sectioninfo>
        <title>Additions to the isc_transaction_info() Structure</title>
        <author><firstname>V.</firstname><surname>Horsun</surname></author>
      </sectioninfo>
        <para>The following items have been added to the isc_transaction_info() function call structure:</para>

        <section id="apiods-api-trinfo-oit"><!-- Level 3 section -->
          <title>isc_info_tra_oldest_interesting</title>
          <para>Returns the number of the oldest [interesting] transaction when the current transaction started.
          For snapshot transactions, this is also the number of the oldest transaction in the private copy of the
          transaction inventory page (TIP).</para>
        </section>
        <section id="apiods-api-trinfo-oat"><!-- Level 3 section -->
          <title>isc_info_tra_oldest_active</title>
          <itemizedlist>
            <listitem>
              <para>For a read-committed transaction, returns the number of the current transaction.</para>
            </listitem>
            <listitem>
              <para>For all other transactions, returns the number of the oldest active transaction when the current
              transaction started.</para>
            </listitem>
          </itemizedlist>
        </section>
        <section id="apiods-api-trinfo-osnap"><!-- Level 3 section -->
          <title>isc_info_tra_oldest_snapshot</title>
          <para>Returns the number of the lowest &nbsp;<literal>tra_oldest_active</literal>&nbsp; of all
          transactions that were active when the current transaction started.</para>
          <note>
            <para>This value is used as the threshold (&quot;high-water mark&quot;) for garbage collection.</para>
          </note>
        </section>
        <section id="apiods-api-trinfo-isol"><!-- Level 3 section -->
          <title>isc_info_tra_isolation</title>
          <para>Returns the isolation level of the current transaction.  The format of the returned clumplets
          is:</para>
          <programlisting>
isc_info_tra_isolation,
  1, isc_info_tra_consistency | isc_info_tra_concurrency |
  2, isc_info_tra_read_committed,
     isc_info_tra_no_rec_version | isc_info_tra_rec_version
          </programlisting>
          <para>That is, for Read Committed transactions, two items are returned (isolation level and record
          versioning policy) while, for other transactions, one item is returned (isolation level).</para>
        </section>
        <section id="apiods-api-trinfo-access"><!-- Level 3 section -->
          <title>isc_info_tra_access</title>
          <para>Returns the access mode (read-only or read-write) of the current transaction.  The format of the
          returned clumplets is:</para>
        <programlisting>
isc_info_tra_access, 1, isc_info_tra_readonly | isc_info_tra_readwrite
        </programlisting>
        </section>
        <section id="apiods-api-trinfo-timeout"><!-- Level 3 section -->
          <title>isc_info_tra_lock_timeout</title>
          <para>Returns the lock timeout set for the current transaction.</para>
        </section>

      </section>

      <section id="apiods-api-srvcs"><!-- Level 2 section -->
        <title>Improved Services API</title>
        <para>The following improvements have been added to the Services API:</para>

        <section id="apiods-api-srvcs-opt">
        <sectioninfo>
          <title>Task Execution Optimized</title>
          <author><firstname>D.</firstname><surname>Yemanov</surname></author>
        </sectioninfo>
        <para>Services are now executed as threads rather than processes on some threadable CS builds (currently 32-
        bit Windows and Solaris).</para>
        </section>
        
      <section id="apiods-api-interprete"><!-- Level 2 section -->
      <sectioninfo>
        <title>New Function for Delivering Error Text</title>
        <author><firstname>C.</firstname><surname>Valderrama</surname></author>
      </sectioninfo>
      <para>The new function <literal>&nbsp;fb_interpret()&nbsp;</literal> replaces the former
      isc_interprete() for extracting the text for a Firebird error message from the error status vector to a
      client buffer.</para>
      <important>
        <para>isc_interprete() is vulnerable to overruns and is deprecated as unsafe.  The new function should be
        used instead.</para>
      </important>
      </section>
    </section>

    <section id="apiods-ods" xreflabel="ODS Changes"><!-- Level 1 section -->
    <title>ODS (On-Disk Structure) Changes</title>
    <para>On-disk structure (ODS) changes include the following:</para>
      <section id="apiods-ods-number"><!-- Level 2 section -->
      <title>New ODS Number</title>
      <para>Firebird 2.0 creates databases with an ODS (On-Disk Structure) version of 11.</para>
      </section>

      <section id="apiods-ods-except-msgs"><!-- Level 2 section -->
      <sectioninfo>
        <title>Size limit for exception messages increased</title>
        <author><firstname>V.</firstname><surname>Horsun</surname></author>
      </sectioninfo>
      <para>Maximum size of exception messages raised from 78 to 1021 bytes.</para>
      </section>
      <section id="apiods-ods-generator-description"><!-- Level 2 section -->
      <sectioninfo>
        <title>New Description Field for Generators</title>
        <author><firstname>C.</firstname><surname>Valderrama</surname></author>
      </sectioninfo>
      <para>Added RDB$DESCRIPTION to RDB$GENERATORS, so now you can include description text when creating
      generators.</para>
       </section>

      <section id="apiods-ods-role-description"><!-- Level 2 section -->
      <sectioninfo>
        <title>New Description Field for SQL Roles</title>
        <author><firstname>C.</firstname><surname>Valderrama</surname></author>
      </sectioninfo>
      <para>Added RDB$DESCRIPTION and RDB$SYSTEM_FLAG to RDB$ROLES to allow description text and to flag
      user-defined roles, respectively.</para>
      </section>

      <section id="apiods-ods-type"><!-- Level 2 section -->
      <sectioninfo>
        <title><quote>ODS Type</quote> Recognition</title>
        <author><firstname>N.</firstname><surname>Samofatov</surname></author>
      </sectioninfo>
      <para>Introduced a concept of ODS type to distinguish between InterBase and Firebird databases.</para>
      </section>

      <section id="apiods-ods-dsqlerror"><!-- Level 2 section -->
      <sectioninfo>
        <title>Smarter DSQL Error Reporting</title>
        <author><firstname>C.</firstname><surname>Valderrama</surname></author>
      </sectioninfo>
      <para>The DSQL parser will now try to report the line and column number of an incomplete statement.</para>
      </section>

      <section id="apiods-ods-rdbstatistics"><!-- Level 2 section -->
      <sectioninfo>
      <title>New Column in RDB$Index_Segments</title>
        <author><firstname>D.</firstname><surname>Yemanov, A. Brinkman</surname></author>
      </sectioninfo>
      <para>A new column RDB$STATISTICS has been added to the system table RDB$INDEX_SEGMENTS to store the
      per-segment selectivity values for multi-key indexes.</para>
      <note>
        <para>The column of the same name in RDB$INDICES is kept for compatibility and still represents the total
        index selectivity, that is used for a full index match.</para>
      </note>
      </section>
    </section>
  </section>
  </chapter>

